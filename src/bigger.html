<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameHub - Favorite Games</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        /* [Previous CSS styles remain exactly the same] */
        :root {
            --primary: #4fc3f7;
            --danger: #ff4757;
            --success: #2ecc71;
            --dark: #2d3436;
            --light: #f5f6fa;
            --gray: #a4b0be;
            --card-bg: #2d3436;
            --border: #3a4042;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e272e;
            color: var(--light);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* [Rest of your CSS remains unchanged] */
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains exactly the same] -->
    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <!-- ... -->
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="confirmation-modal">
        <!-- ... -->
    </div>

    <!-- Authenticated Content -->
    <div class="auth-content">
        <!-- ... -->
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
            authDomain: "fusioncya-cc20a.firebaseapp.com",
            databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
            projectId: "fusioncya-cc20a",
            storageBucket: "fusioncya-cc20a.appspot.com",
            messagingSenderId: "765164293111",
            appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
            measurementId: "G-4DT52P7MPB"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        const db = firebase.firestore();

        // DOM Elements
        const loginModal = document.getElementById('login-modal');
        const goToLogin = document.getElementById('go-to-login');
        const goToHome = document.getElementById('go-to-home');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmClear = document.getElementById('confirm-clear');
        const cancelClear = document.getElementById('cancel-clear');
        const authContent = document.querySelector('.auth-content');
        const usernameDisplay = document.getElementById('username-display');
        const profilePic = document.getElementById('profile-pic');
        const favoritesContainer = document.getElementById('favoritesContainer');
        const noFavoritesMessage = document.querySelector('.empty-state');
        const noResultsMessage = document.querySelector('.no-results');
        const clearAllBtn = document.getElementById('clearAllFavorites');
        const favoritesSearch = document.getElementById('favoritesSearch');
        const categoryFilter = document.getElementById('categoryFilter');

        // Game Data
        let allGames = {};
        let currentFavorites = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // First load the games data, then set up auth
            loadGamesData()
                .then(() => {
                    // Set up auth state listener after games are loaded
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            // User is signed in
                            loginModal.classList.remove('active');
                            updateUIForUser(user);
                            loadFavorites(user.uid);
                        } else {
                            // User is signed out
                            loginModal.classList.add('active');
                            usernameDisplay.textContent = 'Guest';
                            profilePic.src = 'https://via.placeholder.com/40';
                        }
                    });

                    // Set up event listeners
                    setupEventListeners();
                })
                .catch(error => {
                    console.error('Failed to load games data:', error);
                    // Show error to user
                    noFavoritesMessage.innerHTML = `
                        <i class='bx bx-error'></i>
                        <h3>Failed to load games</h3>
                        <p>Please refresh the page or try again later</p>
                    `;
                });
        });

        // Load games data from favoritez.js
        function loadGamesData() {
            return new Promise((resolve, reject) => {
                // Check if gamesData is already available
                if (window.gamesData) {
                    console.log('Found gamesData in window');
                    processGamesData(window.gamesData);
                    resolve();
                    return;
                }

                console.log('Attempting to load favoritez.js');
                
                // Create script element to load favoritez.js
                const script = document.createElement('script');
                script.src = 'favoritez.js';
                script.onload = () => {
                    console.log('favoritez.js loaded');
                    if (window.gamesData) {
                        processGamesData(window.gamesData);
                        resolve();
                    } else {
                        reject(new Error('gamesData not found after loading favoritez.js'));
                    }
                };
                script.onerror = () => {
                    reject(new Error('Failed to load favoritez.js'));
                };
                
                document.head.appendChild(script);
            });
        }

        // Process games data from favoritez.js
        function processGamesData(gamesData) {
            console.log('Processing games data:', gamesData);
            allGames = {};
            
            // Check if gamesData is in the expected format
            if (!Array.isArray(gamesData)) {
                console.error('gamesData is not an array:', gamesData);
                return;
            }

            // Flatten the games data structure
            gamesData.forEach(category => {
                if (category && category.games && Array.isArray(category.games)) {
                    category.games.forEach(game => {
                        if (game && game.id) {
                            allGames[game.id] = game;
                        }
                    });
                }
            });
            
            console.log('Processed games:', allGames);
        }

        function setupEventListeners() {
            goToLogin.addEventListener('click', signInWithGoogle);
            goToHome.addEventListener('click', () => window.location.href = 'index.html');
            clearAllBtn.addEventListener('click', showConfirmationModal);
            confirmClear.addEventListener('click', clearAllFavorites);
            cancelClear.addEventListener('click', hideConfirmationModal);
            
            // Search and filter listeners
            favoritesSearch.addEventListener('input', filterFavorites);
            categoryFilter.addEventListener('change', filterFavorites);
        }

        // [Rest of your functions remain the same, including:
        // showConfirmationModal, hideConfirmationModal, signInWithGoogle,
        // updateUIForUser, createUserDocument, loadFavorites, 
        // showNoFavoritesMessage, renderFavorites, createFavoriteGameCard,
        // createBannerElement, getBannerIcon, removeFavorite, 
        // clearAllFavorites, filterFavorites]
        // These should be copied exactly as they were in your working version

        // Show confirmation modal
        function showConfirmationModal() {
            confirmationModal.classList.add('active');
        }

        // Hide confirmation modal
        function hideConfirmationModal() {
            confirmationModal.classList.remove('active');
        }

        // Sign in with Google
        function signInWithGoogle() {
            auth.signInWithPopup(provider)
                .then(result => {
                    if (result.additionalUserInfo.isNewUser) {
                        return createUserDocument(result.user);
                    }
                })
                .catch(error => {
                    console.error('Sign in error:', error);
                    alert('Sign in failed: ' + error.message);
                });
        }

        // Update UI for authenticated user
        function updateUIForUser(user) {
            usernameDisplay.textContent = user.displayName || 'User';
            if (user.photoURL) {
                profilePic.src = user.photoURL;
            }
        }

        // Create user document in Firestore
        function createUserDocument(user) {
            return db.collection('users').doc(user.uid).set({
                uid: user.uid,
                email: user.email,
                username: user.displayName || 'user' + user.uid.substring(0, 4),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Load user's favorites
        function loadFavorites(userId) {
            db.collection('users').doc(userId).collection('favorites').get()
                .then(querySnapshot => {
                    currentFavorites = [];
                    
                    if (querySnapshot.empty) {
                        showNoFavoritesMessage();
                        return;
                    }

                    querySnapshot.forEach(doc => {
                        const gameId = parseInt(doc.id);
                        if (!isNaN(gameId)) {
                            currentFavorites.push(gameId);
                        }
                    });

                    renderFavorites();
                })
                .catch(error => {
                    console.error('Error loading favorites:', error);
                    showNoFavoritesMessage();
                });
        }

        // Show no favorites message
        function showNoFavoritesMessage() {
            noFavoritesMessage.style.display = 'block';
            noResultsMessage.style.display = 'none';
            // Clear any existing game cards
            const gameCards = favoritesContainer.querySelectorAll('.favorite-game-card');
            gameCards.forEach(card => card.remove());
        }

        // Render favorites
        function renderFavorites() {
            // Clear existing content but keep the empty state and no results messages
            const existingCards = Array.from(favoritesContainer.querySelectorAll('.favorite-game-card'));
            existingCards.forEach(card => card.remove());

            if (currentFavorites.length === 0) {
                showNoFavoritesMessage();
                return;
            }

            // Create a document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            currentFavorites.forEach(gameId => {
                const game = allGames[gameId];
                if (game) {
                    const gameCard = createFavoriteGameCard(game);
                    fragment.appendChild(gameCard);
                } else {
                    console.warn('Game not found:', gameId);
                }
            });

            noFavoritesMessage.style.display = 'none';
            noResultsMessage.style.display = 'none';
            favoritesContainer.insertBefore(fragment, noFavoritesMessage);

            // Apply initial filter
            filterFavorites();
        }

        // Create a favorite game card
        function createFavoriteGameCard(game) {
            const card = document.createElement('div');
            card.className = 'favorite-game-card';
            card.dataset.id = game.id;
            card.dataset.category = game.category;
            card.dataset.title = game.title.toLowerCase();
            
            card.innerHTML = `
                <a href="${game.url}" class="game-link">
                    <div class="thumbnail-container">
                        ${game.banner ? createBannerElement(game.banner) : ''}
                        <div class="game-category-badge category-${game.category}">${game.category}</div>
                        <img src="${game.staticImg}" class="game-thumbnail" alt="${game.title}">
                        <div class="game-overlay">
                            <button class="remove-favorite-btn">
                                <i class='bx bx-trash'></i> Remove
                            </button>
                        </div>
                    </div>
                    <div class="game-info">
                        <div class="game-title">${game.title}</div>
                    </div>
                </a>
            `;
            
            // Add click handler for remove button
            card.querySelector('.remove-favorite-btn').addEventListener('click', function(e) {
                e.preventDefault();
                removeFavorite(auth.currentUser.uid, game.id, card);
            });
            
            return card;
        }

        // Create banner element
        function createBannerElement(bannerType) {
            return `
                <div class="ribbon ${bannerType} ${bannerType === 'hot' ? 'pulse' : ''}">
                    <i class='${getBannerIcon(bannerType)}'></i>
                    ${bannerType.toUpperCase()}
                </div>
            `;
        }

        // Helper function to get banner icon
        function getBannerIcon(type) {
            const icons = {
                hot: 'bx bx-hot',
                new: 'bx bx-star',
                popular: 'bx bx-trending-up'
            };
            return icons[type] || 'bx bx-info-circle';
        }

        // Remove a favorite game
        function removeFavorite(userId, gameId, element) {
            db.collection('users').doc(userId).collection('favorites').doc(String(gameId)).delete()
                .then(() => {
                    // Remove from currentFavorites array
                    currentFavorites = currentFavorites.filter(id => id !== gameId);
                    element.remove();
                    
                    // Check if there are any remaining favorites
                    if (currentFavorites.length === 0) {
                        showNoFavoritesMessage();
                    } else {
                        // Re-apply filters after removal
                        filterFavorites();
                    }
                })
                .catch(error => {
                    console.error('Error removing favorite:', error);
                    alert('Failed to remove favorite. Please try again.');
                });
        }

        // Clear all favorites
        function clearAllFavorites() {
            if (!auth.currentUser) return;
            
            const userId = auth.currentUser.uid;
            const batch = db.batch();
            
            db.collection('users').doc(userId).collection('favorites').get()
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    // Clear the current favorites
                    currentFavorites = [];
                    
                    // Clear the UI
                    const gameCards = favoritesContainer.querySelectorAll('.favorite-game-card');
                    gameCards.forEach(card => card.remove());
                    
                    showNoFavoritesMessage();
                    hideConfirmationModal();
                })
                .catch(error => {
                    console.error('Error clearing favorites:', error);
                    alert('Failed to clear favorites. Please try again.');
                    hideConfirmationModal();
                });
        }

        // Filter favorites based on search and category
        function filterFavorites() {
            const searchTerm = favoritesSearch.value.toLowerCase();
            const category = categoryFilter.value;
            
            const gameCards = favoritesContainer.querySelectorAll('.favorite-game-card');
            let hasVisibleCards = false;
            
            gameCards.forEach(card => {
                const cardCategory = card.dataset.category;
                const cardTitle = card.dataset.title;
                
                const matchesSearch = searchTerm === '' || cardTitle.includes(searchTerm);
                const matchesCategory = category === 'all' || cardCategory === category;
                
                if (matchesSearch && matchesCategory) {
                    card.style.display = 'block';
                    hasVisibleCards = true;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show appropriate messages
            if (gameCards.length === 0) {
                noFavoritesMessage.style.display = 'block';
                noResultsMessage.style.display = 'none';
            } else {
                noFavoritesMessage.style.display = 'none';
                noResultsMessage.style.display = hasVisibleCards ? 'none' : 'block';
            }
        }
    </script>
</body>
</html>
