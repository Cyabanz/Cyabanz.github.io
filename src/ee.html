<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameHub - Favorite Games</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --primary: #4fc3f7;
            --primary-dark: #3ab7e6;
            --danger: #ff4757;
            --danger-dark: #ff6b81;
            --success: #2ecc71;
            --success-dark: #27ae60;
            --warning: #f39c12;
            --warning-dark: #e67e22;
            --dark: #2d3436;
            --dark-light: #3a4042;
            --light: #f5f6fa;
            --gray: #a4b0be;
            --card-bg: #2d3436;
            --border: #3a4042;
        }

        /* Base styles remain the same as before... */

        /* New styles for additional features */
        .sort-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .sort-btn {
            background: var(--dark-light);
            border: none;
            color: var(--gray);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .sort-btn.active {
            background: var(--primary);
            color: white;
        }

        .sort-btn:hover {
            background: var(--primary-dark);
            color: white;
        }

        .stats-container {
            background: var(--dark-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .category-filter-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .category-chip {
            background: var(--dark-light);
            color: var(--light);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-chip.active {
            background: var(--primary);
        }

        .category-chip:hover {
            background: var(--primary-dark);
        }

        .game-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        .game-playtime {
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .game-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .action-btn:hover {
            color: var(--primary);
        }

        .empty-state .btn {
            margin-top: 15px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .search-filter-container {
                flex-direction: column;
            }
            
            .favorites-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .game-thumbnail {
                height: 100px;
            }

            .stats-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .stat-item {
                align-items: flex-start;
            }
        }

        /* Animation for newly added favorites */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .new-favorite {
            animation: fadeIn 0.5s ease-out;
        }

        /* Loading spinner */
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading .loading-spinner {
            display: block;
        }

        .loading .favorites-grid > *:not(.loading-spinner) {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <h3><i class='bx bx-lock-alt'></i> Sign In Required</h3>
            <p>Please sign in to view and manage your favorite games</p>
            <div class="modal-actions">
                <button id="go-to-login" class="btn">
                    <i class='bx bxl-google'></i> Sign In
                </button>
                <button id="go-to-home" class="btn">
                    <i class='bx bx-home'></i> Go Home
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="confirmation-modal">
        <div class="confirmation-content">
            <h3><i class='bx bx-trash'></i> Clear All Favorites</h3>
            <p>Are you sure you want to remove all your favorite games? This action cannot be undone.</p>
            <div class="confirmation-actions">
                <button id="confirm-clear" class="btn btn-danger">
                    <i class='bx bx-trash'></i> Clear All
                </button>
                <button id="cancel-clear" class="btn">
                    <i class='bx bx-x'></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Authenticated Content -->
    <div class="auth-content">
        <!-- Profile Header -->
        <header>
            <div class="user-info">
                <span id="username-display">User</span>
                <div id="profile-pic-container">
                    <img id="profile-pic" src="https://via.placeholder.com/40" alt="Profile" class="profile-pic">
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Favorite Games Section -->
            <div class="favorites-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class='bx bxs-bookmark-alt'></i> My Favorite Games
                    </h2>
                    <button class="clear-btn" id="clearAllFavorites">
                        <i class='bx bx-trash'></i> Clear All
                    </button>
                </div>
                
                <!-- Stats Container -->
                <div class="stats-container" id="statsContainer">
                    <div class="stat-item">
                        <span class="stat-value" id="totalFavorites">0</span>
                        <span class="stat-label">Total Favorites</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="actionGames">0</span>
                        <span class="stat-label">Action Games</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="puzzleGames">0</span>
                        <span class="stat-label">Puzzle Games</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="sportsGames">0</span>
                        <span class="stat-label">Sports Games</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="ioGames">0</span>
                        <span class="stat-label">IO Games</span>
                    </div>
                </div>
                
                <!-- Search and Filter Controls -->
                <div class="search-filter-container">
                    <input type="text" id="favoritesSearch" placeholder="Search favorites...">
                    <select id="categoryFilter">
                        <option value="all">All Categories</option>
                        <option value="action">Action</option>
                        <option value="puzzle">Puzzle</option>
                        <option value="sports">Sports</option>
                        <option value="io">IO Games</option>
                    </select>
                </div>

                <!-- Category Chips -->
                <div class="category-filter-chips" id="categoryChips">
                    <!-- Dynamically generated -->
                </div>

                <!-- Sort Controls -->
                <div class="sort-controls">
                    <span>Sort by:</span>
                    <button class="sort-btn" data-sort="recent">
                        <i class='bx bx-time'></i> Recently Added
                    </button>
                    <button class="sort-btn" data-sort="title">
                        <i class='bx bx-sort-a-z'></i> Title
                    </button>
                    <button class="sort-btn" data-sort="category">
                        <i class='bx bx-category'></i> Category
                    </button>
                </div>
                
                <!-- Favorites Container -->
                <div class="favorites-grid" id="favoritesContainer">
                    <!-- Loading spinner -->
                    <div class="loading-spinner"></div>
                    
                    <!-- No favorites message -->
                    <div class="empty-state">
                        <i class='bx bx-bookmark-alt'></i>
                        <h3>No favorite games yet</h3>
                        <p>Save your favorite games to see them here</p>
                        <a href="games.html" class="btn">
                            <i class='bx bx-joystick'></i> Browse Games
                        </a>
                    </div>
                    
                    <!-- No results message (hidden by default) -->
                    <div class="no-results">
                        <i class='bx bx-search-alt'></i>
                        <h3>No matching favorites found</h3>
                        <p>Try changing your search or filter</p>
                        <button id="resetFilters" class="btn">
                            <i class='bx bx-reset'></i> Reset Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Back to All Games Button -->
            <div class="back-btn">
                <a href="games.html" class="btn">
                    <i class='bx bx-arrow-back'></i> Back to All Games
                </a>
            </div>
        </div>
    </div>

    <!-- Include the games data script first -->
    <script src="favoritez.js"></script>
    
    <!-- Then include Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // DOM Elements
        const loginModal = document.getElementById('login-modal');
        const goToLogin = document.getElementById('go-to-login');
        const goToHome = document.getElementById('go-to-home');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmClear = document.getElementById('confirm-clear');
        const cancelClear = document.getElementById('cancel-clear');
        const authContent = document.querySelector('.auth-content');
        const usernameDisplay = document.getElementById('username-display');
        const profilePic = document.getElementById('profile-pic');
        const favoritesContainer = document.getElementById('favoritesContainer');
        const noFavoritesMessage = document.querySelector('.empty-state');
        const noResultsMessage = document.querySelector('.no-results');
        const clearAllBtn = document.getElementById('clearAllFavorites');
        const favoritesSearch = document.getElementById('favoritesSearch');
        const categoryFilter = document.getElementById('categoryFilter');
        const categoryChips = document.getElementById('categoryChips');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const sortButtons = document.querySelectorAll('.sort-btn');
        const statsContainer = document.getElementById('statsContainer');
        const totalFavoritesEl = document.getElementById('totalFavorites');
        const actionGamesEl = document.getElementById('actionGames');
        const puzzleGamesEl = document.getElementById('puzzleGames');
        const sportsGamesEl = document.getElementById('sportsGames');
        const ioGamesEl = document.getElementById('ioGames');

        // Game Data - Will be populated from favoritez.js
        let allGames = {};
        let currentFavorites = [];
        let favoriteTimestamps = {}; // Track when favorites were added
        let currentSort = 'recent'; // Default sort
        let currentCategoryFilter = 'all';

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Process the games data from favoritez.js
            processGamesData(window.gamesData);
            
            // Initialize Firebase
            initializeFirebase();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize category chips
            initCategoryChips();
        });

        function processGamesData(gamesData) {
            allGames = {};
            // Flatten the games data structure
            gamesData.forEach(category => {
                if (category.games && Array.isArray(category.games)) {
                    category.games.forEach(game => {
                        allGames[game.id] = game;
                    });
                }
            });
            console.log('Processed games data:', allGames);
        }

        function initializeFirebase() {
            // Firebase Configuration
            const firebaseConfig = {
                apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
                authDomain: "fusioncya-cc20a.firebaseapp.com",
                databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
                projectId: "fusioncya-cc20a",
                storageBucket: "fusioncya-cc20a.appspot.com",
                messagingSenderId: "765164293111",
                appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
                measurementId: "G-4DT52P7MPB"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            
            // Set up auth state listener
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    loginModal.classList.remove('active');
                    updateUIForUser(user);
                    loadFavorites(user.uid);
                } else {
                    // User is signed out
                    loginModal.classList.add('active');
                    usernameDisplay.textContent = 'Guest';
                    profilePic.src = 'https://via.placeholder.com/40';
                }
            });
        }

        function setupEventListeners() {
            // Set up event listeners
            goToLogin.addEventListener('click', signInWithGoogle);
            goToHome.addEventListener('click', () => window.location.href = 'index.html');
            clearAllBtn.addEventListener('click', showConfirmationModal);
            confirmClear.addEventListener('click', clearAllFavorites);
            cancelClear.addEventListener('click', hideConfirmationModal);
            
            // Search and filter listeners
            favoritesSearch.addEventListener('input', filterFavorites);
            categoryFilter.addEventListener('change', filterFavorites);
            
            // Reset filters button
            if (resetFiltersBtn) {
                resetFiltersBtn.addEventListener('click', resetFilters);
            }
            
            // Sort buttons
            sortButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const sortType = btn.dataset.sort;
                    setActiveSort(sortType);
                    renderFavorites();
                });
            });
        }

        function initCategoryChips() {
            const categories = [
                { value: 'all', label: 'All', icon: 'bx-category' },
                { value: 'action', label: 'Action', icon: 'bx-run' },
                { value: 'puzzle', label: 'Puzzle', icon: 'bx-brain' },
                { value: 'sports', label: 'Sports', icon: 'bx-football' },
                { value: 'io', label: 'IO Games', icon: 'bx-globe' }
            ];
            
            categoryChips.innerHTML = categories.map(cat => `
                <div class="category-chip ${cat.value === 'all' ? 'active' : ''}" 
                     data-category="${cat.value}">
                    <i class='bx ${cat.icon}'></i> ${cat.label}
                </div>
            `).join('');
            
            // Add click handlers for chips
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentCategoryFilter = chip.dataset.category;
                    categoryFilter.value = currentCategoryFilter;
                    filterFavorites();
                });
            });
        }

        function setActiveSort(sortType) {
            currentSort = sortType;
            sortButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.sort-btn[data-sort="${sortType}"]`).classList.add('active');
        }

        function sortFavorites() {
            if (currentSort === 'recent') {
                currentFavorites.sort((a, b) => {
                    const timeA = favoriteTimestamps[a] || 0;
                    const timeB = favoriteTimestamps[b] || 0;
                    return timeB - timeA; // Newest first
                });
            } else if (currentSort === 'title') {
                currentFavorites.sort((a, b) => {
                    const gameA = allGames[a];
                    const gameB = allGames[b];
                    if (!gameA || !gameB) return 0;
                    return gameA.title.localeCompare(gameB.title);
                });
            } else if (currentSort === 'category') {
                currentFavorites.sort((a, b) => {
                    const gameA = allGames[a];
                    const gameB = allGames[b];
                    if (!gameA || !gameB) return 0;
                    return gameA.category.localeCompare(gameB.category) || 
                           gameA.title.localeCompare(gameB.title);
                });
            }
        }

        function resetFilters() {
            favoritesSearch.value = '';
            currentCategoryFilter = 'all';
            categoryFilter.value = 'all';
            document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
            document.querySelector('.category-chip[data-category="all"]').classList.add('active');
            filterFavorites();
        }

        function updateStats() {
            const stats = {
                total: currentFavorites.length,
                action: 0,
                puzzle: 0,
                sports: 0,
                io: 0
            };
            
            currentFavorites.forEach(gameId => {
                const game = allGames[gameId];
                if (game) {
                    stats[game.category]++;
                }
            });
            
            totalFavoritesEl.textContent = stats.total;
            actionGamesEl.textContent = stats.action;
            puzzleGamesEl.textContent = stats.puzzle;
            sportsGamesEl.textContent = stats.sports;
            ioGamesEl.textContent = stats.io;
        }

        // Show confirmation modal
        function showConfirmationModal() {
            confirmationModal.classList.add('active');
        }

        // Hide confirmation modal
        function hideConfirmationModal() {
            confirmationModal.classList.remove('active');
        }

        // Sign in with Google
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider)
                .then(result => {
                    if (result.additionalUserInfo.isNewUser) {
                        return createUserDocument(result.user);
                    }
                })
                .catch(error => {
                    console.error('Sign in error:', error);
                    alert('Sign in failed: ' + error.message);
                });
        }

        // Update UI for authenticated user
        function updateUIForUser(user) {
            usernameDisplay.textContent = user.displayName || 'User';
            if (user.photoURL) {
                profilePic.src = user.photoURL;
            }
        }

        // Create user document in Firestore
        function createUserDocument(user) {
            return firebase.firestore().collection('users').doc(user.uid).set({
                uid: user.uid,
                email: user.email,
                username: user.displayName || 'user' + user.uid.substring(0, 4),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Load user's favorites
        function loadFavorites(userId) {
            // Show loading state
            favoritesContainer.classList.add('loading');
            
            firebase.firestore().collection('users').doc(userId).collection('favorites')
                .orderBy('timestamp', 'desc')
                .get()
                .then(querySnapshot => {
                    currentFavorites = [];
                    favoriteTimestamps = {};
                    
                    if (querySnapshot.empty) {
                        showNoFavoritesMessage();
                        return;
                    }

                    querySnapshot.forEach(doc => {
                        const gameId = doc.data().gameId;
                        if (gameId) {
                            currentFavorites.push(gameId);
                            favoriteTimestamps[gameId] = doc.data().timestamp?.toMillis() || Date.now();
                        }
                    });

                    updateStats();
                    renderFavorites();
                })
                .catch(error => {
                    console.error('Error loading favorites:', error);
                    showNoFavoritesMessage();
                })
                .finally(() => {
                    favoritesContainer.classList.remove('loading');
                });
        }

        // Show no favorites message
        function showNoFavoritesMessage() {
            noFavoritesMessage.style.display = 'block';
            noResultsMessage.style.display = 'none';
            // Clear any existing game cards
            const gameCards = favoritesContainer.querySelectorAll('.favorite-game-card');
            gameCards.forEach(card => card.remove());
            updateStats();
        }

        // Render favorites
        function renderFavorites() {
            // Clear existing content but keep the empty state and no results messages
            const existingCards = Array.from(favoritesContainer.querySelectorAll('.favorite-game-card'));
            existingCards.forEach(card => card.remove());

            if (currentFavorites.length === 0) {
                showNoFavoritesMessage();
                return;
            }

            // Sort favorites according to current sort method
            sortFavorites();

            // Create a document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            currentFavorites.forEach(gameId => {
                const game = allGames[gameId];
                if (game) {
                    const gameCard = createFavoriteGameCard(game);
                    fragment.appendChild(gameCard);
                } else {
                    console.warn('Game not found:', gameId);
                }
            });

            noFavoritesMessage.style.display = 'none';
            noResultsMessage.style.display = 'none';
            favoritesContainer.insertBefore(fragment, noFavoritesMessage);

            // Apply initial filter
            filterFavorites();
        }

        // Create a favorite game card
        function createFavoriteGameCard(game) {
            const card = document.createElement('div');
            card.className = 'favorite-game-card';
            card.dataset.id = game.id;
            card.dataset.category = game.category;
            card.dataset.title = game.title.toLowerCase();
            
            // Format the added date
            const addedDate = favoriteTimestamps[game.id] ? 
                new Date(favoriteTimestamps[game.id]).toLocaleDateString() : 
                'Recently';
            
            card.innerHTML = `
                <a href="${game.url}" class="game-link">
                    <div class="thumbnail-container">
                        ${game.banner ? createBannerElement(game.banner) : ''}
                        <div class="game-category-badge category-${game.category}">${game.category}</div>
                        <img src="${game.staticImg}" class="game-thumbnail" alt="${game.title}">
                        <div class="game-overlay">
                            <button class="remove-favorite-btn">
                                <i class='bx bx-trash'></i> Remove
                            </button>
                        </div>
                    </div>
                    <div class="game-info">
                        <div class="game-title">${game.title}</div>
                        <div class="game-card-footer">
                            <span class="game-playtime">
                                <i class='bx bx-calendar'></i> ${addedDate}
                            </span>
                            <div class="game-actions">
                                <button class="action-btn" title="Play">
                                    <i class='bx bx-play'></i>
                                </button>
                                <button class="action-btn" title="Share">
                                    <i class='bx bx-share-alt'></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </a>
            `;
            
            // Add click handler for remove button
            card.querySelector('.remove-favorite-btn').addEventListener('click', function(e) {
                e.preventDefault();
                removeFavorite(firebase.auth().currentUser.uid, game.id, card);
            });
            
            // Add click handler for play button
            card.querySelector('.game-actions .action-btn:nth-child(1)').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                window.location.href = game.url;
            });
            
            // Add click handler for share button
            card.querySelector('.game-actions .action-btn:nth-child(2)').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                shareGame(game);
            });
            
            return card;
        }

        function shareGame(game) {
            if (navigator.share) {
                navigator.share({
                    title: game.title,
                    text: `Check out this awesome game: ${game.title}`,
                    url: window.location.origin + '/' + game.url
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackShare(game);
                });
            } else {
                fallbackShare(game);
            }
        }

        function fallbackShare(game) {
            const shareUrl = window.location.origin + '/' + game.url;
            const shareText = `Check out ${game.title}: ${shareUrl}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareText).then(() => {
                alert('Game link copied to clipboard!');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                prompt('Copy this link to share:', shareUrl);
            });
        }

        // Create banner element
        function createBannerElement(bannerType) {
            return `
                <div class="ribbon ${bannerType} ${bannerType === 'hot' ? 'pulse' : ''}">
                    <i class='${getBannerIcon(bannerType)}'></i>
                    ${bannerType.toUpperCase()}
                </div>
            `;
        }

        // Helper function to get banner icon
        function getBannerIcon(type) {
            const icons = {
                hot: 'bx bx-hot',
                new: 'bx bx-star',
                popular: 'bx bx-trending-up'
            };
            return icons[type] || 'bx bx-info-circle';
        }

        // Remove a favorite game
        function removeFavorite(userId, gameId, element) {
            firebase.firestore().collection('users').doc(userId).collection('favorites').doc(String(gameId)).delete()
                .then(() => {
                    // Remove from currentFavorites array
                    currentFavorites = currentFavorites.filter(id => id !== gameId);
                    delete favoriteTimestamps[gameId];
                    
                    // Add removal animation
                    element.style.transform = 'scale(0.9)';
                    element.style.opacity = '0';
                    setTimeout(() => element.remove(), 300);
                    
                    // Check if there are any remaining favorites
                    if (currentFavorites.length === 0) {
                        showNoFavoritesMessage();
                    } else {
                        // Re-apply filters after removal
                        filterFavorites();
                        updateStats();
                    }
                })
                .catch(error => {
                    console.error('Error removing favorite:', error);
                    alert('Failed to remove favorite. Please try again.');
                });
        }

        // Clear all favorites
        function clearAllFavorites() {
            const user = firebase.auth().currentUser;
            if (!user) return;
            
            const userId = user.uid;
            const batch = firebase.firestore().batch();
            
            firebase.firestore().collection('users').doc(userId).collection('favorites').get()
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    // Clear the current favorites
                    currentFavorites = [];
                    favoriteTimestamps = {};
                    
                    // Clear the UI
                    const gameCards = favoritesContainer.querySelectorAll('.favorite-game-card');
                    gameCards.forEach(card => {
                        card.style.transform = 'scale(0.9)';
                        card.style.opacity = '0';
                        setTimeout(() => card.remove(), 300);
                    });
                    
                    showNoFavoritesMessage();
                    hideConfirmationModal();
                })
                .catch(error => {
                    console.error('Error clearing favorites:', error);
                    alert('Failed to clear favorites. Please try again.');
                    hideConfirmationModal();
                });
        }

        // Filter favorites based on search and category
        function filterFavorites() {
            const searchTerm = favoritesSearch.value.toLowerCase();
            const category = categoryFilter.value;
            
            const gameCards = favoritesContainer.querySelectorAll('.favorite-game-card');
            let hasVisibleCards = false;
            
            gameCards.forEach(card => {
                const cardCategory = card.dataset.category;
                const cardTitle = card.dataset.title;
                
                const matchesSearch = searchTerm === '' || cardTitle.includes(searchTerm);
                const matchesCategory = category === 'all' || cardCategory === category;
                
                if (matchesSearch && matchesCategory) {
                    card.style.display = 'block';
                    hasVisibleCards = true;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show appropriate messages
            if (gameCards.length === 0) {
                noFavoritesMessage.style.display = 'block';
                noResultsMessage.style.display = 'none';
            } else {
                noFavoritesMessage.style.display = 'none';
                noResultsMessage.style.display = hasVisibleCards ? 'none' : 'block';
            }
        }
    </script>
</body>
</html>
