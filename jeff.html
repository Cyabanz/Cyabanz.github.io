<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FusionCYA - Trading</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #1a1a2e;
            color: #fff;
        }
        .navbar {
            background-color: #16213e;
        }
        .card {
            background-color: #0f3460;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .list-group-item {
            background-color: #1a1a2e;
            color: #fff;
            border-color: #2d4059;
        }
        .online-user {
            cursor: pointer;
            transition: all 0.3s;
        }
        .online-user:hover {
            background-color: #2d4059;
        }
        .trade-item {
            cursor: pointer;
            transition: all 0.3s;
        }
        .trade-item:hover {
            transform: scale(1.05);
        }
        .trade-section {
            min-height: 300px;
            border: 2px dashed #2d4059;
            border-radius: 10px;
            padding: 15px;
        }
        .badge-online {
            background-color: #4CAF50;
        }
        .badge-offline {
            background-color: #f44336;
        }
        .trade-confirm-btn {
            transition: all 0.3s;
        }
        .trade-confirm-btn.confirmed {
            background-color: #4CAF50;
        }
        .leaderboard-item {
            transition: all 0.3s;
        }
        .leaderboard-item:hover {
            background-color: #2d4059;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">FusionCYA</a>
            <div class="d-flex align-items-center">
                <span id="username-display" class="me-3">Guest</span>
                <img id="profile-pic" src="https://via.placeholder.com/40" class="rounded-circle me-2" width="40" height="40">
                <button id="signInButton" class="btn btn-primary me-2">Sign In</button>
                <button id="signOutButton" class="btn btn-danger d-none">Sign Out</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <!-- Left Column - Online Players and Leaderboard -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Online Players</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="onlinePlayersList">
                            <div class="list-group-item text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 mb-0">Loading players...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Leaderboard</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="leaderboardList">
                            <div class="list-group-item text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 mb-0">Loading leaderboard...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Trading Area -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Trade Center</h5>
                    </div>
                    <div class="card-body">
                        <div id="tradeInitiateSection" class="text-center py-5">
                            <i class="fas fa-exchange-alt fa-4x text-muted mb-4"></i>
                            <h4>Select an online player to trade with</h4>
                            <p class="text-muted">Only online players can trade</p>
                        </div>

                        <div id="tradeActiveSection" class="d-none">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>Your Offer</h6>
                                    <div class="trade-section" id="yourTradeSection">
                                        <div class="text-center py-4 text-muted" id="yourTradeEmpty">
                                            <i class="fas fa-plus-circle fa-2x mb-2"></i>
                                            <p>Add items to your offer</p>
                                        </div>
                                        <div id="yourTradeItems" class="d-none"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Their Offer</h6>
                                    <div class="trade-section" id="theirTradeSection">
                                        <div class="text-center py-4 text-muted" id="theirTradeEmpty">
                                            <i class="fas fa-user-clock fa-2x mb-2"></i>
                                            <p>Waiting for their offer</p>
                                        </div>
                                        <div id="theirTradeItems" class="d-none"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>Your Inventory</h6>
                                    <ul class="nav nav-tabs" id="inventoryTab" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="pets-tab" data-bs-toggle="tab" data-bs-target="#petsInventory" type="button">Pets</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="knives-tab" data-bs-toggle="tab" data-bs-target="#knivesInventory" type="button">Knives</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="coins-tab" data-bs-toggle="tab" data-bs-target="#coinsInventory" type="button">Coins</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content p-3 border border-top-0" id="inventoryTabContent">
                                        <div class="tab-pane fade show active" id="petsInventory" role="tabpanel">
                                            <div class="row" id="petsInventoryItems"></div>
                                        </div>
                                        <div class="tab-pane fade" id="knivesInventory" role="tabpanel">
                                            <div class="row" id="knivesInventoryItems"></div>
                                        </div>
                                        <div class="tab-pane fade" id="coinsInventory" role="tabpanel">
                                            <div class="input-group mb-3">
                                                <input type="number" class="form-control" id="coinsToTrade" min="0" max="0" value="0">
                                                <button class="btn btn-primary" id="addCoinsBtn">Add Coins</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Trade Controls</h6>
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <p>Trading with: <strong id="tradePartnerName">Player Name</strong></p>
                                            <div class="d-flex justify-content-center mb-3">
                                                <button class="btn btn-primary me-2" id="proposeTradeBtn">Propose Trade</button>
                                                <button class="btn btn-danger" id="cancelTradeBtn">Cancel</button>
                                            </div>
                                            <div id="tradeStatusMessage" class="alert alert-info mb-0"></div>
                                        </div>
                                    </div>
                                    <div class="card mt-3">
                                        <div class="card-body text-center">
                                            <button class="btn btn-success trade-confirm-btn" id="confirmTradeBtn">
                                                <i class="fas fa-check-circle me-2"></i>Confirm Trade
                                            </button>
                                            <p class="mt-2 mb-0 small text-muted">Both players must confirm to complete the trade</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Confirmation Modal -->
    <div class="modal fade" id="tradeConfirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Trade Confirmation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>You Receive</h6>
                            <div id="confirmTheirItems"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>You Give</h6>
                            <div id="confirmYourItems"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="finalConfirmTradeBtn">Confirm Trade</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Completed Modal -->
    <div class="modal fade" id="tradeCompletedModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Trade Completed</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-check-circle fa-5x text-success mb-4"></i>
                    <h4>Trade Successful!</h4>
                    <p id="tradeCompletedMessage">You have successfully completed the trade.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
            authDomain: "fusioncya-cc20a.firebaseapp.com",
            databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
            projectId: "fusioncya-cc20a",
            storageBucket: "fusioncya-cc20a.appspot.com",
            messagingSenderId: "765164293111",
            appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
            measurementId: "G-4DT52P7MPB"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // Trade System Variables
        let currentUser = null;
        let userData = null;
        let onlinePlayers = [];
        let currentTrade = {
            partnerId: null,
            partnerName: null,
            yourItems: [],
            theirItems: [],
            yourConfirmed: false,
            theirConfirmed: false,
            tradeId: null,
            tradeListener: null
        };

        // DOM Elements
        const elements = {
            // Auth
            signInButton: document.getElementById('signInButton'),
            signOutButton: document.getElementById('signOutButton'),
            usernameDisplay: document.getElementById('username-display'),
            profilePic: document.getElementById('profile-pic'),
            
            // Online Players
            onlinePlayersList: document.getElementById('onlinePlayersList'),
            leaderboardList: document.getElementById('leaderboardList'),
            
            // Trade Sections
            tradeInitiateSection: document.getElementById('tradeInitiateSection'),
            tradeActiveSection: document.getElementById('tradeActiveSection'),
            yourTradeSection: document.getElementById('yourTradeSection'),
            theirTradeSection: document.getElementById('theirTradeSection'),
            yourTradeEmpty: document.getElementById('yourTradeEmpty'),
            theirTradeEmpty: document.getElementById('theirTradeEmpty'),
            yourTradeItems: document.getElementById('yourTradeItems'),
            theirTradeItems: document.getElementById('theirTradeItems'),
            tradePartnerName: document.getElementById('tradePartnerName'),
            tradeStatusMessage: document.getElementById('tradeStatusMessage'),
            
            // Inventory
            petsInventoryItems: document.getElementById('petsInventoryItems'),
            knivesInventoryItems: document.getElementById('knivesInventoryItems'),
            coinsToTrade: document.getElementById('coinsToTrade'),
            addCoinsBtn: document.getElementById('addCoinsBtn'),
            
            // Trade Controls
            proposeTradeBtn: document.getElementById('proposeTradeBtn'),
            cancelTradeBtn: document.getElementById('cancelTradeBtn'),
            confirmTradeBtn: document.getElementById('confirmTradeBtn'),
            
            // Modals
            tradeConfirmationModal: new bootstrap.Modal(document.getElementById('tradeConfirmationModal')),
            confirmTheirItems: document.getElementById('confirmTheirItems'),
            confirmYourItems: document.getElementById('confirmYourItems'),
            finalConfirmTradeBtn: document.getElementById('finalConfirmTradeBtn'),
            tradeCompletedModal: new bootstrap.Modal(document.getElementById('tradeCompletedModal')),
            tradeCompletedMessage: document.getElementById('tradeCompletedMessage')
        };

        // Utility Functions
        function formatItemCard(item, type, showRemove = false) {
            const rarityColor = type === 'coins' ? 'warning' : 
                             item.rarity === 'common' ? 'secondary' :
                             item.rarity === 'rare' ? 'primary' :
                             item.rarity === 'epic' ? 'danger' : 'warning';
            
            return `
                <div class="col-6 mb-3">
                    <div class="card trade-item">
                        <div class="card-body p-2">
                            <div class="d-flex align-items-center">
                                <img src="${type === 'coins' ? 'https://via.placeholder.com/50?text=Coins' : item.image}" 
                                     class="rounded me-2" width="40" height="40">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">${type === 'coins' ? `${item.amount} Coins` : item.name}</h6>
                                    ${type !== 'coins' ? `<span class="badge bg-${rarityColor}">${item.rarity}</span>` : ''}
                                </div>
                                ${showRemove ? `
                                <button class="btn btn-sm btn-outline-danger remove-trade-item" 
                                        data-id="${item.id || 'coins'}" 
                                        data-type="${type}">
                                    <i class="fas fa-times"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTradeUI() {
            // Your trade items
            if (currentTrade.yourItems.length > 0) {
                elements.yourTradeEmpty.classList.add('d-none');
                elements.yourTradeItems.classList.remove('d-none');
                elements.yourTradeItems.innerHTML = currentTrade.yourItems.map(item => 
                    formatItemCard(item, item.type, true)
                ).join('');
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.remove-trade-item').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const itemId = this.dataset.id;
                        const itemType = this.dataset.type;
                        removeFromTrade(itemId, itemType);
                    });
                });
            } else {
                elements.yourTradeEmpty.classList.remove('d-none');
                elements.yourTradeItems.classList.add('d-none');
            }
            
            // Their trade items
            if (currentTrade.theirItems.length > 0) {
                elements.theirTradeEmpty.classList.add('d-none');
                elements.theirTradeItems.classList.remove('d-none');
                elements.theirTradeItems.innerHTML = currentTrade.theirItems.map(item => 
                    formatItemCard(item, item.type)
                ).join('');
            } else {
                elements.theirTradeEmpty.classList.remove('d-none');
                elements.theirTradeItems.classList.add('d-none');
            }
            
            // Update confirm button
            if (currentTrade.yourConfirmed) {
                elements.confirmTradeBtn.classList.add('confirmed');
                elements.confirmTradeBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Confirmed';
            } else {
                elements.confirmTradeBtn.classList.remove('confirmed');
                elements.confirmTradeBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Confirm Trade';
            }
            
            // Update trade status message
            if (currentTrade.theirConfirmed) {
                elements.tradeStatusMessage.textContent = `${currentTrade.partnerName} has confirmed the trade. Please confirm to complete.`;
                elements.tradeStatusMessage.classList.remove('alert-info');
                elements.tradeStatusMessage.classList.add('alert-success');
            } else if (currentTrade.yourItems.length > 0 || currentTrade.theirItems.length > 0) {
                elements.tradeStatusMessage.textContent = 'Waiting for both players to confirm the trade...';
                elements.tradeStatusMessage.classList.remove('alert-success');
                elements.tradeStatusMessage.classList.add('alert-info');
            } else {
                elements.tradeStatusMessage.textContent = '';
            }
        }

        function updateInventoryUI() {
            if (!userData) return;
            
            // Pets inventory
            if (userData.inventory.pets.length > 0) {
                elements.petsInventoryItems.innerHTML = userData.inventory.pets.map(pet => `
                    <div class="col-6 mb-3">
                        <div class="card trade-item" data-id="${pet.id}" data-type="pets">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-center">
                                    <img src="${pet.image}" class="rounded me-2" width="40" height="40">
                                    <div>
                                        <h6 class="mb-0">${pet.name}</h6>
                                        <span class="badge bg-${getRarityColor(pet.rarity)}">${pet.rarity}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Add event listeners to pet items
                document.querySelectorAll('#petsInventoryItems .trade-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const petId = this.dataset.id;
                        const pet = userData.inventory.pets.find(p => p.id === petId);
                        if (pet) {
                            addToTrade({...pet, type: 'pets'});
                        }
                    });
                });
            } else {
                elements.petsInventoryItems.innerHTML = `
                    <div class="col-12 text-center py-4 text-muted">
                        <i class="fas fa-box-open fa-2x mb-2"></i>
                        <p>No pets in your inventory</p>
                    </div>
                `;
            }
            
            // Knives inventory
            if (userData.inventory.knives.length > 0) {
                elements.knivesInventoryItems.innerHTML = userData.inventory.knives.map(knife => `
                    <div class="col-6 mb-3">
                        <div class="card trade-item" data-id="${knife.id}" data-type="knives">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-center">
                                    <img src="${knife.image}" class="rounded me-2" width="40" height="40">
                                    <div>
                                        <h6 class="mb-0">${knife.name}</h6>
                                        <span class="badge bg-${getRarityColor(knife.rarity)}">${knife.rarity}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Add event listeners to knife items
                document.querySelectorAll('#knivesInventoryItems .trade-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const knifeId = this.dataset.id;
                        const knife = userData.inventory.knives.find(k => k.id === knifeId);
                        if (knife) {
                            addToTrade({...knife, type: 'knives'});
                        }
                    });
                });
            } else {
                elements.knivesInventoryItems.innerHTML = `
                    <div class="col-12 text-center py-4 text-muted">
                        <i class="fas fa-box-open fa-2x mb-2"></i>
                        <p>No knives in your inventory</p>
                    </div>
                `;
            }
            
            // Coins
            elements.coinsToTrade.max = userData.coins;
        }

        function getRarityColor(rarity) {
            return rarity === 'common' ? 'secondary' :
                   rarity === 'rare' ? 'primary' :
                   rarity === 'epic' ? 'danger' : 'warning';
        }

        // Trade Functions
        function startTrade(partnerId, partnerName) {
            currentTrade = {
                partnerId: partnerId,
                partnerName: partnerName,
                yourItems: [],
                theirItems: [],
                yourConfirmed: false,
                theirConfirmed: false,
                tradeId: null,
                tradeListener: null
            };
            
            // Generate a unique trade ID
            currentTrade.tradeId = `${currentUser.uid}_${partnerId}_${Date.now()}`;
            
            // Update UI
            elements.tradeInitiateSection.classList.add('d-none');
            elements.tradeActiveSection.classList.remove('d-none');
            elements.tradePartnerName.textContent = partnerName;
            
            // Listen for trade updates
            setupTradeListener();
            
            // Update UI
            updateTradeUI();
            updateInventoryUI();
        }

        function setupTradeListener() {
            // Clean up any existing listener
            if (currentTrade.tradeListener) {
                currentTrade.tradeListener();
            }
            
            // Listen for changes to the trade
            currentTrade.tradeListener = db.collection('trades').doc(currentTrade.tradeId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const tradeData = doc.data();
                        
                        // Update trade state
                        if (tradeData.initiatorId === currentUser.uid) {
                            // We are the initiator
                            currentTrade.yourItems = tradeData.initiatorItems || [];
                            currentTrade.theirItems = tradeData.receiverItems || [];
                            currentTrade.yourConfirmed = tradeData.initiatorConfirmed || false;
                            currentTrade.theirConfirmed = tradeData.receiverConfirmed || false;
                        } else {
                            // We are the receiver
                            currentTrade.yourItems = tradeData.receiverItems || [];
                            currentTrade.theirItems = tradeData.initiatorItems || [];
                            currentTrade.yourConfirmed = tradeData.receiverConfirmed || false;
                            currentTrade.theirConfirmed = tradeData.initiatorConfirmed || false;
                        }
                        
                        // Check if trade is completed
                        if (tradeData.status === 'completed') {
                            completeTrade(tradeData);
                        } else if (tradeData.status === 'canceled') {
                            cancelTrade('The other player canceled the trade.');
                        }
                        
                        // Update UI
                        updateTradeUI();
                    }
                });
        }

        function addToTrade(item) {
            // Check if item is already in trade
            const existingIndex = currentTrade.yourItems.findIndex(i => 
                i.id === item.id && i.type === item.type
            );
            
            if (existingIndex >= 0) {
                // Item already in trade, don't add again
                return;
            }
            
            // Add to your trade items
            currentTrade.yourItems.push(item);
            
            // Update trade in Firestore
            updateTradeInFirestore();
            
            // Update UI
            updateTradeUI();
        }

        function removeFromTrade(itemId, itemType) {
            // Remove item from your trade items
            currentTrade.yourItems = currentTrade.yourItems.filter(item => 
                !(item.id === itemId && item.type === itemType)
            );
            
            // Reset confirmation if items changed
            currentTrade.yourConfirmed = false;
            
            // Update trade in Firestore
            updateTradeInFirestore();
            
            // Update UI
            updateTradeUI();
        }

        function updateTradeInFirestore() {
            const tradeData = {
                initiatorId: currentTrade.tradeId.split('_')[0],
                receiverId: currentTrade.partnerId,
                initiatorItems: currentTrade.tradeId.split('_')[0] === currentUser.uid ? 
                    currentTrade.yourItems : currentTrade.theirItems,
                receiverItems: currentTrade.tradeId.split('_')[0] === currentUser.uid ? 
                    currentTrade.theirItems : currentTrade.yourItems,
                initiatorConfirmed: currentTrade.tradeId.split('_')[0] === currentUser.uid ? 
                    currentTrade.yourConfirmed : currentTrade.theirConfirmed,
                receiverConfirmed: currentTrade.tradeId.split('_')[0] === currentUser.uid ? 
                    currentTrade.theirConfirmed : currentTrade.yourConfirmed,
                status: 'active',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('trades').doc(currentTrade.tradeId).set(tradeData);
        }

        function proposeTrade() {
            if (currentTrade.yourItems.length === 0 && currentTrade.theirItems.length === 0) {
                alert('Please add items to the trade before proposing.');
                return;
            }
            
            // Update trade in Firestore
            updateTradeInFirestore();
            
            // Show notification to the other player
            db.collection('notifications').add({
                userId: currentTrade.partnerId,
                type: 'trade',
                message: `${userData.username} has proposed a trade with you!`,
                tradeId: currentTrade.tradeId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update UI
            elements.tradeStatusMessage.textContent = `Trade proposed to ${currentTrade.partnerName}. Waiting for their response...`;
            elements.tradeStatusMessage.classList.remove('alert-success');
            elements.tradeStatusMessage.classList.add('alert-info');
        }

        function confirmTrade() {
            if (currentTrade.yourItems.length === 0 && currentTrade.theirItems.length === 0) {
                alert('Please add items to the trade before confirming.');
                return;
            }
            
            // Show confirmation modal
            elements.confirmYourItems.innerHTML = currentTrade.yourItems.map(item => 
                formatItemCard(item, item.type)
            ).join('');
            
            elements.confirmTheirItems.innerHTML = currentTrade.theirItems.map(item => 
                formatItemCard(item, item.type)
            ).join('');
            
            elements.tradeConfirmationModal.show();
        }

        function finalConfirmTrade() {
            // Mark as confirmed
            currentTrade.yourConfirmed = true;
            
            // Update trade in Firestore
            updateTradeInFirestore();
            
            // Close modal
            elements.tradeConfirmationModal.hide();
            
            // Check if both confirmed
            if (currentTrade.yourConfirmed && currentTrade.theirConfirmed) {
                executeTrade();
            }
        }

        function executeTrade() {
            // Prepare trade data
            const tradeData = {
                status: 'completed',
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Mark trade as completed
            db.collection('trades').doc(currentTrade.tradeId).update(tradeData)
                .then(() => {
                    // Process the trade for both players
                    processTradeForUser(currentUser.uid, currentTrade.theirItems, currentTrade.yourItems);
                    processTradeForUser(currentTrade.partnerId, currentTrade.yourItems, currentTrade.theirItems);
                    
                    // Show success message
                    elements.tradeCompletedMessage.textContent = `You have successfully traded with ${currentTrade.partnerName}.`;
                    elements.tradeCompletedModal.show();
                    
                    // Reset trade
                    resetTrade();
                })
                .catch(error => {
                    console.error('Error completing trade:', error);
                    alert('Error completing trade. Please try again.');
                });
        }

        function processTradeForUser(userId, itemsToReceive, itemsToGive) {
            // Get user data
            db.collection('users').doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const user = doc.data();
                        
                        // Add received items
                        itemsToReceive.forEach(item => {
                            if (item.type === 'coins') {
                                user.coins += item.amount;
                            } else {
                                const existingItem = user.inventory[item.type].find(i => i.id === item.id);
                                if (existingItem) {
                                    existingItem.quantity = (existingItem.quantity || 1) + 1;
                                } else {
                                    user.inventory[item.type].push({...item, quantity: 1});
                                }
                            }
                        });
                        
                        // Remove given items
                        itemsToGive.forEach(item => {
                            if (item.type === 'coins') {
                                user.coins -= item.amount;
                            } else {
                                const itemIndex = user.inventory[item.type].findIndex(i => i.id === item.id);
                                if (itemIndex >= 0) {
                                    const inventoryItem = user.inventory[item.type][itemIndex];
                                    if (inventoryItem.quantity > 1) {
                                        inventoryItem.quantity -= 1;
                                    } else {
                                        user.inventory[item.type].splice(itemIndex, 1);
                                    }
                                }
                            }
                        });
                        
                        // Update user data
                        db.collection('users').doc(userId).update({
                            coins: user.coins,
                            inventory: user.inventory
                        });
                    }
                })
                .catch(error => {
                    console.error('Error processing trade for user:', userId, error);
                });
        }

        function cancelTrade(message = null) {
            if (currentTrade.tradeId) {
                // Mark trade as canceled
                db.collection('trades').doc(currentTrade.tradeId).update({
                    status: 'canceled',
                    canceledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Clean up listener
                if (currentTrade.tradeListener) {
                    currentTrade.tradeListener();
                }
            }
            
            // Show message if provided
            if (message) {
                alert(message);
            }
            
            // Reset trade
            resetTrade();
        }

        function resetTrade() {
            // Clean up listener
            if (currentTrade.tradeListener) {
                currentTrade.tradeListener();
            }
            
            // Reset trade state
            currentTrade = {
                partnerId: null,
                partnerName: null,
                yourItems: [],
                theirItems: [],
                yourConfirmed: false,
                theirConfirmed: false,
                tradeId: null,
                tradeListener: null
            };
            
            // Update UI
            elements.tradeInitiateSection.classList.remove('d-none');
            elements.tradeActiveSection.classList.add('d-none');
            updateInventoryUI();
        }

        function completeTrade(tradeData) {
            // Show success message
            elements.tradeCompletedMessage.textContent = `You have successfully traded with ${currentTrade.partnerName}.`;
            elements.tradeCompletedModal.show();
            
            // Reload user data to reflect changes
            loadUserData(currentUser.uid);
            
            // Reset trade
            resetTrade();
        }

        // Online Players Functions
        function updateOnlinePlayersList(players) {
            onlinePlayers = players.filter(player => player.userId !== currentUser.uid);
            
            if (onlinePlayers.length > 0) {
                elements.onlinePlayersList.innerHTML = onlinePlayers.map(player => `
                    <div class="list-group-item online-user" data-id="${player.userId}" data-name="${player.username}">
                        <div class="d-flex align-items-center">
                            <img src="${player.photoURL || 'https://via.placeholder.com/40'}" 
                                 class="rounded-circle me-3" width="40" height="40">
                            <div class="flex-grow-1">
                                <h6 class="mb-0">${player.username}</h6>
                                <small class="text-muted">Coins: ${player.coins}</small>
                            </div>
                            <span class="badge badge-online">Online</span>
                        </div>
                    </div>
                `).join('');
                
                // Add event listeners to online players
                document.querySelectorAll('.online-user').forEach(player => {
                    player.addEventListener('click', function() {
                        const playerId = this.dataset.id;
                        const playerName = this.dataset.name;
                        startTrade(playerId, playerName);
                    });
                });
            } else {
                elements.onlinePlayersList.innerHTML = `
                    <div class="list-group-item text-center py-4">
                        <i class="fas fa-user-slash fa-2x text-muted mb-2"></i>
                        <p class="mb-0">No other players online</p>
                    </div>
                `;
            }
        }

        function updateLeaderboardList(players) {
            // Sort by coins (descending)
            const sortedPlayers = [...players].sort((a, b) => b.coins - a.coins);
            
            elements.leaderboardList.innerHTML = sortedPlayers.map((player, index) => `
                <div class="list-group-item leaderboard-item">
                    <div class="d-flex align-items-center">
                        <span class="me-3 fw-bold">${index + 1}</span>
                        <img src="${player.photoURL || 'https://via.placeholder.com/40'}" 
                             class="rounded-circle me-3" width="40" height="40">
                        <div class="flex-grow-1">
                            <h6 class="mb-0">${player.username}</h6>
                            <small class="text-muted">Coins: ${player.coins}</small>
                        </div>
                        <span class="badge ${player.status === 'online' ? 'badge-online' : 'badge-offline'}">
                            ${player.status === 'online' ? 'Online' : 'Offline'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Firebase Functions
        async function loadUserData(userId) {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    userData = doc.data();
                    
                    // Update UI
                    elements.usernameDisplay.textContent = userData.username;
                    if (userData.photoBase64) {
                        elements.profilePic.src = userData.photoBase64;
                    }
                    
                    // Update inventory UI
                    updateInventoryUI();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        function setupPresenceTracking(userId) {
            // User's online status
            const userStatusDatabaseRef = db.ref('/status/' + userId);
            
            // Firestore uses a different approach for presence
            const userDoc = db.collection('users').doc(userId);
            
            // Set user to online
            userDoc.update({
                status: 'online',
                lastOnline: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Handle disconnect
            const onDisconnectRef = userStatusDatabaseRef.onDisconnect();
            onDisconnectRef.set({
                status: 'offline',
                lastOnline: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                userStatusDatabaseRef.set({
                    status: 'online',
                    lastOnline: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            // Listen for online players
            db.collection('users').where('status', '==', 'online')
                .onSnapshot((snapshot) => {
                    const players = [];
                    snapshot.forEach(doc => {
                        players.push({
                            userId: doc.id,
                            ...doc.data()
                        });
                    });
                    updateOnlinePlayersList(players);
                    updateLeaderboardList(players);
                });
        }

        // Event Listeners
        function setupEventListeners() {
            // Auth
            elements.signInButton.addEventListener('click', signInWithGoogle);
            elements.signOutButton.addEventListener('click', () => {
                auth.signOut();
            });
            
            // Trade Controls
            elements.proposeTradeBtn.addEventListener('click', proposeTrade);
            elements.cancelTradeBtn.addEventListener('click', () => cancelTrade());
            elements.confirmTradeBtn.addEventListener('click', confirmTrade);
            elements.finalConfirmTradeBtn.addEventListener('click', finalConfirmTrade);
            
            // Coins
            elements.addCoinsBtn.addEventListener('click', () => {
                const coins = parseInt(elements.coinsToTrade.value);
                if (isNaN(coins) || coins <= 0) {
                    alert('Please enter a valid amount of coins');
                    return;
                }
                
                if (coins > userData.coins) {
                    alert('You don\'t have enough coins');
                    return;
                }
                
                // Add coins to trade
                addToTrade({
                    id: 'coins',
                    type: 'coins',
                    amount: coins
                });
            });
            
            // Check for incoming trades
            checkForIncomingTrades();
        }

        function signInWithGoogle() {
            auth.signInWithPopup(provider)
                .then((result) => {
                    // User signed in
                })
                .catch((error) => {
                    console.error('Sign in error:', error);
                    alert('Sign in failed: ' + error.message);
                });
        }

        function checkForIncomingTrades() {
            // Listen for notifications
            auth.onAuthStateChanged(user => {
                if (user) {
                    db.collection('notifications')
                        .where('userId', '==', user.uid)
                        .where('read', '==', false)
                        .onSnapshot(snapshot => {
                            snapshot.docChanges().forEach(change => {
                                if (change.type === 'added') {
                                    const notification = change.doc.data();
                                    
                                    // Mark as read
                                    db.collection('notifications').doc(change.doc.id).update({
                                        read: true
                                    });
                                    
                                    // Check if it's a trade notification
                                    if (notification.type === 'trade') {
                                        Swal.fire({
                                            title: 'Trade Request',
                                            text: notification.message,
                                            icon: 'info',
                                            showCancelButton: true,
                                            confirmButtonText: 'View Trade',
                                            cancelButtonText: 'Dismiss'
                                        }).then((result) => {
                                            if (result.isConfirmed) {
                                                // Get trade info
                                                db.collection('trades').doc(notification.tradeId).get()
                                                    .then(doc => {
                                                        if (doc.exists) {
                                                            const tradeData = doc.data();
                                                            const partnerId = tradeData.initiatorId;
                                                            
                                                            // Get partner info
                                                            db.collection('users').doc(partnerId).get()
                                                                .then(partnerDoc => {
                                                                    if (partnerDoc.exists) {
                                                                        const partnerData = partnerDoc.data();
                                                                        startTrade(partnerId, partnerData.username);
                                                                    }
                                                                });
                                                        }
                                                    });
                                            }
                                        });
                                    }
                                }
                            });
                        });
                }
            });
        }

        // Auth State Listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                elements.signOutButton.classList.remove('d-none');
                
                // Load user data
                loadUserData(user.uid);
                
                // Set up presence tracking
                setupPresenceTracking(user.uid);
                
                // Set profile info
                const displayName = user.displayName || 'User';
                elements.usernameDisplay.textContent = displayName;
                
                if (user.photoURL) {
                    elements.profilePic.src = user.photoURL;
                }
            } else {
                // User is signed out
                currentUser = null;
                userData = null;
                elements.signOutButton.classList.add('d-none');
                elements.usernameDisplay.textContent = 'Guest';
                elements.profilePic.src = 'https://via.placeholder.com/40';
                
                // Clear online players list
                elements.onlinePlayersList.innerHTML = `
                    <div class="list-group-item text-center py-4">
                        <i class="fas fa-sign-in-alt fa-2x text-muted mb-2"></i>
                        <p class="mb-0">Please sign in to see online players</p>
                    </div>
                `;
                
                // Clear leaderboard
                elements.leaderboardList.innerHTML = `
                    <div class="list-group-item text-center py-4">
                        <i class="fas fa-sign-in-alt fa-2x text-muted mb-2"></i>
                        <p class="mb-0">Please sign in to see the leaderboard</p>
                    </div>
                `;
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });
    </script>
</body>
</html>
