<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Defender</title>
    <!-- Boxicons CSS -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        /* Theme Variables */
        :root {
            /* Light Theme (default) */
            --text: #1b263b;
            --text-inverse: #f8f9fa;
            --background: #f5f7ff;
            --card-bg: #ffffff;
            --border: #e9ecef;
            --gray: #adb5bd;
            --gray-light: #e9ecef;
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
        }

        /* Dark Theme */
        .dark {
            --text: #f8f9fa;
            --text-inverse: #1b263b;
            --background: #121212;
            --card-bg: #1a1a1a;
            --border: #333333;
            --gray: #555555;
            --gray-light: #333333;
        }

        /* Moon Theme */
        .moon {
            --text: #e2e8f0;
            --text-inverse: #0f172a;
            --background: #0f172a;
            --card-bg: #1e293b;
            --border: #334155;
            --gray: #64748b;
            --gray-light: #334155;
        }

        /* Emerald Theme */
        .emerald {
            --text: #a7f3d0;
            --text-inverse: #064e3b;
            --background: #064e3b;
            --card-bg: #047857;
            --border: #059669;
            --gray: #34d399;
            --gray-light: #059669;
        }

        /* Ruby Theme */
        .ruby {
            --text: #fbcfe8;
            --text-inverse: #831843;
            --background: #831843;
            --card-bg: #9d174d;
            --border: #be185d;
            --gray: #ec4899;
            --gray-light: #be185d;
        }

        /* Diamond Theme */
        .diamond {
            --text: #082f49;
            --text-inverse: #bae6fd;
            --background: linear-gradient(135deg, #0ea5e9, #7dd3fc);
            --card-bg: #bae6fd;
            --border: #7dd3fc;
            --gray: #38bdf8;
            --gray-light: #7dd3fc;
        }

        /* Crazy Theme */
        .crazy {
            --text: #2b0504;
            --text-inverse: #ffedd5;
            --background: linear-gradient(135deg, #ff3e00, #ffbe0b);
            --card-bg: #ffedd5;
            --border: #fdba74;
            --gray: #fb923c;
            --gray-light: #fdba74;
        }

        /* Base Styles */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background);
            color: var(--text);
            transition: background 0.3s ease, color 0.3s ease;
        }

        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        
        .game-container {
            max-width: 800px;
            margin: 20px auto;
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            background-color: var(--card-bg);
        }
        
        .game-header {
            background-color: var(--card-bg);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .game-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .game-controls {
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            width: 40px;
            height: 40px;
            background-color: var(--gray-light);
            border: none;
            border-radius: 4px;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background-color: var(--gray);
        }
        
        .control-btn.active {
            background-color: var(--primary);
            color: white;
        }
        
        .bx {
            font-size: 24px;
        }
        
        .game-frame {
            width: 100%;
            height: 450px;
            border: none;
            background-color: #000;
        }
        
        .game-info {
            background-color: var(--card-bg);
            padding: 15px;
        }
        
        .game-description {
            margin-bottom: 15px;
            line-height: 1.5;
            color: var(--text);
        }
        
        .game-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        
        .rating-container {
            display: flex;
            gap: 10px;
        }
        
        .rating-btn {
            padding: 8px 15px;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .like-btn {
            background-color: var(--success);
            color: white;
        }
        
        .like-btn.active {
            opacity: 0.8;
        }
        
        .dislike-btn {
            background-color: var(--danger);
            color: white;
        }
        
        .dislike-btn.active {
            opacity: 0.8;
        }
        
        .rating-count {
            font-size: 14px;
            margin-left: 5px;
            color: var(--text);
        }
        
        .auth-message {
            font-size: 14px;
            color: var(--warning);
            margin-top: 5px;
        }
        
        .controls-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .key {
            background-color: var(--gray-light);
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--text);
        }
        
        .auth-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .auth-btn {
            padding: 8px 15px;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        
        .signin-btn {
            background-color: var(--primary);
            color: white;
        }
        
        .signout-btn {
            background-color: var(--danger);
            color: white;
        }
        
        @media (max-width: 600px) {
            .controls-list {
                grid-template-columns: 1fr;
            }
            
            .game-frame {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Particle Canvas will be created by JavaScript -->
    
    <div class="game-container">
        <div class="game-header">
            <div class="game-title">Galactic Defender</div>
            <div class="game-controls">
                <button class="control-btn" id="likeBtn" title="Like">
                    <i class='bx bx-like'></i>
                </button>
                <button class="control-btn" id="dislikeBtn" title="Dislike">
                    <i class='bx bx-dislike'></i>
                </button>
                <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
                    <i class='bx bx-fullscreen'></i>
                </button>
            </div>
        </div>
        
        <iframe src="https://example.com/galactic-defender" class="game-frame" allowfullscreen></iframe>
        
        <div class="game-info">
            <div class="game-description">
                <h3>About the Game</h3>
                <p>Galactic Defender is an intense space shooter where you protect the galaxy from invading alien forces. Upgrade your ship's weapons and shields as you battle through increasingly difficult waves of enemies!</p>
            </div>
            
            <div class="game-controls-info">
                <h3>Controls</h3>
                <div class="controls-list">
                    <div class="control-item">
                        <span class="key">↑</span>
                        <span>Move Up</span>
                    </div>
                    <div class="control-item">
                        <span class="key">←</span>
                        <span>Move Left</span>
                    </div>
                    <div class="control-item">
                        <span class="key">↓</span>
                        <span>Move Down</span>
                    </div>
                    <div class="control-item">
                        <span class="key">→</span>
                        <span>Move Right</span>
                    </div>
                    <div class="control-item">
                        <span class="key">SPACE</span>
                        <span>Fire Weapons</span>
                    </div>
                    <div class="control-item">
                        <span class="key">SHIFT</span>
                        <span>Special Attack</span>
                    </div>
                </div>
            </div>
            
            <div class="game-stats">
                <div class="rating-container">
                    <span id="likeCount" class="rating-count">0 likes</span>
                    <span id="dislikeCount" class="rating-count">0 dislikes</span>
                </div>
                <div id="authMessage" class="auth-message">Sign in to rate this game</div>
            </div>
            
            <div class="auth-buttons" id="authButtons" style="display: none;">
                <button id="signinBtn" class="auth-btn signin-btn">
                    <i class='bx bx-log-in'></i> Sign In
                </button>
                <button id="signoutBtn" class="auth-btn signout-btn">
                    <i class='bx bx-log-out'></i> Sign Out
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
            authDomain: "fusioncya-cc20a.firebaseapp.com",
            databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
            projectId: "fusioncya-cc20a",
            storageBucket: "fusioncya-cc20a.firebasestorage.app",
            messagingSenderId: "765164293111",
            appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
            measurementId: "G-4DT52P7MPB"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const db = firebase.firestore();
        
        // Reference to the game ratings in the database - CHANGE THIS FOR EACH GAME
        const gameId = "galactic_defender"; // Unique identifier for this game
        const ratingsRef = database.ref(`gameRatings/${gameId}`);
        
        // DOM elements
        const likeBtn = document.getElementById('likeBtn');
        const dislikeBtn = document.getElementById('dislikeBtn');
        const likeCount = document.getElementById('likeCount');
        const dislikeCount = document.getElementById('dislikeCount');
        const authMessage = document.getElementById('authMessage');
        const authButtons = document.getElementById('authButtons');
        const signinBtn = document.getElementById('signinBtn');
        const signoutBtn = document.getElementById('signoutBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        
        // Track user's vote to prevent multiple votes
        let userVote = null;
        let currentUser = null;
        let currentSettings = {};
        let settingsListener = null;
        let panicKeyListener = null;
        let particles = [];
        let particleCanvas;
        let particleCtx;

        // Listen for authentication state changes
        auth.onAuthStateChanged(user => {
            currentUser = user;
            
            if (user) {
                // User is signed in
                likeBtn.disabled = false;
                dislikeBtn.disabled = false;
                authMessage.textContent = "Rate this game";
                authButtons.style.display = 'flex';
                signoutBtn.style.display = 'block';
                signinBtn.style.display = 'none';
                
                // Check if user has already voted
                database.ref(`userVotes/${gameId}/${user.uid}`).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            userVote = snapshot.val();
                            if (userVote === 'like') {
                                likeBtn.classList.add('active');
                            } else if (userVote === 'dislike') {
                                dislikeBtn.classList.add('active');
                            }
                        }
                    });

                // Set up settings listener
                setupSettingsListener(user.uid);
            } else {
                // User is signed out
                likeBtn.disabled = true;
                dislikeBtn.disabled = true;
                authMessage.textContent = "Sign in to rate this game";
                authButtons.style.display = 'flex';
                signoutBtn.style.display = 'none';
                signinBtn.style.display = 'block';
                likeBtn.classList.remove('active');
                dislikeBtn.classList.remove('active');

                // Clean up settings listener
                if (settingsListener) {
                    settingsListener();
                    settingsListener = null;
                }

                // Apply default settings
                applySettings({
                    theme: '',
                    backgroundImage: '',
                    particlesEnabled: false
                });
            }
        });
        
        // Listen for rating changes
        ratingsRef.on('value', (snapshot) => {
            const ratings = snapshot.val() || { likes: 0, dislikes: 0 };
            likeCount.textContent = `${ratings.likes || 0} likes`;
            dislikeCount.textContent = `${ratings.dislikes || 0} dislikes`;
        });
        
        // Handle like button click
        likeBtn.addEventListener('click', () => {
            if (!currentUser) return;
            
            const userId = currentUser.uid;
            const userVoteRef = database.ref(`userVotes/${gameId}/${userId}`);
            
            if (userVote === 'like') {
                // User is removing their like
                ratingsRef.transaction(current => {
                    return { 
                        likes: (current?.likes || 0) - 1,
                        dislikes: current?.dislikes || 0
                    };
                });
                userVoteRef.remove();
                userVote = null;
                likeBtn.classList.remove('active');
            } else {
                // User is adding/changing to like
                ratingsRef.transaction(current => {
                    const update = { 
                        likes: (current?.likes || 0) + 1,
                        dislikes: current?.dislikes || 0
                    };
                    
                    // If user previously disliked, remove that dislike
                    if (userVote === 'dislike') {
                        update.dislikes = Math.max(0, (current?.dislikes || 0) - 1);
                        dislikeBtn.classList.remove('active');
                    }
                    
                    return update;
                });
                
                userVoteRef.set('like');
                userVote = 'like';
                likeBtn.classList.add('active');
            }
        });
        
        // Handle dislike button click
        dislikeBtn.addEventListener('click', () => {
            if (!currentUser) return;
            
            const userId = currentUser.uid;
            const userVoteRef = database.ref(`userVotes/${gameId}/${userId}`);
            
            if (userVote === 'dislike') {
                // User is removing their dislike
                ratingsRef.transaction(current => {
                    return { 
                        likes: current?.likes || 0,
                        dislikes: (current?.dislikes || 0) - 1
                    };
                });
                userVoteRef.remove();
                userVote = null;
                dislikeBtn.classList.remove('active');
            } else {
                // User is adding/changing to dislike
                ratingsRef.transaction(current => {
                    const update = { 
                        likes: current?.likes || 0,
                        dislikes: (current?.dislikes || 0) + 1
                    };
                    
                    // If user previously liked, remove that like
                    if (userVote === 'like') {
                        update.likes = Math.max(0, (current?.likes || 0) - 1);
                        likeBtn.classList.remove('active');
                    }
                    
                    return update;
                });
                
                userVoteRef.set('dislike');
                userVote = 'dislike';
                dislikeBtn.classList.add('active');
            }
        });
        
        // Fullscreen button functionality
        fullscreenBtn.addEventListener('click', () => {
            const iframe = document.querySelector('.game-frame');
            
            if (iframe.requestFullscreen) {
                iframe.requestFullscreen();
            } else if (iframe.webkitRequestFullscreen) {
                iframe.webkitRequestFullscreen();
            } else if (iframe.msRequestFullscreen) {
                iframe.msRequestFullscreen();
            }
        });
        
        // Sign in button (using anonymous auth - you can change to other providers)
        signinBtn.addEventListener('click', () => {
            auth.signInAnonymously()
                .catch(error => {
                    console.error("Sign in error:", error);
                    authMessage.textContent = "Sign in failed. Please try again.";
                });
        });
        
        // Sign out button
        signoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // Particle Effects System
        function initParticles(settings) {
            if (!settings.particlesEnabled) {
                destroyParticles();
                return;
            }

            particleCanvas = document.getElementById('particle-canvas');
            if (!particleCanvas) {
                particleCanvas = document.createElement('canvas');
                particleCanvas.id = 'particle-canvas';
                document.body.insertBefore(particleCanvas, document.body.firstChild);
            }
            
            particleCtx = particleCanvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            createParticles(settings);
            animateParticles();
        }

        function resizeCanvas() {
            if (!particleCanvas) return;
            particleCanvas.width = window.innerWidth;
            particleCanvas.height = window.innerHeight;
        }

        function createParticles(settings) {
            const count = parseInt(settings.particleCount) || 50;
            const type = settings.particleType || 'circle';
            const colors = [
                settings.particleColor1 || '#4361ee',
                settings.particleColor2 || '#f72585',
                settings.particleColor3 || '#4cc9f0'
            ];
            
            const speed = parseInt(settings.particleSpeed) || 3;
            
            particles = [];
            
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: Math.random() * particleCanvas.width,
                    y: Math.random() * particleCanvas.height,
                    size: Math.random() * 5 + 2,
                    speedX: (Math.random() - 0.5) * speed,
                    speedY: (Math.random() - 0.5) * speed,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    type: type
                });
            }
        }

        function animateParticles() {
            if (!particleCanvas || !particleCtx) return;
            
            particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
            
            for (let i = 0; i < particles.length; i++) {
                const p = particles[i];
                
                p.x += p.speedX;
                p.y += p.speedY;
                
                if (p.x < 0 || p.x > particleCanvas.width) p.speedX *= -1;
                if (p.y < 0 || p.y > particleCanvas.height) p.speedY *= -1;
                
                particleCtx.fillStyle = p.color;
                
                switch(p.type) {
                    case 'star':
                        drawStar(p.x, p.y, 5, p.size, p.size / 2);
                        break;
                    case 'triangle':
                        drawTriangle(p.x, p.y, p.size);
                        break;
                    default:
                        particleCtx.beginPath();
                        particleCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        particleCtx.fill();
                }
            }
            
            requestAnimationFrame(animateParticles);
        }

        function drawStar(cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let x = cx;
            let y = cy;
            let step = Math.PI / spikes;
            
            particleCtx.beginPath();
            particleCtx.moveTo(cx, cy - outerRadius);
            
            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius;
                y = cy + Math.sin(rot) * outerRadius;
                particleCtx.lineTo(x, y);
                rot += step;
                
                x = cx + Math.cos(rot) * innerRadius;
                y = cy + Math.sin(rot) * innerRadius;
                particleCtx.lineTo(x, y);
                rot += step;
            }
            
            particleCtx.lineTo(cx, cy - outerRadius);
            particleCtx.closePath();
            particleCtx.fill();
        }

        function drawTriangle(x, y, size) {
            particleCtx.beginPath();
            particleCtx.moveTo(x, y - size);
            particleCtx.lineTo(x + size, y + size);
            particleCtx.lineTo(x - size, y + size);
            particleCtx.closePath();
            particleCtx.fill();
        }

        function destroyParticles() {
            if (particleCanvas) {
                particleCanvas.remove();
                particleCanvas = null;
                particleCtx = null;
                window.removeEventListener('resize', resizeCanvas);
            }
        }

        // Setup panic key listener
        function setupPanicKeyListener() {
            // Remove previous listener if exists
            if (panicKeyListener) {
                document.removeEventListener('keydown', panicKeyListener);
            }

            // Only setup listener if we have valid settings
            if (currentSettings.panicKey && currentSettings.panicUrl) {
                panicKeyListener = function(e) {
                    if (e.key === currentSettings.panicKey) {
                        window.location.href = currentSettings.panicUrl;
                    }
                };
                
                document.addEventListener('keydown', panicKeyListener);
            }
        }

        // Apply tab cloaking settings
        function applyTabCloakSettings(settings) {
            if (settings.cloakSite) {
                document.title = getCloakTitle(settings.cloakSite);
                updateFavicon(settings.cloakSite);
            }
        }

        function getCloakTitle(site) {
            const titles = {
                'google': 'Google Classroom',
                'clever': 'Clever | Portal',
                'drive': 'My Drive - Google Drive',
                'docs': 'Google Docs'
            };
            return titles[site] || 'Galactic Defender';
        }

        function updateFavicon(site) {
            const favicon = document.querySelector('link[rel="icon"]') || document.createElement('link');
            favicon.rel = 'icon';
            
            const icons = {
                'google': 'https://www.google.com/favicon.ico',
                'clever': 'https://clever.com/favicon.ico',
                'drive': 'https://drive.google.com/favicon.ico',
                'docs': 'https://docs.google.com/favicon.ico'
            };
            
            favicon.href = icons[site] || 'favicon.ico';
            document.head.appendChild(favicon);
        }

        // Settings Listener
        function setupSettingsListener(userId) {
            settingsListener = db.collection('users').doc(userId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        currentSettings = doc.data().settings || {};
                        applySettings(currentSettings);
                    }
                }, (error) => {
                    console.error('Error listening to settings:', error);
                });
        }

        function applySettings(settings) {
            // Apply theme
            if (settings.theme) {
                document.body.className = settings.theme;
            } else {
                document.body.className = ''; // Reset to default theme
            }

            // Apply background image
            if (settings.backgroundImage) {
                document.body.style.backgroundImage = `url(${settings.backgroundImage})`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
            } else {
                document.body.style.backgroundImage = 'none';
            }

            // Apply particle effects
            if (settings.particlesEnabled) {
                initParticles(settings);
            } else {
                destroyParticles();
            }

            // Apply panic key settings
            setupPanicKeyListener();

            // Apply tab cloaking settings
            applyTabCloakSettings(settings);
        }
    </script>
</body>
</html>
