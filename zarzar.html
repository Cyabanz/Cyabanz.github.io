<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FusionCYA - Trading</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Add trading-specific styles */
        .trade-container {
            border: 2px solid #444;
            border-radius: 10px;
            padding: 15px;
            background-color: #2a2a2a;
            margin-bottom: 20px;
        }
        
        .trade-slot {
            min-height: 100px;
            border: 2px dashed #555;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            background-color: #333;
            position: relative;
        }
        
        .trade-item {
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .trade-item:hover {
            transform: scale(1.05);
        }
        
        .trade-item-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
        }
        
        .online-user {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .online-user:hover {
            background-color: #444;
        }
        
        .online-user.active {
            background-color: #007bff;
        }
        
        .trade-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .trade-status.pending {
            background-color: #ffc107;
            color: #000;
        }
        
        .trade-status.accepted {
            background-color: #28a745;
            color: #fff;
        }
        
        .trade-status.rejected {
            background-color: #dc3545;
            color: #fff;
        }
        
        /* Wheel and blackjack styles remain the same */
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
        }
        
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            transform: rotate(0deg);
        }
        
        .wheel-section {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: bottom right;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #dc3545;
            z-index: 10;
        }
        
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            z-index: 5;
            border: 5px solid #444;
            cursor: pointer;
        }
        
        /* Blackjack styles */
        .card-slot {
            width: 80px;
            height: 120px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            background-color: white;
            overflow: hidden;
        }
        
        .card-slot img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .card-back {
            background: repeating-linear-gradient(
                45deg,
                #d11,
                #d11 10px,
                #a00 10px,
                #a00 20px
            );
            color: white;
            font-size: 24px;
        }
        
        .blackjack-result {
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .blackjack-result.win {
            background-color: #28a745;
            color: white;
        }
        
        .blackjack-result.lose {
            background-color: #dc3545;
            color: white;
        }
        
        .blackjack-result.push {
            background-color: #ffc107;
            color: black;
        }
        
        /* General styles */
        body {
            background-color: #1a1a1a;
            color: #fff;
        }
        
        .navbar {
            background-color: #212529 !important;
        }
        
        .card {
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: #fff;
        }
        
        .form-control, .form-range {
            background-color: #333;
            border-color: #444;
            color: #fff;
        }
        
        .form-control:focus {
            background-color: #444;
            border-color: #555;
            color: #fff;
        }
        
        .nav-tabs .nav-link {
            color: #aaa;
        }
        
        .nav-tabs .nav-link.active {
            color: #fff;
            background-color: #2c2c2c;
            border-color: #444 #444 #2c2c2c;
        }
        
        .progress {
            background-color: #333;
        }
        
        .reward-animation {
            animation: bounce 0.5s alternate infinite;
        }
        
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }
        
        .loot-box {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .loot-box:hover {
            transform: scale(1.05);
        }
        
        .inventory-item {
            position: relative;
            cursor: pointer;
        }
        
        .inventory-item:hover {
            opacity: 0.8;
        }
        
        .inventory-item-quantity {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">FusionCYA</a>
            <div class="d-flex align-items-center">
                <span id="username-display" class="me-3">Guest</span>
                <img id="profile-pic" src="https://via.placeholder.com/40" class="rounded-circle me-2" width="40" height="40">
                <button id="signInButton" class="btn btn-primary me-2">Sign In</button>
                <button id="signOutButton" class="btn btn-danger d-none">Sign Out</button>
            </div>
        </div>
    </nav>

    <!-- Login View -->
    <div id="login-view" class="container text-center py-5">
        <h1 class="mb-4">Welcome to FusionCYA</h1>
        <p class="lead mb-4">Sign in to claim daily rewards, open loot boxes, and collect pets and knives!</p>
        <button id="signInButton2" class="btn btn-primary btn-lg">Sign In with Google</button>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard-view" class="container d-none">
        <!-- Profile Section -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <img id="profile-pic-preview" src="https://via.placeholder.com/150" class="rounded-circle mb-3" width="150" height="150">
                        <h4 id="dashboard-username">User</h4>
                        <div class="input-group mb-3">
                            <input type="text" id="new-username" class="form-control" placeholder="New username">
                            <button id="update-username-btn" class="btn btn-primary">Update</button>
                        </div>
                        <div class="d-flex justify-content-center">
                            <input type="file" id="profile-pic-upload" accept="image/*" class="d-none">
                            <button id="upload-profile-pic-btn" class="btn btn-secondary me-2">Choose Image</button>
                            <button id="update-profile-pic-btn" class="btn btn-primary">Update</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Stats</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-coins fa-2x text-warning me-3"></i>
                                    <div>
                                        <h5 class="mb-0">Coins</h5>
                                        <h3 id="coin-balance">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-fire fa-2x text-danger me-3"></i>
                                    <div>
                                        <h5 class="mb-0">Current Streak</h5>
                                        <h3 id="current-streak">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="streak-container">
                            <h5>Daily Streak Progress</h5>
                            <div class="progress mb-2">
                                <div id="streak-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                            </div>
                            <p>Next streak reward in <span id="next-streak-reward">7</span> days</p>
                            <button id="claim-daily-btn" class="btn btn-primary">Claim Daily Reward</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="lootbox-tab" data-bs-toggle="tab" data-bs-target="#lootbox" type="button" role="tab">Loot Boxes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="shop-tab" data-bs-toggle="tab" data-bs-target="#shop" type="button" role="tab">Shop</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">Inventory</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gamble-tab" data-bs-toggle="tab" data-bs-target="#gamble" type="button" role="tab">Gamble</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="blackjack-tab" data-bs-toggle="tab" data-bs-target="#blackjack" type="button" role="tab">Blackjack</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trade-tab" data-bs-toggle="tab" data-bs-target="#trade" type="button" role="tab">Trade</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Loot Boxes Tab -->
            <div class="tab-pane fade show active" id="lootbox" role="tabpanel">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <img src="https://via.placeholder.com/200x150?text=Free+Box" class="img-fluid mb-3 loot-box" style="max-height: 200px;">
                                <h4>Free Box</h4>
                                <p>Open once every 24 hours</p>
                                <p id="free-box-timer" class="text-muted">Ready!</p>
                                <button class="btn btn-primary open-lootbox-btn" data-tier="free">Open Free Box</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <img src="https://via.placeholder.com/200x150?text=Bronze+Box" class="img-fluid mb-3 loot-box" style="max-height: 200px;">
                                <h4>Bronze Box</h4>
                                <p>Cost: 100 coins</p>
                                <p>Better chances for rare items</p>
                                <button class="btn btn-primary open-lootbox-btn" data-tier="bronze">Open Bronze Box</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <img src="https://via.placeholder.com/200x150?text=Silver+Box" class="img-fluid mb-3 loot-box" style="max-height: 200px;">
                                <h4>Silver Box</h4>
                                <p>Cost: 250 coins</p>
                                <p>Good chances for epic items</p>
                                <button class="btn btn-primary open-lootbox-btn" data-tier="silver">Open Silver Box</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <img src="https://via.placeholder.com/200x150?text=Gold+Box" class="img-fluid mb-3 loot-box" style="max-height: 200px;">
                                <h4>Gold Box</h4>
                                <p>Cost: 500 coins</p>
                                <p>Chance for legendary items</p>
                                <button class="btn btn-primary open-lootbox-btn" data-tier="gold">Open Gold Box</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shop Tab -->
            <div class="tab-pane fade" id="shop" role="tabpanel">
                <ul class="nav nav-tabs mb-4" id="shopTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pets-tab" data-bs-toggle="tab" data-bs-target="#shop-pets" type="button" role="tab">Pets</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="knives-tab" data-bs-toggle="tab" data-bs-target="#shop-knives" type="button" role="tab">Knives</button>
                    </li>
                </ul>
                <div class="tab-content" id="shopTabContent">
                    <div class="tab-pane fade show active" id="shop-pets" role="tabpanel">
                        <div class="row" id="shop-pets-container">
                            <!-- Pets will be loaded here -->
                        </div>
                    </div>
                    <div class="tab-pane fade" id="shop-knives" role="tabpanel">
                        <div class="row" id="shop-knives-container">
                            <!-- Knives will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div class="tab-pane fade" id="inventory" role="tabpanel">
                <ul class="nav nav-tabs mb-4" id="inventoryTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="inventory-pets-tab" data-bs-toggle="tab" data-bs-target="#inventory-pets" type="button" role="tab">Pets</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="inventory-knives-tab" data-bs-toggle="tab" data-bs-target="#inventory-knives" type="button" role="tab">Knives</button>
                    </li>
                </ul>
                <div class="tab-content" id="inventoryTabContent">
                    <div class="tab-pane fade show active" id="inventory-pets" role="tabpanel">
                        <div class="row" id="pets-inventory">
                            <!-- Pets inventory will be loaded here -->
                        </div>
                    </div>
                    <div class="tab-pane fade" id="inventory-knives" role="tabpanel">
                        <div class="row" id="knives-inventory">
                            <!-- Knives inventory will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gamble Tab -->
            <div class="tab-pane fade" id="gamble" role="tabpanel">
                <div class="row justify-content-center">
                    <div class="col-md-8 text-center">
                        <div class="card">
                            <div class="card-body">
                                <h3 class="mb-4">Wheel of Fortune</h3>
                                <p>Spin the wheel to win coins or lose some!</p>
                                
                                <div class="wheel-container mb-4">
                                    <div class="wheel-pointer"></div>
                                    <div class="wheel" id="wheel">
                                        <!-- Wheel sections will be added dynamically -->
                                    </div>
                                    <div class="wheel-center">SPIN</div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="bet-amount" class="form-label">Bet Amount (10-1000 coins)</label>
                                    <input type="range" class="form-range" id="bet-amount" min="10" max="1000" step="10" value="50">
                                    <div class="d-flex justify-content-between">
                                        <span>10</span>
                                        <span id="current-bet">50</span>
                                        <span>1000</span>
                                    </div>
                                </div>
                                
                                <button id="spin-wheel-btn" class="btn btn-primary btn-lg">Spin for <span id="bet-amount-display">50</span> coins</button>
                                
                                <div class="mt-4">
                                    <h5>Possible Outcomes:</h5>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="badge bg-danger mb-2">Lose All</div>
                                            <p>10% chance</p>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="badge bg-warning mb-2">Lose Half</div>
                                            <p>20% chance</p>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="badge bg-success mb-2">Win 1x</div>
                                            <p>40% chance</p>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="badge bg-primary mb-2">Win 2x</div>
                                            <p>30% chance</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blackjack Tab -->
            <div class="tab-pane fade" id="blackjack" role="tabpanel">
                <div class="row justify-content-center">
                    <div class="col-md-8 text-center">
                        <div class="card">
                            <div class="card-body">
                                <h3 class="mb-4">Blackjack</h3>
                                <p>Try to beat the dealer without going over 21!</p>
                                
                                <div class="game-container mb-4">
                                    <div class="dealer-area mb-4">
                                        <h5>Dealer's Hand (<span id="dealer-score">?</span>)</h5>
                                        <div id="dealer-cards" class="cards-container"></div>
                                    </div>
                                    
                                    <div class="player-area">
                                        <h5>Your Hand (<span id="player-score">0</span>)</h5>
                                        <div id="player-cards" class="cards-container"></div>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="blackjack-bet" class="form-label">Bet Amount (10-1000 coins)</label>
                                    <input type="range" class="form-range" id="blackjack-bet" min="10" max="1000" step="10" value="50">
                                    <div class="d-flex justify-content-between">
                                        <span>10</span>
                                        <span id="current-blackjack-bet">50</span>
                                        <span>1000</span>
                                    </div>
                                </div>
                                
                                <div id="game-controls" class="d-none">
                                    <button id="hit-btn" class="btn btn-primary me-2">Hit</button>
                                    <button id="stand-btn" class="btn btn-warning me-2">Stand</button>
                                    <button id="double-btn" class="btn btn-success me-2">Double</button>
                                </div>
                                
                                <button id="start-blackjack-btn" class="btn btn-primary btn-lg">Start Game for <span id="blackjack-bet-display">50</span> coins</button>
                                <button id="play-again-btn" class="btn btn-success btn-lg d-none">Play Again</button>
                                
                                <div class="mt-3" id="game-result"></div>
                                
                                <div class="mt-4">
                                    <h5>Payouts:</h5>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="badge bg-success mb-2">Win</div>
                                            <p>2x bet</p>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="badge bg-primary mb-2">Blackjack</div>
                                            <p>2.5x bet</p>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="badge bg-info mb-2">Push</div>
                                            <p>Return bet</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trade Tab -->
            <div class="tab-pane fade" id="trade" role="tabpanel">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Online Players</h5>
                                <div id="online-users-list" class="list-group">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p>Loading online players...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Your Offer</h5>
                                <div class="mb-3">
                                    <label for="offer-coins" class="form-label">Coins to Offer</label>
                                    <input type="number" class="form-control" id="offer-coins" min="0" :max="userData.coins" value="0">
                                </div>
                                <div class="trade-slot" id="offer-pets-slot">
                                    <p class="text-muted mb-0">Drag pets here</p>
                                </div>
                                <div class="trade-slot" id="offer-knives-slot">
                                    <p class="text-muted mb-0">Drag knives here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                <div id="trade-status" class="trade-status pending d-none">
                                    Trade Status
                                </div>
                                <h5 class="mb-3">Trade with <span id="trade-partner-name">Player</span></h5>
                                
                                <div class="d-flex justify-content-center mb-4">
                                    <div class="text-center me-4">
                                        <h6>You Give</h6>
                                        <div id="offer-summary" class="text-start">
                                            <!-- Offer summary will be shown here -->
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <h6>You Get</h6>
                                        <div id="request-summary" class="text-start">
                                            <!-- Request summary will be shown here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-center">
                                    <button id="send-trade-btn" class="btn btn-primary me-2">Send Trade</button>
                                    <button id="accept-trade-btn" class="btn btn-success me-2 d-none">Accept</button>
                                    <button id="reject-trade-btn" class="btn btn-danger d-none">Reject</button>
                                    <button id="cancel-trade-btn" class="btn btn-secondary d-none">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Their Request</h5>
                                <div class="mb-3">
                                    <label for="request-coins" class="form-label">Coins They Want</label>
                                    <input type="number" class="form-control" id="request-coins" min="0" value="0" disabled>
                                </div>
                                <div class="trade-slot" id="request-pets-slot">
                                    <p class="text-muted mb-0">They want these pets</p>
                                </div>
                                <div class="trade-slot" id="request-knives-slot">
                                    <p class="text-muted mb-0">They want these knives</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reward Modal -->
    <div class="modal fade" id="rewardModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">You Received!</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="reward-image" src="" class="img-fluid mb-3 reward-animation" style="max-height: 200px;">
                    <span id="reward-rarity-badge" class="badge mb-2">Common</span>
                    <h4 id="reward-name">Item Name</h4>
                    <p id="reward-description">Item description goes here</p>
                    <button id="sell-reward-btn" class="btn btn-danger">Sell for <span id="sell-price">0</span> coins</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalTitle">Confirm Action</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationModalBody">
                    Are you sure you want to perform this action?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmActionBtn" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Confirmation Modal -->
    <div class="modal fade" id="tradeConfirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Trade Confirmation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>You Give:</h6>
                            <div id="trade-confirm-offer"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>You Get:</h6>
                            <div id="trade-confirm-request"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmTradeBtn" class="btn btn-primary">Confirm Trade</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
            authDomain: "fusioncya-cc20a.firebaseapp.com",
            databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
            projectId: "fusioncya-cc20a",
            storageBucket: "fusioncya-cc20a.appspot.com",
            messagingSenderId: "765164293111",
            appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
            measurementId: "G-4DT52P7MPB"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const provider = new firebase.auth.GoogleAuthProvider();

        // Game Data
        const ITEMS = {
            pets: {
                common: [
                    { id: 'pet1', name: 'Common Cat', value: 50, image: 'https://via.placeholder.com/150?text=Common+Cat', description: 'A cute common cat companion' },
                    { id: 'pet2', name: 'Common Dog', value: 50, image: 'https://via.placeholder.com/150?text=Common+Dog', description: 'A loyal common dog companion' },
                    { id: 'pet3', name: 'Common Bird', value: 50, image: 'https://via.placeholder.com/150?text=Common+Bird', description: 'A cheerful common bird companion' }
                ],
                rare: [
                    { id: 'pet4', name: 'Rare Fox', value: 150, image: 'https://via.placeholder.com/150?text=Rare+Fox', description: 'A clever rare fox companion' },
                    { id: 'pet5', name: 'Rare Rabbit', value: 150, image: 'https://via.placeholder.com/150?text=Rare+Rabbit', description: 'A quick rare rabbit companion' }
                ],
                epic: [
                    { id: 'pet6', name: 'Epic Dragon', value: 300, image: 'https://via.placeholder.com/150?text=Epic+Dragon', description: 'A majestic epic dragon companion' },
                    { id: 'pet7', name: 'Epic Unicorn', value: 300, image: 'https://via.placeholder.com/150?text=Epic+Unicorn', description: 'A magical epic unicorn companion' }
                ],
                legendary: [
                    { id: 'pet8', name: 'Legendary Phoenix', value: 500, image: 'https://via.placeholder.com/150?text=Legendary+Phoenix', description: 'A fiery legendary phoenix companion' },
                    { id: 'pet9', name: 'Legendary Griffin', value: 500, image: 'https://via.placeholder.com/150?text=Legendary+Griffin', description: 'A powerful legendary griffin companion' }
                ]
            },
            knives: {
                common: [
                    { id: 'knife1', name: 'Common Dagger', value: 40, image: 'https://via.placeholder.com/150?text=Common+Dagger', description: 'A basic common dagger' },
                    { id: 'knife2', name: 'Common Knife', value: 40, image: 'https://via.placeholder.com/150?text=Common+Knife', description: 'A standard common knife' }
                ],
                rare: [
                    { id: 'knife3', name: 'Rare Bowie', value: 120, image: 'https://via.placeholder.com/150?text=Rare+Bowie', description: 'A sharp rare bowie knife' },
                    { id: 'knife4', name: 'Rare Karambit', value: 120, image: 'https://via.placeholder.com/150?text=Rare+Karambit', description: 'A curved rare karambit' }
                ],
                epic: [
                    { id: 'knife5', name: 'Epic Butterfly', value: 250, image: 'https://via.placeholder.com/150?text=Epic+Butterfly', description: 'A flashy epic butterfly knife' },
                    { id: 'knife6', name: 'Epic Katana', value: 250, image: 'https://via.placeholder.com/150?text=Epic+Katana', description: 'A sleek epic katana' }
                ],
                legendary: [
                    { id: 'knife7', name: 'Legendary Sword', value: 400, image: 'https://via.placeholder.com/150?text=Legendary+Sword', description: 'An ancient legendary sword' },
                    { id: 'knife8', name: 'Legendary Scythe', value: 400, image: 'https://via.placeholder.com/150?text=Legendary+Scythe', description: 'A deadly legendary scythe' }
                ]
            }
        };

        const LOOT_BOXES = {
            free: {
                name: "Free Box",
                cost: 0,
                image: "https://via.placeholder.com/200x150?text=Free+Box",
                rewards: {
                    pets: { common: 70, rare: 25, epic: 5, legendary: 0 },
                    knives: { common: 70, rare: 25, epic: 5, legendary: 0 },
                    coins: { min: 10, max: 50, chance: 30 }
                }
            },
            bronze: {
                name: "Bronze Box",
                cost: 100,
                image: "https://via.placeholder.com/200x150?text=Bronze+Box",
                rewards: {
                    pets: { common: 50, rare: 35, epic: 10, legendary: 5 },
                    knives: { common: 50, rare: 35, epic: 10, legendary: 5 },
                    coins: { min: 25, max: 75, chance: 40 }
                }
            },
            silver: {
                name: "Silver Box",
                cost: 250,
                image: "https://via.placeholder.com/200x150?text=Silver+Box",
                rewards: {
                    pets: { common: 20, rare: 50, epic: 25, legendary: 5 },
                    knives: { common: 20, rare: 50, epic: 25, legendary: 5 },
                    coins: { min: 50, max: 100, chance: 50 }
                }
            },
            gold: {
                name: "Gold Box",
                cost: 500,
                image: "https://via.placeholder.com/200x150?text=Gold+Box",
                rewards: {
                    pets: { common: 0, rare: 30, epic: 50, legendary: 20 },
                    knives: { common: 0, rare: 30, epic: 50, legendary: 20 },
                    coins: { min: 75, max: 150, chance: 60 }
                }
            }
        };

        // Wheel configuration
        const WHEEL_SECTIONS = [
            { text: "Lose All", color: "#dc3545", multiplier: -1, probability: 10 },
            { text: "Lose Half", color: "#fd7e14", multiplier: -0.5, probability: 20 },
            { text: "Win 1x", color: "#28a745", multiplier: 1, probability: 40 },
            { text: "Win 2x", color: "#007bff", multiplier: 2, probability: 30 }
        ];

        // Blackjack configuration
        const CARD_VALUES = {
            '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10,
            'J': 10, 'Q': 10, 'K': 10, 'A': 11
        };

        const CARD_SUITS = ['hearts', 'diamonds', 'clubs', 'spades'];
        const CARD_RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

        // Game State
        let userData = {
            coins: 0,
            streak: 0,
            lastClaim: null,
            inventory: {
                pets: [],
                knives: []
            },
            lastFreeBox: null
        };

        // Blackjack game state
        let blackjackGame = {
            deck: [],
            playerHand: [],
            dealerHand: [],
            currentBet: 0,
            gameActive: false,
            doubled: false
        };

        // Trade state
        let tradeState = {
            partnerId: null,
            partnerName: null,
            offer: {
                coins: 0,
                pets: [],
                knives: []
            },
            request: {
                coins: 0,
                pets: [],
                knives: []
            },
            tradeId: null,
            isInitiator: false,
            tradeListener: null
        };

        // DOM Elements
        const elements = {
            signInButton: document.getElementById('signInButton'),
            signInButton2: document.getElementById('signInButton2'),
            signOutButton: document.getElementById('signOutButton'),
            usernameDisplay: document.getElementById('username-display'),
            profilePic: document.getElementById('profile-pic'),
            loginView: document.getElementById('login-view'),
            dashboardView: document.getElementById('dashboard-view'),
            dashboardUsername: document.getElementById('dashboard-username'),
            updateUsernameBtn: document.getElementById('update-username-btn'),
            newUsernameInput: document.getElementById('new-username'),
            profilePicUpload: document.getElementById('profile-pic-upload'),
            uploadProfilePicBtn: document.getElementById('upload-profile-pic-btn'),
            updateProfilePicBtn: document.getElementById('update-profile-pic-btn'),
            profilePicPreview: document.getElementById('profile-pic-preview'),
            coinBalance: document.getElementById('coin-balance'),
            claimDailyBtn: document.getElementById('claim-daily-btn'),
            currentStreak: document.getElementById('current-streak'),
            streakProgress: document.getElementById('streak-progress'),
            nextStreakReward: document.getElementById('next-streak-reward'),
            freeBoxTimer: document.getElementById('free-box-timer'),
            petsInventory: document.getElementById('pets-inventory'),
            knivesInventory: document.getElementById('knives-inventory'),
            shopPets: document.getElementById('shop-pets-container'),
            shopKnives: document.getElementById('shop-knives-container'),
            rewardModal: new bootstrap.Modal(document.getElementById('rewardModal')),
            rewardImage: document.getElementById('reward-image'),
            rewardName: document.getElementById('reward-name'),
            rewardDescription: document.getElementById('reward-description'),
            rewardRarityBadge: document.getElementById('reward-rarity-badge'),
            sellRewardBtn: document.getElementById('sell-reward-btn'),
            sellPrice: document.getElementById('sell-price'),
            confirmationModal: new bootstrap.Modal(document.getElementById('confirmationModal')),
            confirmationModalTitle: document.getElementById('confirmationModalTitle'),
            confirmationModalBody: document.getElementById('confirmationModalBody'),
            confirmActionBtn: document.getElementById('confirmActionBtn'),
            wheel: document.getElementById('wheel'),
            betAmount: document.getElementById('bet-amount'),
            currentBet: document.getElementById('current-bet'),
            betAmountDisplay: document.getElementById('bet-amount-display'),
            spinWheelBtn: document.getElementById('spin-wheel-btn'),
            // Blackjack elements
            dealerCards: document.getElementById('dealer-cards'),
            playerCards: document.getElementById('player-cards'),
            dealerScore: document.getElementById('dealer-score'),
            playerScore: document.getElementById('player-score'),
            blackjackBet: document.getElementById('blackjack-bet'),
            currentBlackjackBet: document.getElementById('current-blackjack-bet'),
            blackjackBetDisplay: document.getElementById('blackjack-bet-display'),
            gameControls: document.getElementById('game-controls'),
            hitBtn: document.getElementById('hit-btn'),
            standBtn: document.getElementById('stand-btn'),
            doubleBtn: document.getElementById('double-btn'),
            startBlackjackBtn: document.getElementById('start-blackjack-btn'),
            playAgainBtn: document.getElementById('play-again-btn'),
            gameResult: document.getElementById('game-result'),
            // Trade elements
            onlineUsersList: document.getElementById('online-users-list'),
            offerCoins: document.getElementById('offer-coins'),
            offerPetsSlot: document.getElementById('offer-pets-slot'),
            offerKnivesSlot: document.getElementById('offer-knives-slot'),
            requestCoins: document.getElementById('request-coins'),
            requestPetsSlot: document.getElementById('request-pets-slot'),
            requestKnivesSlot: document.getElementById('request-knives-slot'),
            tradePartnerName: document.getElementById('trade-partner-name'),
            offerSummary: document.getElementById('offer-summary'),
            requestSummary: document.getElementById('request-summary'),
            tradeStatus: document.getElementById('trade-status'),
            sendTradeBtn: document.getElementById('send-trade-btn'),
            acceptTradeBtn: document.getElementById('accept-trade-btn'),
            rejectTradeBtn: document.getElementById('reject-trade-btn'),
            cancelTradeBtn: document.getElementById('cancel-trade-btn'),
            tradeConfirmationModal: new bootstrap.Modal(document.getElementById('tradeConfirmationModal')),
            tradeConfirmOffer: document.getElementById('trade-confirm-offer'),
            tradeConfirmRequest: document.getElementById('trade-confirm-request'),
            confirmTradeBtn: document.getElementById('confirmTradeBtn')
        };

        // Utility Functions
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRandomRarity(probabilities) {
            const total = Object.values(probabilities).reduce((sum, prob) => sum + prob, 0);
            const random = Math.random() * total;
            
            let cumulative = 0;
            for (const [rarity, prob] of Object.entries(probabilities)) {
                cumulative += prob;
                if (random <= cumulative) {
                    return rarity;
                }
            }
            
            return 'common'; // fallback
        }

        function getRandomItem(type, rarity) {
            const items = ITEMS[type][rarity];
            return items[Math.floor(Math.random() * items.length)];
        }

        function getRarityColor(rarity) {
            const colors = {
                common: 'secondary',
                rare: 'primary',
                epic: 'danger',
                legendary: 'warning'
            };
            return colors[rarity] || 'secondary';
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Firebase Functions
        async function createUserDocument(user) {
            const userDoc = {
                uid: user.uid,
                email: user.email,
                username: user.displayName || 'user' + user.uid.substring(0, 4),
                photoBase64: user.photoURL || '',
                coins: 100,
                streak: 0,
                lastClaim: null,
                inventory: {
                    pets: [],
                    knives: []
                },
                lastFreeBox: null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastOnline: firebase.firestore.FieldValue.serverTimestamp(),
                isOnline: true
            };
            
            return db.collection('users').doc(user.uid).set(userDoc);
        }

        async function loadUserData(userId) {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    const data = doc.data();
                    userData = data;
                    
                    // Update UI
                    updateUI();
                    updateInventoryUI();
                    updateShopUI();
                    startFreeBoxTimer();
                    initializeWheel();
                    
                    // Check if daily reward can be claimed
                    checkDailyReward();
                    
                    // Update online status
                    updateOnlineStatus();
                    
                    // Load online users
                    loadOnlineUsers();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        async function updateUserData(data) {
            try {
                await db.collection('users').doc(auth.currentUser.uid).update(data);
                Object.assign(userData, data);
                updateUI();
            } catch (error) {
                console.error("Error updating user data:", error);
            }
        }

        async function addItemToInventory(item, type, quantity = 1) {
            try {
                // Check if item already exists in inventory
                const existingIndex = userData.inventory[type].findIndex(i => i.id === item.id);
                
                if (existingIndex >= 0) {
                    // Item exists, update quantity
                    const updatedInventory = [...userData.inventory[type]];
                    if (!updatedInventory[existingIndex].quantity) {
                        updatedInventory[existingIndex].quantity = 1;
                    }
                    updatedInventory[existingIndex].quantity += quantity;
                    
                    await db.collection('users').doc(auth.currentUser.uid).update({
                        [`inventory.${type}`]: updatedInventory
                    });
                    
                    userData.inventory[type] = updatedInventory;
                } else {
                    // New item, add with quantity
                    const itemWithQuantity = {...item, quantity: quantity};
                    await db.collection('users').doc(auth.currentUser.uid).update({
                        [`inventory.${type}`]: firebase.firestore.FieldValue.arrayUnion(itemWithQuantity)
                    });
                    
                    userData.inventory[type].push(itemWithQuantity);
                }
                
                updateInventoryUI();
            } catch (error) {
                console.error("Error adding item to inventory:", error);
            }
        }

        async function removeItemFromInventory(item, type, quantity = 1) {
            try {
                const existingIndex = userData.inventory[type].findIndex(i => i.id === item.id);
                
                if (existingIndex >= 0) {
                    const updatedInventory = [...userData.inventory[type]];
                    
                    if (updatedInventory[existingIndex].quantity > quantity) {
                        // Reduce quantity
                        updatedInventory[existingIndex].quantity -= quantity;
                        
                        await db.collection('users').doc(auth.currentUser.uid).update({
                            [`inventory.${type}`]: updatedInventory
                        });
                        
                        userData.inventory[type] = updatedInventory;
                    } else {
                        // Remove item completely
                        await db.collection('users').doc(auth.currentUser.uid).update({
                            [`inventory.${type}`]: firebase.firestore.FieldValue.arrayRemove(updatedInventory[existingIndex])
                        });
                        
                        userData.inventory[type] = userData.inventory[type].filter(i => i.id !== item.id);
                    }
                    
                    updateInventoryUI();
                }
            } catch (error) {
                console.error("Error removing item from inventory:", error);
            }
        }

        async function updateOnlineStatus() {
            if (!auth.currentUser) return;
            
            // Set user as online
            await db.collection('users').doc(auth.currentUser.uid).update({
                isOnline: true,
                lastOnline: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update online status periodically
            setInterval(async () => {
                if (auth.currentUser) {
                    await db.collection('users').doc(auth.currentUser.uid).update({
                        lastOnline: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }, 30000); // Every 30 seconds
            
            // Handle window close or page unload
            window.addEventListener('beforeunload', async () => {
                if (auth.currentUser) {
                    await db.collection('users').doc(auth.currentUser.uid).update({
                        isOnline: false
                    });
                }
            });
        }

        // Trade Functions
        async function loadOnlineUsers() {
            if (!auth.currentUser) return;
            
            // Listen for online users
            db.collection('users')
                .where('isOnline', '==', true)
                .where('uid', '!=', auth.currentUser.uid)
                .onSnapshot((snapshot) => {
                    elements.onlineUsersList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        elements.onlineUsersList.innerHTML = `
                            <div class="text-center py-3">
                                <p>No other players online</p>
                            </div>
                        `;
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const userElement = document.createElement('div');
                        userElement.className = 'online-user';
                        userElement.innerHTML = `
                            <div class="d-flex align-items-center">
                                <img src="${user.photoBase64 || 'https://via.placeholder.com/40'}" 
                                     class="rounded-circle me-2" width="30" height="30">
                                <span>${user.username}</span>
                            </div>
                        `;
                        
                        userElement.addEventListener('click', () => {
                            // Remove active class from all users
                            document.querySelectorAll('.online-user').forEach(el => {
                                el.classList.remove('active');
                            });
                            
                            // Add active class to selected user
                            userElement.classList.add('active');
                            
                            // Set trade partner
                            tradeState.partnerId = user.uid;
                            tradeState.partnerName = user.username;
                            elements.tradePartnerName.textContent = user.username;
                            
                            // Reset trade state
                            resetTradeState();
                            
                            // Enable trade controls
                            elements.sendTradeBtn.disabled = false;
                        });
                        
                        elements.onlineUsersList.appendChild(userElement);
                    });
                });
        }

        function resetTradeState() {
            // Clear all trade slots
            elements.offerPetsSlot.innerHTML = '<p class="text-muted mb-0">Drag pets here</p>';
            elements.offerKnivesSlot.innerHTML = '<p class="text-muted mb-0">Drag knives here</p>';
            elements.requestPetsSlot.innerHTML = '<p class="text-muted mb-0">They want these pets</p>';
            elements.requestKnivesSlot.innerHTML = '<p class="text-muted mb-0">They want these knives</p>';
            
            // Reset coin inputs
            elements.offerCoins.value = 0;
            elements.requestCoins.value = 0;
            
            // Clear summaries
            elements.offerSummary.innerHTML = '';
            elements.requestSummary.innerHTML = '';
            
            // Reset trade status
            elements.tradeStatus.className = 'trade-status pending d-none';
            elements.tradeStatus.textContent = '';
            
            // Reset buttons
            elements.sendTradeBtn.classList.remove('d-none');
            elements.acceptTradeBtn.classList.add('d-none');
            elements.rejectTradeBtn.classList.add('d-none');
            elements.cancelTradeBtn.classList.add('d-none');
            
            // Clear trade state
            tradeState.offer = { coins: 0, pets: [], knives: [] };
            tradeState.request = { coins: 0, pets: [], knives: [] };
            tradeState.tradeId = null;
            tradeState.isInitiator = false;
            
            // Remove any existing trade listener
            if (tradeState.tradeListener) {
                tradeState.tradeListener();
                tradeState.tradeListener = null;
            }
            
            // Setup inventory for dragging
            setupInventoryForTrade();
        }

        function setupInventoryForTrade() {
            // Clear any existing draggable items
            document.querySelectorAll('.inventory-item').forEach(el => {
                el.removeEventListener('click', handleInventoryItemClick);
            });
            
            // Make inventory items clickable for trade
            document.querySelectorAll('.inventory-item').forEach(el => {
                el.addEventListener('click', handleInventoryItemClick);
            });
        }

        function handleInventoryItemClick(event) {
            if (!tradeState.partnerId) {
                alert('Please select a trade partner first');
                return;
            }
            
            const itemElement = event.currentTarget;
            const itemId = itemElement.dataset.id;
            const itemType = itemElement.dataset.type;
            
            // Find the item in user's inventory
            const item = userData.inventory[itemType].find(i => i.id === itemId);
            if (!item) return;
            
            // Check if item is already in offer
            const isInOffer = tradeState.offer[itemType].some(i => i.id === itemId);
            
            if (isInOffer) {
                // Remove from offer
                tradeState.offer[itemType] = tradeState.offer[itemType].filter(i => i.id !== itemId);
                
                // Update UI
                if (itemType === 'pets') {
                    elements.offerPetsSlot.innerHTML = tradeState.offer.pets.length > 0 
                        ? tradeState.offer.pets.map(pet => createTradeItemElement(pet, 'pets')).join('')
                        : '<p class="text-muted mb-0">Drag pets here</p>';
                } else {
                    elements.offerKnivesSlot.innerHTML = tradeState.offer.knives.length > 0 
                        ? tradeState.offer.knives.map(knife => createTradeItemElement(knife, 'knives')).join('')
                        : '<p class="text-muted mb-0">Drag knives here</p>';
                }
            } else {
                // Add to offer
                tradeState.offer[itemType].push(item);
                
                // Update UI
                if (itemType === 'pets') {
                    elements.offerPetsSlot.innerHTML = tradeState.offer.pets.map(pet => createTradeItemElement(pet, 'pets')).join('');
                } else {
                    elements.offerKnivesSlot.innerHTML = tradeState.offer.knives.map(knife => createTradeItemElement(knife, 'knives')).join('');
                }
            }
            
            // Update offer summary
            updateTradeSummary();
        }

        function createTradeItemElement(item, type) {
            return `
                <div class="trade-item" data-id="${item.id}" data-type="${type}">
                    <img src="${item.image}" alt="${item.name}" width="60" height="60" class="rounded">
                    <span class="trade-item-remove">&times;</span>
                </div>
            `;
        }

        function updateTradeSummary() {
            // Update offer coins
            tradeState.offer.coins = parseInt(elements.offerCoins.value) || 0;
            
            // Update offer summary
            let offerSummary = '';
            if (tradeState.offer.coins > 0) {
                offerSummary += `<p><i class="fas fa-coins text-warning"></i> ${tradeState.offer.coins} coins</p>`;
            }
            
            if (tradeState.offer.pets.length > 0) {
                offerSummary += tradeState.offer.pets.map(pet => 
                    `<p><img src="${pet.image}" width="20" height="20" class="rounded me-2"> ${pet.name}</p>`
                ).join('');
            }
            
            if (tradeState.offer.knives.length > 0) {
                offerSummary += tradeState.offer.knives.map(knife => 
                    `<p><img src="${knife.image}" width="20" height="20" class="rounded me-2"> ${knife.name}</p>`
                ).join('');
            }
            
            elements.offerSummary.innerHTML = offerSummary || '<p class="text-muted">Nothing</p>';
            
            // Update request summary
            let requestSummary = '';
            if (tradeState.request.coins > 0) {
                requestSummary += `<p><i class="fas fa-coins text-warning"></i> ${tradeState.request.coins} coins</p>`;
            }
            
            if (tradeState.request.pets.length > 0) {
                requestSummary += tradeState.request.pets.map(pet => 
                    `<p><img src="${pet.image}" width="20" height="20" class="rounded me-2"> ${pet.name}</p>`
                ).join('');
            }
            
            if (tradeState.request.knives.length > 0) {
                requestSummary += tradeState.request.knives.map(knife => 
                    `<p><img src="${knife.image}" width="20" height="20" class="rounded me-2"> ${knife.name}</p>`
                ).join('');
            }
            
            elements.requestSummary.innerHTML = requestSummary || '<p class="text-muted">Nothing</p>';
        }

        function sendTradeRequest() {
            if (!tradeState.partnerId) {
                alert('Please select a trade partner first');
                return;
            }
            
            if (tradeState.offer.coins === 0 && tradeState.offer.pets.length === 0 && tradeState.offer.knives.length === 0) {
                alert('Please add items or coins to your offer');
                return;
            }
            
            // Check if user has enough coins
            if (tradeState.offer.coins > userData.coins) {
                alert('You don\'t have enough coins for this trade');
                return;
            }
            
            // Check if user still has the items they're offering
            for (const pet of tradeState.offer.pets) {
                const inventoryPet = userData.inventory.pets.find(p => p.id === pet.id);
                if (!inventoryPet) {
                    alert(`You no longer have ${pet.name} in your inventory`);
                    return;
                }
            }
            
            for (const knife of tradeState.offer.knives) {
                const inventoryKnife = userData.inventory.knives.find(k => k.id === knife.id);
                if (!inventoryKnife) {
                    alert(`You no longer have ${knife.name} in your inventory`);
                    return;
                }
            }
            
            // Show confirmation modal
            showTradeConfirmation();
        }

        function showTradeConfirmation() {
            // Update confirmation modal content
            let offerContent = '';
            if (tradeState.offer.coins > 0) {
                offerContent += `<p><i class="fas fa-coins text-warning"></i> ${tradeState.offer.coins} coins</p>`;
            }
            
            if (tradeState.offer.pets.length > 0) {
                offerContent += tradeState.offer.pets.map(pet => 
                    `<p><img src="${pet.image}" width="30" height="30" class="rounded me-2"> ${pet.name}</p>`
                ).join('');
            }
            
            if (tradeState.offer.knives.length > 0) {
                offerContent += tradeState.offer.knives.map(knife => 
                    `<p><img src="${knife.image}" width="30" height="30" class="rounded me-2"> ${knife.name}</p>`
                ).join('');
            }
            
            elements.tradeConfirmOffer.innerHTML = offerContent || '<p class="text-muted">Nothing</p>';
            
            let requestContent = '';
            if (tradeState.request.coins > 0) {
                requestContent += `<p><i class="fas fa-coins text-warning"></i> ${tradeState.request.coins} coins</p>`;
            }
            
            if (tradeState.request.pets.length > 0) {
                requestContent += tradeState.request.pets.map(pet => 
                    `<p><img src="${pet.image}" width="30" height="30" class="rounded me-2"> ${pet.name}</p>`
                ).join('');
            }
            
            if (tradeState.request.knives.length > 0) {
                requestContent += tradeState.request.knives.map(knife => 
                    `<p><img src="${knife.image}" width="30" height="30" class="rounded me-2"> ${knife.name}</p>`
                ).join('');
            }
            
            elements.tradeConfirmRequest.innerHTML = requestContent || '<p class="text-muted">Nothing</p>';
            
            // Show modal
            elements.tradeConfirmationModal.show();
        }

        async function createTrade() {
            // Create trade document
            const tradeData = {
                initiator: auth.currentUser.uid,
                recipient: tradeState.partnerId,
                offer: tradeState.offer,
                request: tradeState.request,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                const tradeRef = await db.collection('trades').add(tradeData);
                tradeState.tradeId = tradeRef.id;
                tradeState.isInitiator = true;
                
                // Update UI
                elements.sendTradeBtn.classList.add('d-none');
                elements.cancelTradeBtn.classList.remove('d-none');
                elements.tradeStatus.className = 'trade-status pending';
                elements.tradeStatus.textContent = 'Trade pending';
                
                // Listen for trade updates
                setupTradeListener();
                
                // Close confirmation modal
                elements.tradeConfirmationModal.hide();
                
                // Show success message
                Swal.fire({
                    title: 'Trade Sent',
                    text: 'Your trade offer has been sent successfully',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } catch (error) {
                console.error('Error creating trade:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to send trade offer',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        function setupTradeListener() {
            if (!tradeState.tradeId) return;
            
            tradeState.tradeListener = db.collection('trades').doc(tradeState.tradeId)
                .onSnapshot((doc) => {
                    if (!doc.exists) return;
                    
                    const trade = doc.data();
                    
                    // Update trade status
                    if (trade.status === 'accepted') {
                        // Trade accepted - complete it
                        completeTrade();
                    } else if (trade.status === 'rejected') {
                        // Trade rejected
                        elements.tradeStatus.className = 'trade-status rejected';
                        elements.tradeStatus.textContent = 'Trade rejected';
                        elements.cancelTradeBtn.classList.add('d-none');
                        
                        Swal.fire({
                            title: 'Trade Rejected',
                            text: 'The other player rejected your trade offer',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    } else if (trade.status === 'cancelled') {
                        // Trade cancelled
                        elements.tradeStatus.className = 'trade-status rejected';
                        elements.tradeStatus.textContent = 'Trade cancelled';
                        elements.cancelTradeBtn.classList.add('d-none');
                        
                        Swal.fire({
                            title: 'Trade Cancelled',
                            text: 'The other player cancelled the trade',
                            icon: 'info',
                            confirmButtonText: 'OK'
                        });
                    }
                });
        }

        async function listenForIncomingTrades() {
            if (!auth.currentUser) return;
            
            db.collection('trades')
                .where('recipient', '==', auth.currentUser.uid)
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const trade = change.doc.data();
                            
                            // Show trade offer notification
                            Swal.fire({
                                title: 'New Trade Offer',
                                html: `You have a new trade offer from <b>${trade.initiatorName || 'a player'}</b>`,
                                icon: 'info',
                                showCancelButton: true,
                                confirmButtonText: 'View Trade',
                                cancelButtonText: 'Ignore'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    // Switch to trade tab
                                    const tradeTab = document.getElementById('trade-tab');
                                    const tab = new bootstrap.Tab(tradeTab);
                                    tab.show();
                                    
                                    // Load trade details
                                    loadIncomingTrade(change.doc.id, trade);
                                }
                            });
                        }
                    });
                });
        }

        function loadIncomingTrade(tradeId, tradeData) {
            // Reset trade state
            resetTradeState();
            
            // Set trade state
            tradeState.tradeId = tradeId;
            tradeState.partnerId = tradeData.initiator;
            tradeState.partnerName = tradeData.initiatorName || 'Player';
            tradeState.isInitiator = false;
            
            // Set trade details
            tradeState.offer = tradeData.request; // What we're getting
            tradeState.request = tradeData.offer; // What we're giving
            
            // Update UI
            elements.tradePartnerName.textContent = tradeState.partnerName;
            
            // Show what we're giving (their request)
            if (tradeState.request.coins > 0) {
                elements.requestCoins.value = tradeState.request.coins;
            }
            
            if (tradeState.request.pets.length > 0) {
                elements.requestPetsSlot.innerHTML = tradeState.request.pets.map(pet => 
                    createTradeItemElement(pet, 'pets')
                ).join('');
            }
            
            if (tradeState.request.knives.length > 0) {
                elements.requestKnivesSlot.innerHTML = tradeState.request.knives.map(knife => 
                    createTradeItemElement(knife, 'knives')
                ).join('');
            }
            
            // Show what we're getting (their offer)
            if (tradeState.offer.coins > 0) {
                elements.offerCoins.value = tradeState.offer.coins;
            }
            
            if (tradeState.offer.pets.length > 0) {
                elements.offerPetsSlot.innerHTML = tradeState.offer.pets.map(pet => 
                    createTradeItemElement(pet, 'pets')
                ).join('');
            }
            
            if (tradeState.offer.knives.length > 0) {
                elements.offerKnivesSlot.innerHTML = tradeState.offer.knives.map(knife => 
                    createTradeItemElement(knife, 'knives')
                ).join('');
            }
            
            // Update summaries
            updateTradeSummary();
            
            // Show accept/reject buttons
            elements.sendTradeBtn.classList.add('d-none');
            elements.acceptTradeBtn.classList.remove('d-none');
            elements.rejectTradeBtn.classList.remove('d-none');
            elements.tradeStatus.className = 'trade-status pending';
            elements.tradeStatus.textContent = 'Trade offer received';
            
            // Setup trade listener
            setupTradeListener();
        }

        async function acceptTrade() {
            // Check if user has enough coins
            if (tradeState.request.coins > userData.coins) {
                alert('You don\'t have enough coins for this trade');
                return;
            }
            
            // Check if user still has the requested items
            for (const pet of tradeState.request.pets) {
                const inventoryPet = userData.inventory.pets.find(p => p.id === pet.id);
                if (!inventoryPet) {
                    alert(`You no longer have ${pet.name} in your inventory`);
                    return;
                }
            }
            
            for (const knife of tradeState.request.knives) {
                const inventoryKnife = userData.inventory.knives.find(k => k.id === knife.id);
                if (!inventoryKnife) {
                    alert(`You no longer have ${knife.name} in your inventory`);
                    return;
                }
            }
            
            // Update trade status
            try {
                await db.collection('trades').doc(tradeState.tradeId).update({
                    status: 'accepted',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // The trade listener will handle the completion
            } catch (error) {
                console.error('Error accepting trade:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to accept trade',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        async function rejectTrade() {
            try {
                await db.collection('trades').doc(tradeState.tradeId).update({
                    status: 'rejected',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update UI
                elements.tradeStatus.className = 'trade-status rejected';
                elements.tradeStatus.textContent = 'Trade rejected';
                elements.acceptTradeBtn.classList.add('d-none');
                elements.rejectTradeBtn.classList.add('d-none');
            } catch (error) {
                console.error('Error rejecting trade:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to reject trade',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        async function cancelTrade() {
            try {
                await db.collection('trades').doc(tradeState.tradeId).update({
                    status: 'cancelled',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update UI
                elements.tradeStatus.className = 'trade-status rejected';
                elements.tradeStatus.textContent = 'Trade cancelled';
                elements.cancelTradeBtn.classList.add('d-none');
            } catch (error) {
                console.error('Error cancelling trade:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to cancel trade',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        async function completeTrade() {
            try {
                // Get the latest trade data
                const tradeDoc = await db.collection('trades').doc(tradeState.tradeId).get();
                if (!tradeDoc.exists) return;
                
                const trade = tradeDoc.data();
                
                // Get both users' data
                const [initiatorData, recipientData] = await Promise.all([
                    db.collection('users').doc(trade.initiator).get(),
                    db.collection('users').doc(trade.recipient).get()
                ]);
                
                if (!initiatorData.exists || !recipientData.exists) {
                    throw new Error('User data not found');
                }
                
                const initiator = initiatorData.data();
                const recipient = recipientData.data();
                
                // Prepare batch for atomic updates
                const batch = db.batch();
                
                // Update initiator's inventory and coins
                let initiatorUpdates = {};
                
                // Add requested items to initiator
                if (trade.request.pets.length > 0) {
                    initiatorUpdates['inventory.pets'] = firebase.firestore.FieldValue.arrayUnion(...trade.request.pets);
                }
                
                if (trade.request.knives.length > 0) {
                    initiatorUpdates['inventory.knives'] = firebase.firestore.FieldValue.arrayUnion(...trade.request.knives);
                }
                
                // Add coins
                initiatorUpdates['coins'] = initiator.coins + trade.request.coins - trade.offer.coins;
                
                // Remove offered items from initiator
                if (trade.offer.pets.length > 0) {
                    for (const pet of trade.offer.pets) {
                        batch.update(db.collection('users').doc(trade.initiator), {
                            'inventory.pets': firebase.firestore.FieldValue.arrayRemove(pet)
                        });
                    }
                }
                
                if (trade.offer.knives.length > 0) {
                    for (const knife of trade.offer.knives) {
                        batch.update(db.collection('users').doc(trade.initiator), {
                            'inventory.knives': firebase.firestore.FieldValue.arrayRemove(knife)
                        });
                    }
                }
                
                batch.update(db.collection('users').doc(trade.initiator), initiatorUpdates);
                
                // Update recipient's inventory and coins
                let recipientUpdates = {};
                
                // Add offered items to recipient
                if (trade.offer.pets.length > 0) {
                    recipientUpdates['inventory.pets'] = firebase.firestore.FieldValue.arrayUnion(...trade.offer.pets);
                }
                
                if (trade.offer.knives.length > 0) {
                    recipientUpdates['inventory.knives'] = firebase.firestore.FieldValue.arrayUnion(...trade.offer.knives);
                }
                
                // Add coins
                recipientUpdates['coins'] = recipient.coins + trade.offer.coins - trade.request.coins;
                
                // Remove requested items from recipient
                if (trade.request.pets.length > 0) {
                    for (const pet of trade.request.pets) {
                        batch.update(db.collection('users').doc(trade.recipient), {
                            'inventory.pets': firebase.firestore.FieldValue.arrayRemove(pet)
                        });
                    }
                }
                
                if (trade.request.knives.length > 0) {
                    for (const knife of trade.request.knives) {
                        batch.update(db.collection('users').doc(trade.recipient), {
                            'inventory.knives': firebase.firestore.FieldValue.arrayRemove(knife)
                        });
                    }
                }
                
                batch.update(db.collection('users').doc(trade.recipient), recipientUpdates);
                
                // Update trade status to completed
                batch.update(db.collection('trades').doc(tradeState.tradeId), {
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Commit the batch
                await batch.commit();
                
                // Update UI
                elements.tradeStatus.className = 'trade-status accepted';
                elements.tradeStatus.textContent = 'Trade completed!';
                elements.acceptTradeBtn.classList.add('d-none');
                elements.rejectTradeBtn.classList.add('d-none');
                elements.cancelTradeBtn.classList.add('d-none');
                
                // Show success message
                Swal.fire({
                    title: 'Trade Completed',
                    text: 'The trade was successfully completed',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
                
                // Reload user data to reflect changes
                loadUserData(auth.currentUser.uid);
            } catch (error) {
                console.error('Error completing trade:', error);
                
                // Update trade status to failed
                await db.collection('trades').doc(tradeState.tradeId).update({
                    status: 'failed',
                    error: error.message,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Show error message
                Swal.fire({
                    title: 'Trade Failed',
                    text: 'There was an error completing the trade',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        // Game Functions
        function checkDailyReward() {
            if (!userData.lastClaim) {
                elements.claimDailyBtn.disabled = false;
                return;
            }
            
            const lastClaim = userData.lastClaim.toDate();
            const now = new Date();
            const diffHours = (now - lastClaim) / (1000 * 60 * 60);
            
            // Reset streak if more than 48 hours since last claim
            if (diffHours > 48) {
                updateUserData({ streak: 0 });
            }
            
            // Enable button if more than 24 hours since last claim
            elements.claimDailyBtn.disabled = diffHours < 24;
        }

        async function claimDailyReward() {
            const now = new Date();
            const lastClaim = userData.lastClaim ? userData.lastClaim.toDate() : null;
            const diffDays = lastClaim ? (now - lastClaim) / (1000 * 60 * 60 * 24) : 0;
            
            let newStreak = userData.streak;
            let coinsToAdd = 50; // base reward
            
            // Increase streak if claimed within 48 hours of last claim
            if (diffDays >= 1 && diffDays <= 2) {
                newStreak += 1;
            } else if (diffDays > 2) {
                newStreak = 1; // reset streak if too much time passed
            } else if (!lastClaim) {
                newStreak = 1; // first claim
            }
            
            // Streak bonus
            if (newStreak >= 7) {
                coinsToAdd += 100; // 7-day streak bonus
            } else if (newStreak >= 3) {
                coinsToAdd += 25; // 3-day streak bonus
            }
            
            // Update user data
            await updateUserData({
                coins: userData.coins + coinsToAdd,
                streak: newStreak,
                lastClaim: firebase.firestore.Timestamp.fromDate(now)
            });
            
            // Show reward
            showReward({
                type: 'coins',
                amount: coinsToAdd,
                message: `Daily Reward (${newStreak} day streak)`
            });
            
            // Disable button until next day
            elements.claimDailyBtn.disabled = true;
        }

        function startFreeBoxTimer() {
            if (!userData.lastFreeBox) {
                // First time, enable free box
                elements.freeBoxTimer.textContent = "Ready!";
                return;
            }
            
            const lastClaim = userData.lastFreeBox.toDate();
            const now = new Date();
            const nextClaim = new Date(lastClaim);
            nextClaim.setDate(nextClaim.getDate() + 1);
            
            if (now >= nextClaim) {
                elements.freeBoxTimer.textContent = "Ready!";
                return;
            }
            
            const updateTimer = () => {
                const now = new Date();
                const diff = nextClaim - now;
                
                if (diff <= 0) {
                    elements.freeBoxTimer.textContent = "Ready!";
                    return;
                }
                
                elements.freeBoxTimer.textContent = formatTime(Math.floor(diff / 1000));
                setTimeout(updateTimer, 1000);
            };
            
            updateTimer();
        }

        function openLootBox(tier) {
            if (tier !== 'free' && userData.coins < LOOT_BOXES[tier].cost) {
                alert("Not enough coins!");
                return;
            }
            
            if (tier === 'free' && userData.lastFreeBox) {
                const lastClaim = userData.lastFreeBox.toDate();
                const now = new Date();
                const nextClaim = new Date(lastClaim);
                nextClaim.setDate(nextClaim.getDate() + 1);
                
                if (now < nextClaim) {
                    alert("You've already claimed your free box today!");
                    return;
                }
            }
            
            // Determine reward type (item or coins)
            const box = LOOT_BOXES[tier];
            const rewardType = Math.random() * 100 < box.rewards.coins.chance ? 'coins' : 
                            Math.random() < 0.5 ? 'pets' : 'knives';
            
            let reward;
            
            if (rewardType === 'coins') {
                const amount = getRandomInt(box.rewards.coins.min, box.rewards.coins.max);
                reward = {
                    type: 'coins',
                    amount: amount,
                    message: `Coins from ${box.name}`
                };
                
                // Add coins immediately
                updateUserData({
                    coins: userData.coins + amount
                });
            } else {
                const rarity = getRandomRarity(box.rewards[rewardType]);
                reward = {
                    type: rewardType,
                    item: getRandomItem(rewardType, rarity),
                    rarity: rarity
                };
                
                // Add item to inventory
                addItemToInventory(reward.item, rewardType);
            }
            
            // Deduct coins if not free box
            if (tier !== 'free') {
                updateUserData({
                    coins: userData.coins - box.cost
                });
            } else {
                // Update last free box time
                updateUserData({
                    lastFreeBox: firebase.firestore.Timestamp.fromDate(new Date())
                });
                startFreeBoxTimer();
            }
            
            // Show reward with animation
            showReward(reward);
            
            // Confetti effect
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        function showReward(reward) {
            if (reward.type === 'coins') {
                elements.rewardImage.src = 'https://via.placeholder.com/150?text=' + reward.amount + '+Coins';
                elements.rewardName.textContent = reward.message;
                elements.rewardDescription.textContent = `You received ${reward.amount} coins!`;
                elements.rewardRarityBadge.className = 'badge bg-warning';
                elements.rewardRarityBadge.textContent = 'Coins';
                elements.sellRewardBtn.style.display = 'none';
            } else {
                elements.rewardImage.src = reward.item.image;
                elements.rewardName.textContent = reward.item.name;
                elements.rewardDescription.textContent = reward.item.description;
                elements.rewardRarityBadge.className = `badge bg-${getRarityColor(reward.rarity)}`;
                elements.rewardRarityBadge.textContent = reward.rarity.charAt(0).toUpperCase() + reward.rarity.slice(1);
                elements.sellRewardBtn.style.display = 'block';
                elements.sellPrice.textContent = Math.floor(reward.item.value * 0.7); // 70% of value
                
                // Set up sell button
                elements.sellRewardBtn.onclick = () => {
                    sellItem(reward.item, reward.type);
                };
            }
            
            elements.rewardModal.show();
        }

        async function sellItem(item, type, quantity = 1) {
            const sellPrice = Math.floor(item.value * 0.7 * quantity); // 70% of value
            
            showConfirmation(
                `Sell ${item.name}${quantity > 1 ? ` (${quantity})` : ''}?`,
                `Are you sure you want to sell ${quantity > 1 ? `${quantity} of this ${type}` : `this ${type}`} for ${sellPrice} coins?`,
                async () => {
                    await updateUserData({
                        coins: userData.coins + sellPrice
                    });
                    await removeItemFromInventory(item, type, quantity);
                    elements.rewardModal.hide();
                }
            );
        }

        function showConfirmation(title, message, callback) {
            elements.confirmationModalTitle.textContent = title;
            elements.confirmationModalBody.textContent = message;
            elements.confirmActionBtn.onclick = () => {
                callback();
                elements.confirmationModal.hide();
            };
            elements.confirmationModal.show();
        }

        // Wheel of Fortune Functions
        function initializeWheel() {
            const wheel = document.getElementById('wheel');
            wheel.innerHTML = ''; // Clear any existing sections
            
            // Create wheel sections
            WHEEL_SECTIONS.forEach((section, index) => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'wheel-section';
                sectionElement.style.backgroundColor = section.color;
                
                // Calculate rotation angle (90deg per section)
                const rotationAngle = index * 90;
                sectionElement.style.transform = `rotate(${rotationAngle}deg) skewY(60deg)`;
                
                // Add text content
                const textDiv = document.createElement('div');
                textDiv.textContent = section.text;
                textDiv.style.transform = 'skewY(-60deg) rotate(30deg)';
                textDiv.style.width = '100px';
                textDiv.style.textAlign = 'center';
                
                sectionElement.appendChild(textDiv);
                wheel.appendChild(sectionElement);
            });
        }

        function spinWheel() {
            const betAmount = parseInt(elements.betAmount.value);
            
            if (userData.coins < betAmount) {
                alert("Not enough coins to place this bet!");
                return;
            }
            
            // Disable button during spin
            elements.spinWheelBtn.disabled = true;
            
            // Randomly select a section based on probabilities
            const totalProbability = WHEEL_SECTIONS.reduce((sum, section) => sum + section.probability, 0);
            const random = Math.random() * totalProbability;
            
            let cumulativeProbability = 0;
            let selectedSection = null;
            let selectedIndex = 0;
            
            for (let i = 0; i < WHEEL_SECTIONS.length; i++) {
                cumulativeProbability += WHEEL_SECTIONS[i].probability;
                if (random <= cumulativeProbability) {
                    selectedSection = WHEEL_SECTIONS[i];
                    selectedIndex = i;
                    break;
                }
            }
            
            // Calculate rotation (multiple full rotations plus the section angle)
            const sectionAngle = 360 / WHEEL_SECTIONS.length;
            const minRotations = 3;
            const maxRotations = 5;
            const rotations = minRotations + Math.random() * (maxRotations - minRotations);
            const targetAngle = 360 * rotations + (360 - (selectedIndex * sectionAngle + sectionAngle / 2));
            
            // Apply rotation
            elements.wheel.style.transform = `rotate(${targetAngle}deg)`;
            
            // Wait for animation to complete
            setTimeout(async () => {
                // Calculate result
                const multiplier = selectedSection.multiplier;
                const coinsWon = Math.floor(betAmount * multiplier);
                const newCoins = userData.coins + coinsWon;
                
                // Update user data
                await updateUserData({
                    coins: newCoins
                });
                
                // Show result
                let resultMessage;
                if (multiplier < 0) {
                    resultMessage = `You lost ${Math.abs(coinsWon)} coins!`;
                } else {
                    resultMessage = `You won ${coinsWon} coins!`;
                }
                
                Swal.fire({
                    title: selectedSection.text,
                    text: resultMessage,
                    icon: multiplier < 0 ? 'error' : 'success',
                    confirmButtonText: 'OK'
                });
                
                // Re-enable button
                elements.spinWheelBtn.disabled = false;
            }, 4000); // Match this with CSS transition duration
        }

        // Blackjack Functions
        function initializeBlackjack() {
            // Event listeners for blackjack controls
            elements.blackjackBet.addEventListener('input', () => {
                elements.currentBlackjackBet.textContent = elements.blackjackBet.value;
                elements.blackjackBetDisplay.textContent = elements.blackjackBet.value;
            });
            
            elements.startBlackjackBtn.addEventListener('click', startBlackjackGame);
            elements.hitBtn.addEventListener('click', hit);
            elements.standBtn.addEventListener('click', stand);
            elements.doubleBtn.addEventListener('click', double);
            elements.playAgainBtn.addEventListener('click', resetBlackjackGame);
        }

        function createDeck() {
            const deck = [];
            for (const suit of CARD_SUITS) {
                for (const rank of CARD_RANKS) {
                    deck.push({
                        rank: rank,
                        suit: suit,
                        value: CARD_VALUES[rank],
                        image: `https://deckofcardsapi.com/static/img/${rank}${suit[0].toUpperCase()}.png`
                    });
                }
            }
            return shuffleDeck(deck);
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        function startBlackjackGame() {
            const betAmount = parseInt(elements.blackjackBet.value);
            
            if (userData.coins < betAmount) {
                alert("Not enough coins to place this bet!");
                return;
            }
            
            // Initialize game state
            blackjackGame = {
                deck: createDeck(),
                playerHand: [],
                dealerHand: [],
                currentBet: betAmount,
                gameActive: true,
                doubled: false
            };
            
            // Deal initial cards
            blackjackGame.playerHand.push(blackjackGame.deck.pop());
            blackjackGame.dealerHand.push(blackjackGame.deck.pop());
            blackjackGame.playerHand.push(blackjackGame.deck.pop());
            blackjackGame.dealerHand.push(blackjackGame.deck.pop());
            
            // Update UI
            updateBlackjackUI();
            
            // Show game controls
            elements.gameControls.classList.remove('d-none');
            elements.startBlackjackBtn.classList.add('d-none');
            elements.playAgainBtn.classList.add('d-none');
            
            // Check for blackjack
            if (calculateHandValue(blackjackGame.playerHand) === 21) {
                endBlackjackGame(true);
            }
        }

        function resetBlackjackGame() {
            // Clear the game board
            elements.dealerCards.innerHTML = '';
            elements.playerCards.innerHTML = '';
            elements.dealerScore.textContent = '?';
            elements.playerScore.textContent = '0';
            elements.gameResult.textContent = '';
            
            // Reset UI elements
            elements.gameControls.classList.add('d-none');
            elements.startBlackjackBtn.classList.remove('d-none');
            elements.playAgainBtn.classList.add('d-none');
            
            // Start a new game
            startBlackjackGame();
        }

        function updateBlackjackUI() {
            // Clear card displays
            elements.playerCards.innerHTML = '';
            elements.dealerCards.innerHTML = '';
            
            // Show player's cards
            blackjackGame.playerHand.forEach(card => {
                const cardElement = createCardElement(card);
                elements.playerCards.appendChild(cardElement);
            });
            
            // Show dealer's cards (hide first card if game is active)
            blackjackGame.dealerHand.forEach((card, index) => {
                if (index === 0 && blackjackGame.gameActive) {
                    const cardBack = document.createElement('div');
                    cardBack.className = 'card-slot card-back';
                    cardBack.textContent = '🂠';
                    elements.dealerCards.appendChild(cardBack);
                } else {
                    const cardElement = createCardElement(card);
                    elements.dealerCards.appendChild(cardElement);
                }
            });
            
            // Update scores
            elements.playerScore.textContent = calculateHandValue(blackjackGame.playerHand);
            
            if (blackjackGame.gameActive) {
                elements.dealerScore.textContent = '?';
            } else {
                elements.dealerScore.textContent = calculateHandValue(blackjackGame.dealerHand);
            }
            
            // Update double button state
            elements.doubleBtn.disabled = userData.coins < blackjackGame.currentBet || blackjackGame.playerHand.length > 2;
        }

        function createCardElement(card) {
            const cardElement = document.createElement('div');
            cardElement.className = 'card-slot';
            
            const img = document.createElement('img');
            img.src = card.image;
            img.alt = `${card.rank} of ${card.suit}`;
            
            cardElement.appendChild(img);
            return cardElement;
        }

        function calculateHandValue(hand) {
            let value = hand.reduce((sum, card) => sum + card.value, 0);
            let aces = hand.filter(card => card.rank === 'A').length;
            
            // Adjust for aces if over 21
            while (value > 21 && aces > 0) {
                value -= 10;
                aces--;
            }
            
            return value;
        }

        function hit() {
            if (!blackjackGame.gameActive) return;
            
            // Deal a card to player
            blackjackGame.playerHand.push(blackjackGame.deck.pop());
            updateBlackjackUI();
            
            // Check for bust
            const playerValue = calculateHandValue(blackjackGame.playerHand);
            if (playerValue > 21) {
                endBlackjackGame(false);
            }
        }

        function stand() {
            if (!blackjackGame.gameActive) return;
            
            blackjackGame.gameActive = false;
            
            // Dealer draws until 17 or higher
            while (calculateHandValue(blackjackGame.dealerHand) < 17) {
                blackjackGame.dealerHand.push(blackjackGame.deck.pop());
            }
            
            updateBlackjackUI();
            determineBlackjackWinner();
        }

        function double() {
            if (!blackjackGame.gameActive || blackjackGame.playerHand.length > 2 || userData.coins < blackjackGame.currentBet) {
                return;
            }
            
            // Double the bet
            blackjackGame.currentBet *= 2;
            blackjackGame.doubled = true;
            
            // Deal one more card and stand
            hit();
            if (blackjackGame.gameActive) { // Player didn't bust
                stand();
            }
        }

        async function endBlackjackGame(playerBlackjack = false) {
            blackjackGame.gameActive = false;
            updateBlackjackUI();
            
            // Hide game controls
            elements.gameControls.classList.add('d-none');
            elements.playAgainBtn.classList.remove('d-none');
            
            if (playerBlackjack) {
                await determineBlackjackWinner(true);
            } else {
                determineBlackjackWinner();
            }
        }

        async function determineBlackjackWinner(playerBlackjack = false) {
            const playerValue = calculateHandValue(blackjackGame.playerHand);
            const dealerValue = calculateHandValue(blackjackGame.dealerHand);
            
            let result = '';
            let coinsWon = 0;
            
            if (playerBlackjack && playerValue === 21 && blackjackGame.playerHand.length === 2) {
                // Player has blackjack
                if (dealerValue === 21 && blackjackGame.dealerHand.length === 2) {
                    // Both have blackjack - push
                    result = 'Push! Both have Blackjack';
                    coinsWon = blackjackGame.currentBet;
                    elements.gameResult.className = 'blackjack-result push';
                } else {
                    // Player wins with blackjack
                    result = 'Blackjack! You win 2.5x';
                    coinsWon = Math.floor(blackjackGame.currentBet * 2.5);
                    elements.gameResult.className = 'blackjack-result win';
                }
            } else if (playerValue > 21) {
                // Player busts
                result = 'Bust! You lose';
                coinsWon = 0;
                elements.gameResult.className = 'blackjack-result lose';
            } else if (dealerValue > 21) {
                // Dealer busts
                result = 'Dealer busts! You win 2x';
                coinsWon = blackjackGame.currentBet * 2;
                elements.gameResult.className = 'blackjack-result win';
            } else if (playerValue > dealerValue) {
                // Player wins
                result = 'You win 2x!';
                coinsWon = blackjackGame.currentBet * 2;
                elements.gameResult.className = 'blackjack-result win';
            } else if (playerValue < dealerValue) {
                // Dealer wins
                result = 'Dealer wins!';
                coinsWon = 0;
                elements.gameResult.className = 'blackjack-result lose';
            } else {
                // Push
                result = 'Push! Bet returned';
                coinsWon = blackjackGame.currentBet;
                elements.gameResult.className = 'blackjack-result push';
            }
            
            elements.gameResult.textContent = result;
            
            // Update coins
            const newCoins = userData.coins - blackjackGame.currentBet + coinsWon;
            await updateUserData({ coins: newCoins });
            
            // Confetti for win
            if (coinsWon > blackjackGame.currentBet) {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        // UI Update Functions
        function updateUI() {
            elements.coinBalance.textContent = userData.coins;
            elements.currentStreak.textContent = userData.streak;
            
            // Streak progress (next reward at 7 days)
            const progress = Math.min(100, (userData.streak % 7) / 7 * 100);
            elements.streakProgress.style.width = `${progress}%`;
            elements.nextStreakReward.textContent = 7 - (userData.streak % 7);
            
            // Update bet amount displays
            elements.betAmountDisplay.textContent = elements.betAmount.value;
            elements.blackjackBetDisplay.textContent = elements.blackjackBet.value;
            
            // Update trade coin inputs max values
            elements.offerCoins.max = userData.coins;
        }

        function updateInventoryUI() {
            // Group inventory items by ID and count quantities
            const groupedPets = groupInventoryItems(userData.inventory.pets);
            const groupedKnives = groupInventoryItems(userData.inventory.knives);
            
            // Pets inventory
            if (groupedPets.length > 0) {
                elements.petsInventory.innerHTML = groupedPets.map(pet => `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <img src="${pet.item.image}" class="card-img-top inventory-item" alt="${pet.item.name}" 
                                 data-id="${pet.item.id}" data-type="pets">
                            <div class="card-body">
                                <h5 class="card-title">${pet.item.name}${pet.quantity > 1 ? ` (${pet.quantity})` : ''}</h5>
                                <p class="card-text">${pet.item.description}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <button class="btn btn-outline-danger sell-item-btn" data-id="${pet.item.id}" data-type="pets" data-quantity="1">
                                        Sell 1 for ${Math.floor(pet.item.value * 0.7)} <i class="fas fa-coins text-warning"></i>
                                    </button>
                                    ${pet.quantity > 1 ? `
                                    <button class="btn btn-outline-danger sell-item-btn" data-id="${pet.item.id}" data-type="pets" data-quantity="${pet.quantity}">
                                        Sell All (${Math.floor(pet.item.value * 0.7 * pet.quantity)}) <i class="fas fa-coins text-warning"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                elements.petsInventory.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No pets in your inventory yet</p>
                    </div>
                `;
            }
            
            // Knives inventory
            if (groupedKnives.length > 0) {
                elements.knivesInventory.innerHTML = groupedKnives.map(knife => `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <img src="${knife.item.image}" class="card-img-top inventory-item" alt="${knife.item.name}" 
                                 data-id="${knife.item.id}" data-type="knives">
                            <div class="card-body">
                                <h5 class="card-title">${knife.item.name}${knife.quantity > 1 ? ` (${knife.quantity})` : ''}</h5>
                                <p class="card-text">${knife.item.description}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <button class="btn btn-outline-danger sell-item-btn" data-id="${knife.item.id}" data-type="knives" data-quantity="1">
                                        Sell 1 for ${Math.floor(knife.item.value * 0.7)} <i class="fas fa-coins text-warning"></i>
                                    </button>
                                    ${knife.quantity > 1 ? `
                                    <button class="btn btn-outline-danger sell-item-btn" data-id="${knife.item.id}" data-type="knives" data-quantity="${knife.quantity}">
                                        Sell All (${Math.floor(knife.item.value * 0.7 * knife.quantity)}) <i class="fas fa-coins text-warning"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                elements.knivesInventory.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No knives in your inventory yet</p>
                    </div>
                `;
            }
            
            // Add event listeners to sell buttons
            document.querySelectorAll('.sell-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const type = btn.dataset.type;
                    const quantity = parseInt(btn.dataset.quantity) || 1;
                    const item = userData.inventory[type].find(i => i.id === id);
                    
                    if (item) {
                        showConfirmation(
                            `Sell ${item.name}${quantity > 1 ? ` (${quantity})` : ''}?`,
                            `Are you sure you want to sell ${quantity > 1 ? `${quantity} of this ${type.slice(0, -1)}` : `this ${type.slice(0, -1)}`} for ${Math.floor(item.value * 0.7 * quantity)} coins?`,
                            async () => {
                                await updateUserData({
                                    coins: userData.coins + Math.floor(item.value * 0.7 * quantity)
                                });
                                await removeItemFromInventory(item, type, quantity);
                            }
                        );
                    }
                });
            });
            
            // Setup inventory for trade
            setupInventoryForTrade();
        }

        function groupInventoryItems(items) {
            const grouped = {};
            
            items.forEach(item => {
                if (!grouped[item.id]) {
                    grouped[item.id] = {
                        item: item,
                        quantity: item.quantity || 1
                    };
                } else {
                    grouped[item.id].quantity += item.quantity || 1;
                }
            });
            
            return Object.values(grouped);
        }

        function updateShopUI() {
            // Pets shop
            elements.shopPets.innerHTML = Object.entries(ITEMS.pets).map(([rarity, pets]) => `
                ${pets.map(pet => `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <img src="${pet.image}" class="card-img-top" alt="${pet.name}">
                            <div class="card-body">
                                <h5 class="card-title">${pet.name}</h5>
                                <span class="badge bg-${getRarityColor(rarity)} mb-2">${rarity.charAt(0).toUpperCase() + rarity.slice(1)}</span>
                                <p class="card-text">${pet.description}</p>
                                <div class="d-flex align-items-center">
                                    <div class="input-group me-2" style="width: 100px;">
                                        <button class="btn btn-outline-secondary minus-btn" type="button" data-id="${pet.id}" data-type="pets">-</button>
                                        <input type="number" class="form-control text-center quantity-input" value="1" min="1" max="99" data-id="${pet.id}" data-type="pets">
                                        <button class="btn btn-outline-secondary plus-btn" type="button" data-id="${pet.id}" data-type="pets">+</button>
                                    </div>
                                    <button class="btn btn-primary buy-item-btn flex-grow-1" data-id="${pet.id}" data-type="pets" ${userData.coins < pet.value ? 'disabled' : ''}>
                                        Buy for ${pet.value} <i class="fas fa-coins text-warning"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `).join('');
            
            // Knives shop
            elements.shopKnives.innerHTML = Object.entries(ITEMS.knives).map(([rarity, knives]) => `
                ${knives.map(knife => `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <img src="${knife.image}" class="card-img-top" alt="${knife.name}">
                            <div class="card-body">
                                <h5 class="card-title">${knife.name}</h5>
                                <span class="badge bg-${getRarityColor(rarity)} mb-2">${rarity.charAt(0).toUpperCase() + rarity.slice(1)}</span>
                                <p class="card-text">${knife.description}</p>
                                <div class="d-flex align-items-center">
                                    <div class="input-group me-2" style="width: 100px;">
                                        <button class="btn btn-outline-secondary minus-btn" type="button" data-id="${knife.id}" data-type="knives">-</button>
                                        <input type="number" class="form-control text-center quantity-input" value="1" min="1" max="99" data-id="${knife.id}" data-type="knives">
                                        <button class="btn btn-outline-secondary plus-btn" type="button" data-id="${knife.id}" data-type="knives">+</button>
                                    </div>
                                    <button class="btn btn-primary buy-item-btn flex-grow-1" data-id="${knife.id}" data-type="knives" ${userData.coins < knife.value ? 'disabled' : ''}>
                                        Buy for ${knife.value} <i class="fas fa-coins text-warning"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `).join('');
            
            // Add event listeners to quantity controls
            document.querySelectorAll('.minus-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = btn.nextElementSibling;
                    if (input.value > 1) {
                        input.value--;
                    }
                });
            });
            
            document.querySelectorAll('.plus-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = btn.previousElementSibling;
                    if (input.value < 99) {
                        input.value++;
                    }
                });
            });
            
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', () => {
                    if (input.value < 1) input.value = 1;
                    if (input.value > 99) input.value = 99;
                });
            });
            
            // Add event listeners to buy buttons
            document.querySelectorAll('.buy-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const type = btn.dataset.type;
                    const quantityInput = btn.parentElement.querySelector('.quantity-input');
                    const quantity = parseInt(quantityInput.value) || 1;
                    
                    // Find item in ITEMS
                    let item;
                    for (const rarity of Object.keys(ITEMS[type])) {
                        const found = ITEMS[type][rarity].find(i => i.id === id);
                        if (found) {
                            item = found;
                            break;
                        }
                    }
                    
                    const totalCost = item.value * quantity;
                    
                    if (item && userData.coins >= totalCost) {
                        showConfirmation(
                            `Buy ${item.name}${quantity > 1 ? ` (${quantity})` : ''}?`,
                            `Are you sure you want to buy ${quantity > 1 ? `${quantity} of this ${type.slice(0, -1)}` : `this ${type.slice(0, -1)}`} for ${totalCost} coins?`,
                            async () => {
                                await updateUserData({
                                    coins: userData.coins - totalCost
                                });
                                await addItemToInventory(item, type, quantity);
                                updateShopUI(); // Refresh shop to update button states
                            }
                        );
                    }
                });
            });
        }

        // Event Listeners
        function setupEventListeners() {
            // Auth
            elements.signInButton.addEventListener('click', signInWithGoogle);
            elements.signInButton2.addEventListener('click', signInWithGoogle);
            
            elements.signOutButton.addEventListener('click', () => {
                auth.signOut();
            });
            
            // Profile
            elements.updateUsernameBtn.addEventListener('click', () => {
                const newUsername = elements.newUsernameInput.value.trim();
                if (newUsername.length < 3) {
                    alert('Username must be at least 3 characters');
                    return;
                }
                
                updateUserData({ username: newUsername })
                    .then(() => {
                        elements.dashboardUsername.textContent = newUsername;
                        elements.usernameDisplay.textContent = newUsername;
                        elements.newUsernameInput.value = '';
                        alert('Username updated!');
                    })
                    .catch((error) => {
                        console.error('Error updating username:', error);
                        alert('Update failed: ' + error.message);
                    });
            });
            
            elements.uploadProfilePicBtn.addEventListener('click', () => {
                elements.profilePicUpload.click();
            });
            
            elements.updateProfilePicBtn.addEventListener('click', () => {
                const file = elements.profilePicUpload.files[0];
                if (!file) {
                    alert('Please select an image first');
                    return;
                }
                
                if (file.size > 500 * 1024) {
                    alert('Image must be smaller than 500KB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64Image = event.target.result;
                    updateUserData({ photoBase64: base64Image })
                        .then(() => {
                            elements.profilePic.src = base64Image;
                            elements.profilePicPreview.src = base64Image;
                            elements.profilePicUpload.value = '';
                            alert('Profile picture updated!');
                        })
                        .catch((error) => {
                            console.error('Error saving image:', error);
                            alert('Upload failed: ' + error.message);
                        });
                };
                reader.readAsDataURL(file);
            });
            
            // Game
            elements.claimDailyBtn.addEventListener('click', claimDailyReward);
            
            // Loot boxes
            document.querySelectorAll('.open-lootbox-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tier = btn.dataset.tier;
                    openLootBox(tier);
                });
            });
            
            // Wheel of fortune
            elements.betAmount.addEventListener('input', () => {
                elements.currentBet.textContent = elements.betAmount.value;
                elements.betAmountDisplay.textContent = elements.betAmount.value;
            });
            
            elements.spinWheelBtn.addEventListener('click', spinWheel);
            
            // Trade
            elements.offerCoins.addEventListener('input', updateTradeSummary);
            elements.sendTradeBtn.addEventListener('click', sendTradeRequest);
            elements.acceptTradeBtn.addEventListener('click', acceptTrade);
            elements.rejectTradeBtn.addEventListener('click', rejectTrade);
            elements.cancelTradeBtn.addEventListener('click', cancelTrade);
            elements.confirmTradeBtn.addEventListener('click', createTrade);
        }
        
        function signInWithGoogle() {
            auth.signInWithPopup(provider)
                .then((result) => {
                    if (result.additionalUserInfo.isNewUser) {
                        return createUserDocument(result.user);
                    }
                })
                .catch((error) => {
                    console.error('Sign in error:', error);
                    alert('Sign in failed: ' + error.message);
                });
        }

        // Auth State Listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                elements.loginView.style.display = 'none';
                elements.dashboardView.classList.remove('d-none');
                elements.signOutButton.classList.remove('d-none');
                
                // Set profile info
                const displayName = user.displayName || 'User';
                elements.usernameDisplay.textContent = displayName;
                elements.dashboardUsername.textContent = displayName;
                
                if (user.photoURL) {
                    elements.profilePic.src = user.photoURL;
                    elements.profilePicPreview.src = user.photoURL;
                }
                
                // Load user data
                loadUserData(user.uid);
                
                // Listen for incoming trades
                listenForIncomingTrades();
            } else {
                // User is signed out
                elements.loginView.style.display = 'block';
                elements.dashboardView.classList.add('d-none');
                elements.signOutButton.classList.add('d-none');
                elements.usernameDisplay.textContent = 'Guest';
                elements.profilePic.src = 'https://via.placeholder.com/40';
                elements.profilePicPreview.src = 'https://via.placeholder.com/150';
                
                // Reset trade state
                resetTradeState();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            initializeWheel();
            initializeBlackjack();
        });
    </script>
</body>
</html>
