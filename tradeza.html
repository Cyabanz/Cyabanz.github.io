<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FusionCYA - Trading</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .trade-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .trade-column {
            flex: 1;
            min-width: 300px;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            background-color: #2a2a2a;
        }
        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .trade-items {
            min-height: 200px;
            border: 1px dashed #555;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .trade-item {
            display: inline-block;
            margin: 5px;
            position: relative;
        }
        .trade-item img {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            border: 2px solid transparent;
        }
        .trade-item.selected img {
            border-color: #0d6efd;
        }
        .trade-item .quantity {
            position: absolute;
            bottom: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        .online-players {
            max-height: 400px;
            overflow-y: auto;
        }
        .player-card {
            cursor: pointer;
            transition: all 0.2s;
        }
        .player-card:hover {
            background-color: #333;
        }
        .player-card.active {
            background-color: #0d6efd;
        }
        .trade-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .trade-pending {
            background-color: #ffc107;
            color: #000;
        }
        .trade-accepted {
            background-color: #198754;
            color: #fff;
        }
        .trade-rejected {
            background-color: #dc3545;
            color: #fff;
        }
        .inventory-item {
            cursor: pointer;
        }
        .inventory-item:hover {
            opacity: 0.8;
        }
        #tradeHistory {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-dark text-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">FusionCYA</a>
            <div class="d-flex align-items-center">
                <span id="username-display" class="me-3">Guest</span>
                <img id="profile-pic" src="https://via.placeholder.com/40" class="rounded-circle me-2" width="40" height="40">
                <button id="signInButton" class="btn btn-primary me-2">Sign In</button>
                <button id="signOutButton" class="btn btn-danger d-none">Sign Out</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="mb-4">Player Trading</h1>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-header bg-secondary">
                        <h5 class="mb-0">Online Players</h5>
                    </div>
                    <div class="card-body online-players" id="onlinePlayers">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-secondary">
                        <h5 class="mb-0">Trade History</h5>
                    </div>
                    <div class="card-body" id="tradeHistory">
                        <div class="text-center py-3">
                            <p>No trade history yet</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-secondary d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Trade Offer</h5>
                        <div id="tradeStatus" class="trade-status d-none"></div>
                    </div>
                    <div class="card-body">
                        <div class="trade-container">
                            <div class="trade-column">
                                <div class="trade-header">
                                    <h6>Your Offer</h6>
                                    <button id="addCoinsBtn" class="btn btn-sm btn-outline-primary">Add Coins</button>
                                </div>
                                <div class="trade-items" id="yourTradeItems"></div>
                                <div class="inventory-section">
                                    <h6>Your Inventory</h6>
                                    <ul class="nav nav-tabs" id="yourInventoryTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="your-pets-tab" data-bs-toggle="tab" data-bs-target="#your-pets" type="button">Pets</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="your-knives-tab" data-bs-toggle="tab" data-bs-target="#your-knives" type="button">Knives</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content py-2" id="yourInventoryContent">
                                        <div class="tab-pane fade show active" id="your-pets" role="tabpanel">
                                            <div class="row" id="yourPetsInventory"></div>
                                        </div>
                                        <div class="tab-pane fade" id="your-knives" role="tabpanel">
                                            <div class="row" id="yourKnivesInventory"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="trade-column">
                                <div class="trade-header">
                                    <h6>Their Offer</h6>
                                    <span id="theirName">Select a player</span>
                                </div>
                                <div class="trade-items" id="theirTradeItems"></div>
                                <div class="inventory-section">
                                    <h6>Their Inventory</h6>
                                    <ul class="nav nav-tabs" id="theirInventoryTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="their-pets-tab" data-bs-toggle="tab" data-bs-target="#their-pets" type="button">Pets</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="their-knives-tab" data-bs-toggle="tab" data-bs-target="#their-knives" type="button">Knives</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content py-2" id="theirInventoryContent">
                                        <div class="tab-pane fade show active" id="their-pets" role="tabpanel">
                                            <div class="row" id="theirPetsInventory"></div>
                                        </div>
                                        <div class="tab-pane fade" id="their-knives" role="tabpanel">
                                            <div class="row" id="theirKnivesInventory"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-center gap-3 mt-4">
                            <button id="sendTradeBtn" class="btn btn-primary" disabled>Send Trade Offer</button>
                            <button id="acceptTradeBtn" class="btn btn-success d-none">Accept Trade</button>
                            <button id="rejectTradeBtn" class="btn btn-danger d-none">Reject Trade</button>
                            <button id="cancelTradeBtn" class="btn btn-secondary d-none">Cancel Trade</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Coins Modal -->
    <div class="modal fade" id="addCoinsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Add Coins to Trade</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="coinsAmount" class="form-label">Amount (Max: <span id="maxCoins">0</span>)</label>
                        <input type="number" class="form-control" id="coinsAmount" min="0" value="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmAddCoinsBtn" class="btn btn-primary">Add Coins</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Confirmation Modal -->
    <div class="modal fade" id="tradeConfirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Trade</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="tradeConfirmationBody">
                    <!-- Content will be filled dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmTradeBtn" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // Firebase Configuration (same as your main app)
        const firebaseConfig = {
            apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
            authDomain: "fusioncya-cc20a.firebaseapp.com",
            databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
            projectId: "fusioncya-cc20a",
            storageBucket: "fusioncya-cc20a.appspot.com",
            messagingSenderId: "765164293111",
            appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
            measurementId: "G-4DT52P7MPB"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // Trade System Variables
        let currentUser = null;
        let userData = {
            coins: 0,
            inventory: {
                pets: [],
                knives: []
            }
        };
        let selectedPlayer = null;
        let selectedPlayerData = null;
        let onlinePlayers = [];
        let activeTrade = null;
        let yourTradeOffer = {
            coins: 0,
            items: []
        };
        let theirTradeOffer = {
            coins: 0,
            items: []
        };
        let tradeListener = null;

        // DOM Elements
        const elements = {
            // Auth
            signInButton: document.getElementById('signInButton'),
            signOutButton: document.getElementById('signOutButton'),
            usernameDisplay: document.getElementById('username-display'),
            profilePic: document.getElementById('profile-pic'),
            
            // Online Players
            onlinePlayers: document.getElementById('onlinePlayers'),
            
            // Trade Status
            tradeStatus: document.getElementById('tradeStatus'),
            theirName: document.getElementById('theirName'),
            
            // Trade Items
            yourTradeItems: document.getElementById('yourTradeItems'),
            theirTradeItems: document.getElementById('theirTradeItems'),
            
            // Inventory
            yourPetsInventory: document.getElementById('yourPetsInventory'),
            yourKnivesInventory: document.getElementById('yourKnivesInventory'),
            theirPetsInventory: document.getElementById('theirPetsInventory'),
            theirKnivesInventory: document.getElementById('theirKnivesInventory'),
            
            // Buttons
            addCoinsBtn: document.getElementById('addCoinsBtn'),
            sendTradeBtn: document.getElementById('sendTradeBtn'),
            acceptTradeBtn: document.getElementById('acceptTradeBtn'),
            rejectTradeBtn: document.getElementById('rejectTradeBtn'),
            cancelTradeBtn: document.getElementById('cancelTradeBtn'),
            
            // Trade History
            tradeHistory: document.getElementById('tradeHistory'),
            
            // Modals
            addCoinsModal: new bootstrap.Modal(document.getElementById('addCoinsModal')),
            coinsAmount: document.getElementById('coinsAmount'),
            maxCoins: document.getElementById('maxCoins'),
            confirmAddCoinsBtn: document.getElementById('confirmAddCoinsBtn'),
            tradeConfirmationModal: new bootstrap.Modal(document.getElementById('tradeConfirmationModal')),
            tradeConfirmationBody: document.getElementById('tradeConfirmationBody'),
            confirmTradeBtn: document.getElementById('confirmTradeBtn')
        };

        // Utility Functions
        function getItemById(type, id) {
            return userData.inventory[type].find(item => item.id === id);
        }

        function getRarityColor(rarity) {
            const colors = {
                common: 'secondary',
                rare: 'primary',
                epic: 'danger',
                legendary: 'warning'
            };
            return colors[rarity] || 'secondary';
        }

        function formatTradeDate(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            return date.toLocaleString();
        }

        // Trade Functions
        function resetTradeUI() {
            yourTradeOffer = { coins: 0, items: [] };
            theirTradeOffer = { coins: 0, items: [] };
            
            elements.yourTradeItems.innerHTML = '';
            elements.theirTradeItems.innerHTML = '';
            
            elements.sendTradeBtn.disabled = true;
            elements.acceptTradeBtn.classList.add('d-none');
            elements.rejectTradeBtn.classList.add('d-none');
            elements.cancelTradeBtn.classList.add('d-none');
            elements.tradeStatus.classList.add('d-none');
            
            updateYourInventoryUI();
            updateTheirInventoryUI();
        }

        function addToYourTrade(item, type) {
            // Check if already added
            const existingIndex = yourTradeOffer.items.findIndex(i => i.id === item.id && i.type === type);
            
            if (existingIndex >= 0) {
                // Increment quantity if possible
                const inventoryItem = getItemById(type, item.id);
                if (inventoryItem.quantity > yourTradeOffer.items[existingIndex].quantity) {
                    yourTradeOffer.items[existingIndex].quantity++;
                }
            } else {
                // Add new item with quantity 1
                yourTradeOffer.items.push({
                    id: item.id,
                    type: type,
                    quantity: 1,
                    ...item
                });
            }
            
            updateYourTradeItemsUI();
            updateYourInventoryUI();
            elements.sendTradeBtn.disabled = yourTradeOffer.coins === 0 && yourTradeOffer.items.length === 0;
        }

        function removeFromYourTrade(itemId, type) {
            const itemIndex = yourTradeOffer.items.findIndex(i => i.id === itemId && i.type === type);
            
            if (itemIndex >= 0) {
                if (yourTradeOffer.items[itemIndex].quantity > 1) {
                    yourTradeOffer.items[itemIndex].quantity--;
                } else {
                    yourTradeOffer.items.splice(itemIndex, 1);
                }
            }
            
            updateYourTradeItemsUI();
            updateYourInventoryUI();
            elements.sendTradeBtn.disabled = yourTradeOffer.coins === 0 && yourTradeOffer.items.length === 0;
        }

        function updateYourTradeItemsUI() {
            elements.yourTradeItems.innerHTML = '';
            
            // Add coins if any
            if (yourTradeOffer.coins > 0) {
                const coinItem = document.createElement('div');
                coinItem.className = 'trade-item selected';
                coinItem.innerHTML = `
                    <img src="https://via.placeholder.com/50?text=Coins" alt="Coins">
                    <span class="quantity">${yourTradeOffer.coins}</span>
                `;
                coinItem.addEventListener('click', () => {
                    yourTradeOffer.coins = 0;
                    updateYourTradeItemsUI();
                    elements.sendTradeBtn.disabled = yourTradeOffer.coins === 0 && yourTradeOffer.items.length === 0;
                });
                elements.yourTradeItems.appendChild(coinItem);
            }
            
            // Add items
            yourTradeOffer.items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'trade-item selected';
                itemElement.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <span class="quantity">${item.quantity}</span>
                `;
                itemElement.addEventListener('click', () => {
                    removeFromYourTrade(item.id, item.type);
                });
                elements.yourTradeItems.appendChild(itemElement);
            });
        }

        function updateTheirTradeItemsUI() {
            elements.theirTradeItems.innerHTML = '';
            
            // Add coins if any
            if (theirTradeOffer.coins > 0) {
                const coinItem = document.createElement('div');
                coinItem.className = 'trade-item';
                coinItem.innerHTML = `
                    <img src="https://via.placeholder.com/50?text=Coins" alt="Coins">
                    <span class="quantity">${theirTradeOffer.coins}</span>
                `;
                elements.theirTradeItems.appendChild(coinItem);
            }
            
            // Add items
            theirTradeOffer.items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'trade-item';
                itemElement.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <span class="quantity">${item.quantity}</span>
                `;
                elements.theirTradeItems.appendChild(itemElement);
            });
        }

        function updateYourInventoryUI() {
            // Pets
            elements.yourPetsInventory.innerHTML = userData.inventory.pets.map(pet => {
                const inTrade = yourTradeOffer.items.find(i => i.id === pet.id && i.type === 'pets');
                const available = inTrade ? pet.quantity - inTrade.quantity : pet.quantity;
                
                if (available <= 0) return '';
                
                return `
                    <div class="col-6 col-md-4 mb-3">
                        <div class="inventory-item" data-id="${pet.id}" data-type="pets">
                            <div class="card bg-secondary h-100">
                                <img src="${pet.image}" class="card-img-top" alt="${pet.name}">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-0">${pet.name}</h6>
                                    <small>Qty: ${available}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Knives
            elements.yourKnivesInventory.innerHTML = userData.inventory.knives.map(knife => {
                const inTrade = yourTradeOffer.items.find(i => i.id === knife.id && i.type === 'knives');
                const available = inTrade ? knife.quantity - inTrade.quantity : knife.quantity;
                
                if (available <= 0) return '';
                
                return `
                    <div class="col-6 col-md-4 mb-3">
                        <div class="inventory-item" data-id="${knife.id}" data-type="knives">
                            <div class="card bg-secondary h-100">
                                <img src="${knife.image}" class="card-img-top" alt="${knife.name}">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-0">${knife.name}</h6>
                                    <small>Qty: ${available}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            document.querySelectorAll('#yourPetsInventory .inventory-item, #yourKnivesInventory .inventory-item').forEach(item => {
                item.addEventListener('click', () => {
                    const id = item.dataset.id;
                    const type = item.dataset.type;
                    const itemData = getItemById(type, id);
                    addToYourTrade(itemData, type);
                });
            });
        }

        function updateTheirInventoryUI() {
            if (!selectedPlayerData) {
                elements.theirPetsInventory.innerHTML = '<div class="col-12 text-center py-3"><p>Select a player to view their inventory</p></div>';
                elements.theirKnivesInventory.innerHTML = '<div class="col-12 text-center py-3"><p>Select a player to view their inventory</p></div>';
                return;
            }
            
            // Pets
            elements.theirPetsInventory.innerHTML = selectedPlayerData.inventory.pets.map(pet => {
                const inTrade = theirTradeOffer.items.find(i => i.id === pet.id && i.type === 'pets');
                const available = inTrade ? pet.quantity - inTrade.quantity : pet.quantity;
                
                if (available <= 0) return '';
                
                return `
                    <div class="col-6 col-md-4 mb-3">
                        <div class="inventory-item" data-id="${pet.id}" data-type="pets">
                            <div class="card bg-secondary h-100">
                                <img src="${pet.image}" class="card-img-top" alt="${pet.name}">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-0">${pet.name}</h6>
                                    <small>Qty: ${available}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Knives
            elements.theirKnivesInventory.innerHTML = selectedPlayerData.inventory.knives.map(knife => {
                const inTrade = theirTradeOffer.items.find(i => i.id === knife.id && i.type === 'knives');
                const available = inTrade ? knife.quantity - inTrade.quantity : knife.quantity;
                
                if (available <= 0) return '';
                
                return `
                    <div class="col-6 col-md-4 mb-3">
                        <div class="inventory-item" data-id="${knife.id}" data-type="knives">
                            <div class="card bg-secondary h-100">
                                <img src="${knife.image}" class="card-img-top" alt="${knife.name}">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-0">${knife.name}</h6>
                                    <small>Qty: ${available}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers (only if we're receiving a trade)
            if (activeTrade && activeTrade.receiverId === currentUser.uid) {
                document.querySelectorAll('#theirPetsInventory .inventory-item, #theirKnivesInventory .inventory-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = item.dataset.id;
                        const type = item.dataset.type;
                        const itemData = selectedPlayerData.inventory[type].find(i => i.id === id);
                        
                        // Check if already added
                        const existingIndex = theirTradeOffer.items.findIndex(i => i.id === id && i.type === type);
                        
                        if (existingIndex >= 0) {
                            // Increment quantity if possible
                            const inventoryItem = selectedPlayerData.inventory[type].find(i => i.id === id);
                            if (inventoryItem.quantity > theirTradeOffer.items[existingIndex].quantity) {
                                theirTradeOffer.items[existingIndex].quantity++;
                            }
                        } else {
                            // Add new item with quantity 1
                            theirTradeOffer.items.push({
                                id: itemData.id,
                                type: type,
                                quantity: 1,
                                ...itemData
                            });
                        }
                        
                        updateTheirTradeItemsUI();
                        updateTheirInventoryUI();
                    });
                });
            }
        }

        function showAddCoinsModal() {
            elements.maxCoins.textContent = userData.coins - yourTradeOffer.coins;
            elements.coinsAmount.value = '';
            elements.coinsAmount.max = userData.coins - yourTradeOffer.coins;
            elements.addCoinsModal.show();
        }

        function sendTradeOffer() {
            if (!selectedPlayer || yourTradeOffer.coins === 0 && yourTradeOffer.items.length === 0) {
                alert('Please select items to trade and a player to trade with');
                return;
            }
            
            // Show confirmation
            let confirmationHTML = `
                <h6>You are offering:</h6>
                <ul class="mb-3">
            `;
            
            if (yourTradeOffer.coins > 0) {
                confirmationHTML += `<li>${yourTradeOffer.coins} coins</li>`;
            }
            
            yourTradeOffer.items.forEach(item => {
                confirmationHTML += `<li>${item.quantity} x ${item.name}</li>`;
            });
            
            confirmationHTML += `
                </ul>
                <h6>To: ${selectedPlayer.username}</h6>
                <p class="text-muted">They will need to accept this trade for it to complete.</p>
            `;
            
            elements.tradeConfirmationBody.innerHTML = confirmationHTML;
            elements.tradeConfirmationModal.show();
        }

        function confirmSendTrade() {
            elements.tradeConfirmationModal.hide();
            
            // Create trade document
            const tradeRef = db.collection('trades').doc();
            const tradeData = {
                id: tradeRef.id,
                senderId: currentUser.uid,
                senderName: userData.username,
                receiverId: selectedPlayer.uid,
                receiverName: selectedPlayer.username,
                senderOffer: yourTradeOffer,
                receiverOffer: { coins: 0, items: [] },
                status: 'pending', // pending, accepted, rejected, completed
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            tradeRef.set(tradeData)
                .then(() => {
                    // Listen for changes to this trade
                    setupTradeListener(tradeRef.id);
                    
                    // Update UI
                    elements.sendTradeBtn.classList.add('d-none');
                    elements.cancelTradeBtn.classList.remove('d-none');
                    elements.tradeStatus.textContent = 'Trade pending - waiting for response';
                    elements.tradeStatus.className = 'trade-status trade-pending';
                    elements.tradeStatus.classList.remove('d-none');
                })
                .catch(error => {
                    console.error('Error creating trade:', error);
                    alert('Failed to send trade offer. Please try again.');
                });
        }

        function acceptTrade() {
            if (!activeTrade) return;
            
            // Update trade status
            db.collection('trades').doc(activeTrade.id).update({
                status: 'accepted',
                receiverOffer: theirTradeOffer,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                elements.acceptTradeBtn.classList.add('d-none');
                elements.rejectTradeBtn.classList.add('d-none');
                elements.tradeStatus.textContent = 'Trade accepted - processing...';
                elements.tradeStatus.className = 'trade-status trade-accepted';
            })
            .catch(error => {
                console.error('Error accepting trade:', error);
                alert('Failed to accept trade. Please try again.');
            });
        }

        function rejectTrade() {
            if (!activeTrade) return;
            
            // Update trade status
            db.collection('trades').doc(activeTrade.id).update({
                status: 'rejected',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                elements.acceptTradeBtn.classList.add('d-none');
                elements.rejectTradeBtn.classList.add('d-none');
                elements.tradeStatus.textContent = 'Trade rejected';
                elements.tradeStatus.className = 'trade-status trade-rejected';
            })
            .catch(error => {
                console.error('Error rejecting trade:', error);
                alert('Failed to reject trade. Please try again.');
            });
        }

        function cancelTrade() {
            if (!activeTrade) return;
            
            // Update trade status
            db.collection('trades').doc(activeTrade.id).update({
                status: 'rejected',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                resetTradeUI();
            })
            .catch(error => {
                console.error('Error canceling trade:', error);
                alert('Failed to cancel trade. Please try again.');
            });
        }

        function processCompletedTrade(trade) {
            if (trade.status !== 'accepted') return;
            
            // Process the trade - this would need to be done securely on the server in a real app
            // For this demo, we'll simulate it client-side
            
            // Give items to receiver
            const receiverUpdates = {
                coins: firebase.firestore.FieldValue.increment(trade.senderOffer.coins - trade.receiverOffer.coins)
            };
            
            // Add sender's items to receiver's inventory
            trade.senderOffer.items.forEach(item => {
                receiverUpdates[`inventory.${item.type}`] = firebase.firestore.FieldValue.arrayUnion({
                    ...item,
                    quantity: item.quantity
                });
            });
            
            // Remove receiver's items from their inventory (if any were offered)
            trade.receiverOffer.items.forEach(item => {
                // This is simplified - in a real app you'd need to handle quantity properly
                receiverUpdates[`inventory.${item.type}`] = firebase.firestore.FieldValue.arrayRemove({
                    ...item,
                    quantity: item.quantity
                });
            });
            
            // Give items to sender
            const senderUpdates = {
                coins: firebase.firestore.FieldValue.increment(trade.receiverOffer.coins - trade.senderOffer.coins)
            };
            
            // Add receiver's items to sender's inventory
            trade.receiverOffer.items.forEach(item => {
                senderUpdates[`inventory.${item.type}`] = firebase.firestore.FieldValue.arrayUnion({
                    ...item,
                    quantity: item.quantity
                });
            });
            
            // Remove sender's items from their inventory
            trade.senderOffer.items.forEach(item => {
                // This is simplified - in a real app you'd need to handle quantity properly
                senderUpdates[`inventory.${item.type}`] = firebase.firestore.FieldValue.arrayRemove({
                    ...item,
                    quantity: item.quantity
                });
            });
            
            // Update both users' data
            const batch = db.batch();
            batch.update(db.collection('users').doc(trade.receiverId), receiverUpdates);
            batch.update(db.collection('users').doc(trade.senderId), senderUpdates);
            batch.update(db.collection('trades').doc(trade.id), { status: 'completed' });
            
            batch.commit()
                .then(() => {
                    // Reload user data to reflect changes
                    loadUserData(currentUser.uid);
                    
                    // Add to trade history
                    addTradeToHistory(trade);
                    
                    // Show success message
                    Swal.fire({
                        title: 'Trade Completed!',
                        text: 'The items have been exchanged successfully',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                })
                .catch(error => {
                    console.error('Error processing trade:', error);
                    // Mark trade as failed
                    db.collection('trades').doc(trade.id).update({
                        status: 'failed',
                        error: error.message
                    });
                });
        }

        function setupTradeListener(tradeId) {
            // Remove any existing listener
            if (tradeListener) tradeListener();
            
            tradeListener = db.collection('trades').doc(tradeId)
                .onSnapshot(doc => {
                    if (!doc.exists) return;
                    
                    const trade = doc.data();
                    activeTrade = trade;
                    
                    // Update UI based on trade status
                    if (trade.status === 'pending') {
                        if (trade.receiverId === currentUser.uid) {
                            // This user is the receiver
                            elements.sendTradeBtn.classList.add('d-none');
                            elements.acceptTradeBtn.classList.remove('d-none');
                            elements.rejectTradeBtn.classList.remove('d-none');
                            elements.cancelTradeBtn.classList.add('d-none');
                            
                            elements.tradeStatus.textContent = `${trade.senderName} wants to trade with you`;
                            elements.tradeStatus.className = 'trade-status trade-pending';
                            elements.tradeStatus.classList.remove('d-none');
                            
                            // Show sender's offer
                            yourTradeOffer = { coins: 0, items: [] };
                            theirTradeOffer = trade.senderOffer;
                            
                            updateYourTradeItemsUI();
                            updateTheirTradeItemsUI();
                            updateTheirInventoryUI();
                        } else {
                            // This user is the sender
                            elements.sendTradeBtn.classList.add('d-none');
                            elements.acceptTradeBtn.classList.add('d-none');
                            elements.rejectTradeBtn.classList.add('d-none');
                            elements.cancelTradeBtn.classList.remove('d-none');
                            
                            elements.tradeStatus.textContent = 'Trade pending - waiting for response';
                            elements.tradeStatus.className = 'trade-status trade-pending';
                            elements.tradeStatus.classList.remove('d-none');
                        }
                    } else if (trade.status === 'accepted') {
                        if (trade.receiverId === currentUser.uid) {
                            // Receiver accepted
                            elements.acceptTradeBtn.classList.add('d-none');
                            elements.rejectTradeBtn.classList.add('d-none');
                            elements.tradeStatus.textContent = 'Trade accepted - processing...';
                            elements.tradeStatus.className = 'trade-status trade-accepted';
                        } else {
                            // Sender sees that receiver accepted
                            elements.cancelTradeBtn.classList.add('d-none');
                            elements.tradeStatus.textContent = 'Trade accepted - processing...';
                            elements.tradeStatus.className = 'trade-status trade-accepted';
                        }
                        
                        // Process the trade
                        processCompletedTrade(trade);
                    } else if (trade.status === 'rejected') {
                        elements.sendTradeBtn.classList.add('d-none');
                        elements.acceptTradeBtn.classList.add('d-none');
                        elements.rejectTradeBtn.classList.add('d-none');
                        elements.cancelTradeBtn.classList.add('d-none');
                        
                        if (trade.receiverId === currentUser.uid) {
                            elements.tradeStatus.textContent = 'You rejected the trade';
                        } else {
                            elements.tradeStatus.textContent = `${trade.receiverName} rejected the trade`;
                        }
                        
                        elements.tradeStatus.className = 'trade-status trade-rejected';
                        
                        // Reset after delay
                        setTimeout(resetTradeUI, 3000);
                    } else if (trade.status === 'completed') {
                        elements.sendTradeBtn.classList.add('d-none');
                        elements.acceptTradeBtn.classList.add('d-none');
                        elements.rejectTradeBtn.classList.add('d-none');
                        elements.cancelTradeBtn.classList.add('d-none');
                        
                        elements.tradeStatus.textContent = 'Trade completed successfully!';
                        elements.tradeStatus.className = 'trade-status trade-accepted';
                        
                        // Reset after delay
                        setTimeout(resetTradeUI, 3000);
                    } else if (trade.status === 'failed') {
                        elements.sendTradeBtn.classList.add('d-none');
                        elements.acceptTradeBtn.classList.add('d-none');
                        elements.rejectTradeBtn.classList.add('d-none');
                        elements.cancelTradeBtn.classList.add('d-none');
                        
                        elements.tradeStatus.textContent = 'Trade failed - please try again';
                        elements.tradeStatus.className = 'trade-status trade-rejected';
                        
                        // Reset after delay
                        setTimeout(resetTradeUI, 3000);
                    }
                });
        }

        // Online Players Functions
        function updateOnlinePlayersList(players) {
            onlinePlayers = players.filter(player => player.uid !== currentUser.uid);
            
            if (onlinePlayers.length === 0) {
                elements.onlinePlayers.innerHTML = '<div class="text-center py-3"><p>No other players online</p></div>';
                return;
            }
            
            elements.onlinePlayers.innerHTML = onlinePlayers.map(player => `
                <div class="player-card card mb-2 ${selectedPlayer && selectedPlayer.uid === player.uid ? 'active' : ''}" data-uid="${player.uid}">
                    <div class="card-body d-flex align-items-center">
                        <img src="${player.photoBase64 || 'https://via.placeholder.com/40'}" class="rounded-circle me-3" width="40" height="40">
                        <div>
                            <h6 class="mb-0">${player.username}</h6>
                            <small class="text-muted">Coins: ${player.coins}</small>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Add click handlers
            document.querySelectorAll('.player-card').forEach(card => {
                card.addEventListener('click', () => {
                    const uid = card.dataset.uid;
                    const player = onlinePlayers.find(p => p.uid === uid);
                    selectPlayer(player);
                });
            });
        }

        function selectPlayer(player) {
            if (activeTrade) {
                alert('Please complete or cancel your current trade before starting a new one');
                return;
            }
            
            selectedPlayer = player;
            selectedPlayerData = null;
            
            // Highlight selected player
            document.querySelectorAll('.player-card').forEach(card => {
                if (card.dataset.uid === player.uid) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
            
            elements.theirName.textContent = player.username;
            
            // Load player's inventory data
            db.collection('users').doc(player.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        selectedPlayerData = doc.data();
                        updateTheirInventoryUI();
                    }
                })
                .catch(error => {
                    console.error('Error loading player data:', error);
                });
            
            // Reset trade UI
            resetTradeUI();
        }

        // Trade History Functions
        function loadTradeHistory() {
            db.collection('trades')
                .where('senderId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get()
                .then(querySnapshot => {
                    const sentTrades = querySnapshot.docs.map(doc => doc.data());
                    
                    db.collection('trades')
                        .where('receiverId', '==', currentUser.uid)
                        .orderBy('createdAt', 'desc')
                        .limit(10)
                        .get()
                        .then(querySnapshot => {
                            const receivedTrades = querySnapshot.docs.map(doc => doc.data());
                            const allTrades = [...sentTrades, ...receivedTrades]
                                .sort((a, b) => b.createdAt - a.createdAt)
                                .slice(0, 10);
                            
                            updateTradeHistoryUI(allTrades);
                        });
                })
                .catch(error => {
                    console.error('Error loading trade history:', error);
                });
        }

        function updateTradeHistoryUI(trades) {
            if (trades.length === 0) {
                elements.tradeHistory.innerHTML = '<div class="text-center py-3"><p>No trade history yet</p></div>';
                return;
            }
            
            elements.tradeHistory.innerHTML = trades.map(trade => {
                const isSender = trade.senderId === currentUser.uid;
                const otherPlayer = isSender ? trade.receiverName : trade.senderName;
                const date = formatTradeDate(trade.createdAt);
                const statusClass = trade.status === 'completed' ? 'text-success' : 
                                  trade.status === 'rejected' ? 'text-danger' : 'text-warning';
                
                return `
                    <div class="card mb-2 bg-dark border-secondary">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between">
                                <small>${date}</small>
                                <small class="${statusClass}">${trade.status}</small>
                            </div>
                            <p class="mb-1">${isSender ? 'You' : otherPlayer} offered ${trade.senderOffer.items.length} items</p>
                            <p class="mb-0">${isSender ? otherPlayer : 'You'} offered ${trade.receiverOffer.items.length} items</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addTradeToHistory(trade) {
            const tradeElement = document.createElement('div');
            tradeElement.className = 'card mb-2 bg-dark border-secondary';
            tradeElement.innerHTML = `
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between">
                        <small>${formatTradeDate(trade.createdAt)}</small>
                        <small class="text-success">completed</small>
                    </div>
                    <p class="mb-1">${trade.senderId === currentUser.uid ? 'You' : trade.senderName} offered ${trade.senderOffer.items.length} items</p>
                    <p class="mb-0">${trade.receiverId === currentUser.uid ? 'You' : trade.receiverName} offered ${trade.receiverOffer.items.length} items</p>
                </div>
            `;
            
            elements.tradeHistory.insertBefore(tradeElement, elements.tradeHistory.firstChild);
            
            // Limit to 10 items
            if (elements.tradeHistory.children.length > 10) {
                elements.tradeHistory.removeChild(elements.tradeHistory.lastChild);
            }
        }

        // Firebase Functions
        async function loadUserData(userId) {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    const data = doc.data();
                    userData = data;
                    
                    // Update UI
                    updateYourInventoryUI();
                    
                    // Start listening for online players
                    setupOnlinePlayersListener();
                    
                    // Load trade history
                    loadTradeHistory();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        function setupOnlinePlayersListener() {
            // Listen for online players
            db.collection('users')
                .where('lastActive', '>', firebase.firestore.Timestamp.fromDate(new Date(Date.now() - 5 * 60 * 1000))) // Active in last 5 minutes
                .onSnapshot(querySnapshot => {
                    const players = [];
                    querySnapshot.forEach(doc => {
                        players.push(doc.data());
                    });
                    updateOnlinePlayersList(players);
                });
            
            // Update user's last active timestamp periodically
            setInterval(() => {
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }, 2 * 60 * 1000); // Every 2 minutes
        }

        // Event Listeners
        function setupEventListeners() {
            // Auth
            elements.signInButton.addEventListener('click', signInWithGoogle);
            elements.signOutButton.addEventListener('click', () => {
                auth.signOut();
            });
            
            // Trade buttons
            elements.addCoinsBtn.addEventListener('click', showAddCoinsModal);
            elements.sendTradeBtn.addEventListener('click', sendTradeOffer);
            elements.acceptTradeBtn.addEventListener('click', acceptTrade);
            elements.rejectTradeBtn.addEventListener('click', rejectTrade);
            elements.cancelTradeBtn.addEventListener('click', cancelTrade);
            
            // Add coins modal
            elements.confirmAddCoinsBtn.addEventListener('click', () => {
                const amount = parseInt(elements.coinsAmount.value) || 0;
                const max = parseInt(elements.coinsAmount.max) || 0;
                
                if (amount <= 0 || amount > max) {
                    alert(`Please enter a valid amount between 1 and ${max}`);
                    return;
                }
                
                yourTradeOffer.coins = amount;
                updateYourTradeItemsUI();
                elements.sendTradeBtn.disabled = yourTradeOffer.coins === 0 && yourTradeOffer.items.length === 0;
                elements.addCoinsModal.hide();
            });
            
            // Confirm trade modal
            elements.confirmTradeBtn.addEventListener('click', confirmSendTrade);
        }
        
        function signInWithGoogle() {
            auth.signInWithPopup(provider)
                .catch((error) => {
                    console.error('Sign in error:', error);
                    alert('Sign in failed: ' + error.message);
                });
        }

        // Auth State Listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                elements.signOutButton.classList.remove('d-none');
                
                // Set profile info
                const displayName = user.displayName || 'User';
                elements.usernameDisplay.textContent = displayName;
                
                if (user.photoURL) {
                    elements.profilePic.src = user.photoURL;
                }
                
                // Load user data
                loadUserData(user.uid);
            } else {
                // User is signed out
                currentUser = null;
                elements.signOutButton.classList.add('d-none');
                elements.usernameDisplay.textContent = 'Guest';
                elements.profilePic.src = 'https://via.placeholder.com/40';
                elements.onlinePlayers.innerHTML = '<div class="text-center py-3"><p>Please sign in to trade</p></div>';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            resetTradeUI();
        });
    </script>
</body>
</html>
