<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FusionCYA - Trading</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Trading specific styles */
        .trade-container {
            background-color: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .trade-user {
            text-align: center;
            padding: 15px;
        }
        
        .trade-items {
            min-height: 200px;
            border: 2px dashed #444;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .trade-item {
            display: inline-block;
            margin: 5px;
            position: relative;
        }
        
        .trade-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #555;
        }
        
        .trade-item .remove-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #dc3545;
            color: white;
            border: none;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .trade-coins {
            margin-top: 10px;
        }
        
        .trade-controls {
            margin-top: 20px;
        }
        
        .trade-history-item {
            padding: 10px;
            border-bottom: 1px solid #444;
        }
        
        .trade-history-item:last-child {
            border-bottom: none;
        }
        
        /* Inventory item selection */
        .inventory-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .inventory-item:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
        
        .inventory-item.selected {
            border: 2px solid #0d6efd;
            box-shadow: 0 0 15px rgba(13, 110, 253, 0.5);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .trade-container {
                padding: 10px;
            }
            
            .trade-items {
                min-height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar (copied from your existing code) -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">FusionCYA</a>
            <div class="d-flex align-items-center">
                <span id="username-display" class="me-3">Guest</span>
                <img id="profile-pic" src="https://via.placeholder.com/40" class="rounded-circle me-2" width="40" height="40">
                <button id="signInButton" class="btn btn-primary me-2">Sign In</button>
                <button id="signOutButton" class="btn btn-danger d-none">Sign Out</button>
            </div>
        </div>
    </nav>

    <!-- Dashboard View -->
    <div id="dashboard-view" class="container d-none">
        <!-- Profile Section (copied from your existing code) -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <img id="profile-pic-preview" src="https://via.placeholder.com/150" class="rounded-circle mb-3" width="150" height="150">
                        <h4 id="dashboard-username">User</h4>
                        <div class="input-group mb-3">
                            <input type="text" id="new-username" class="form-control" placeholder="New username">
                            <button id="update-username-btn" class="btn btn-primary">Update</button>
                        </div>
                        <div class="d-flex justify-content-center">
                            <input type="file" id="profile-pic-upload" accept="image/*" class="d-none">
                            <button id="upload-profile-pic-btn" class="btn btn-secondary me-2">Choose Image</button>
                            <button id="update-profile-pic-btn" class="btn btn-primary">Update</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Stats</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-coins fa-2x text-warning me-3"></i>
                                    <div>
                                        <h5 class="mb-0">Coins</h5>
                                        <h3 id="coin-balance">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-fire fa-2x text-danger me-3"></i>
                                    <div>
                                        <h5 class="mb-0">Current Streak</h5>
                                        <h3 id="current-streak">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="streak-container">
                            <h5>Daily Streak Progress</h5>
                            <div class="progress mb-2">
                                <div id="streak-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                            </div>
                            <p>Next streak reward in <span id="next-streak-reward">7</span> days</p>
                            <button id="claim-daily-btn" class="btn btn-primary">Claim Daily Reward</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="lootbox-tab" data-bs-toggle="tab" data-bs-target="#lootbox" type="button" role="tab">Loot Boxes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="shop-tab" data-bs-toggle="tab" data-bs-target="#shop" type="button" role="tab">Shop</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">Inventory</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gamble-tab" data-bs-toggle="tab" data-bs-target="#gamble" type="button" role="tab">Gamble</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="blackjack-tab" data-bs-toggle="tab" data-bs-target="#blackjack" type="button" role="tab">Blackjack</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="trade-tab" data-bs-toggle="tab" data-bs-target="#trade" type="button" role="tab">Trade</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Trade Tab -->
            <div class="tab-pane fade show active" id="trade" role="tabpanel">
                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h4>Create Trade</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="trade-container">
                                            <div class="trade-user">
                                                <img id="trade-user1-avatar" src="https://via.placeholder.com/80" class="rounded-circle mb-2" width="80" height="80">
                                                <h5 id="trade-user1-name">You</h5>
                                            </div>
                                            <div class="trade-items" id="trade-user1-items">
                                                <!-- User's trade items will appear here -->
                                                <p class="text-muted text-center mt-5">Add items from your inventory</p>
                                            </div>
                                            <div class="trade-coins">
                                                <label class="form-label">Add Coins</label>
                                                <div class="input-group">
                                                    <input type="number" id="trade-user1-coins" class="form-control" min="0" max="100000" value="0">
                                                    <span class="input-group-text"><i class="fas fa-coins text-warning"></i></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="trade-container">
                                            <div class="trade-user">
                                                <img id="trade-user2-avatar" src="https://via.placeholder.com/80" class="rounded-circle mb-2" width="80" height="80">
                                                <div class="input-group mb-2">
                                                    <input type="text" id="trade-partner-search" class="form-control" placeholder="Search user...">
                                                    <button class="btn btn-primary" id="search-user-btn"><i class="fas fa-search"></i></button>
                                                </div>
                                                <h5 id="trade-user2-name">Select a user</h5>
                                            </div>
                                            <div class="trade-items" id="trade-user2-items">
                                                <!-- Partner's trade items will appear here -->
                                                <p class="text-muted text-center mt-5">Select a user to trade with</p>
                                            </div>
                                            <div class="trade-coins">
                                                <label class="form-label">Request Coins</label>
                                                <div class="input-group">
                                                    <input type="number" id="trade-user2-coins" class="form-control" min="0" max="100000" value="0">
                                                    <span class="input-group-text"><i class="fas fa-coins text-warning"></i></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="trade-controls text-center">
                                    <button id="send-trade-btn" class="btn btn-primary btn-lg me-2" disabled>
                                        <i class="fas fa-exchange-alt me-1"></i> Send Trade Offer
                                    </button>
                                    <button id="clear-trade-btn" class="btn btn-secondary btn-lg">
                                        <i class="fas fa-trash-alt me-1"></i> Clear Trade
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h4>Your Inventory</h4>
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs mb-3" id="inventoryTradeTab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="trade-pets-tab" data-bs-toggle="tab" data-bs-target="#trade-pets" type="button" role="tab">Pets</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="trade-knives-tab" data-bs-toggle="tab" data-bs-target="#trade-knives" type="button" role="tab">Knives</button>
                                    </li>
                                </ul>
                                <div class="tab-content" id="inventoryTradeTabContent">
                                    <div class="tab-pane fade show active" id="trade-pets" role="tabpanel">
                                        <div class="row" id="trade-pets-inventory">
                                            <!-- Pets inventory for trade selection -->
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="trade-knives" role="tabpanel">
                                        <div class="row" id="trade-knives-inventory">
                                            <!-- Knives inventory for trade selection -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4>Trade Offers</h4>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary active" id="incoming-trades-btn">Incoming</button>
                                    <button class="btn btn-sm btn-outline-secondary" id="outgoing-trades-btn">Outgoing</button>
                                    <button class="btn btn-sm btn-outline-secondary" id="trade-history-btn">History</button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group" id="trade-offers-list">
                                    <!-- Trade offers will appear here -->
                                    <div class="list-group-item text-center py-5">
                                        <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">No trade offers yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Other tabs (copied from your existing code but hidden by default) -->
            <div class="tab-pane fade" id="lootbox" role="tabpanel">
                <!-- Lootbox content -->
            </div>
            <div class="tab-pane fade" id="shop" role="tabpanel">
                <!-- Shop content -->
            </div>
            <div class="tab-pane fade" id="inventory" role="tabpanel">
                <!-- Inventory content -->
            </div>
            <div class="tab-pane fade" id="gamble" role="tabpanel">
                <!-- Gamble content -->
            </div>
            <div class="tab-pane fade" id="blackjack" role="tabpanel">
                <!-- Blackjack content -->
            </div>
        </div>
    </div>

    <!-- Trade Offer Modal -->
    <div class="modal fade" id="tradeOfferModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="tradeOfferModalTitle">Trade Offer</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="trade-user text-center mb-3">
                                <img id="trade-offer-user1-avatar" src="https://via.placeholder.com/80" class="rounded-circle mb-2" width="80" height="80">
                                <h5 id="trade-offer-user1-name">User 1</h5>
                            </div>
                            <div class="trade-items" id="trade-offer-user1-items">
                                <!-- User 1's items -->
                            </div>
                            <div class="trade-coins text-center mt-2">
                                <span id="trade-offer-user1-coins">0</span> <i class="fas fa-coins text-warning"></i>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="trade-user text-center mb-3">
                                <img id="trade-offer-user2-avatar" src="https://via.placeholder.com/80" class="rounded-circle mb-2" width="80" height="80">
                                <h5 id="trade-offer-user2-name">User 2</h5>
                            </div>
                            <div class="trade-items" id="trade-offer-user2-items">
                                <!-- User 2's items -->
                            </div>
                            <div class="trade-coins text-center mt-2">
                                <span id="trade-offer-user2-coins">0</span> <i class="fas fa-coins text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" id="trade-offer-modal-footer">
                    <!-- Buttons will be added dynamically based on trade status -->
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal (copied from your existing code) -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalTitle">Confirm Action</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationModalBody">
                    Are you sure you want to perform this action?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmActionBtn" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // Firebase Configuration (copied from your existing code)
        const firebaseConfig = {
            apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
            authDomain: "fusioncya-cc20a.firebaseapp.com",
            databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
            projectId: "fusioncya-cc20a",
            storageBucket: "fusioncya-cc20a.appspot.com",
            messagingSenderId: "765164293111",
            appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
            measurementId: "G-4DT52P7MPB"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // Trade state
        let tradeState = {
            user1Items: [],
            user2Items: [],
            user1Coins: 0,
            user2Coins: 0,
            partner: null,
            partnerInventory: null
        };

        // DOM Elements
        const elements = {
            // Existing elements from your code
            coinBalance: document.getElementById('coin-balance'),
            currentStreak: document.getElementById('current-streak'),
            streakProgress: document.getElementById('streak-progress'),
            nextStreakReward: document.getElementById('next-streak-reward'),
            claimDailyBtn: document.getElementById('claim-daily-btn'),
            usernameDisplay: document.getElementById('username-display'),
            profilePic: document.getElementById('profile-pic'),
            profilePicPreview: document.getElementById('profile-pic-preview'),
            dashboardUsername: document.getElementById('dashboard-username'),
            
            // Trade specific elements
            tradeUser1Items: document.getElementById('trade-user1-items'),
            tradeUser2Items: document.getElementById('trade-user2-items'),
            tradeUser1Coins: document.getElementById('trade-user1-coins'),
            tradeUser2Coins: document.getElementById('trade-user2-coins'),
            tradeUser1Avatar: document.getElementById('trade-user1-avatar'),
            tradeUser1Name: document.getElementById('trade-user1-name'),
            tradeUser2Avatar: document.getElementById('trade-user2-avatar'),
            tradeUser2Name: document.getElementById('trade-user2-name'),
            partnerSearch: document.getElementById('trade-partner-search'),
            searchUserBtn: document.getElementById('search-user-btn'),
            sendTradeBtn: document.getElementById('send-trade-btn'),
            clearTradeBtn: document.getElementById('clear-trade-btn'),
            tradePetsInventory: document.getElementById('trade-pets-inventory'),
            tradeKnivesInventory: document.getElementById('trade-knives-inventory'),
            tradeOffersList: document.getElementById('trade-offers-list'),
            incomingTradesBtn: document.getElementById('incoming-trades-btn'),
            outgoingTradesBtn: document.getElementById('outgoing-trades-btn'),
            tradeHistoryBtn: document.getElementById('trade-history-btn'),
            
            // Trade modal elements
            tradeOfferModal: new bootstrap.Modal(document.getElementById('tradeOfferModal')),
            tradeOfferModalTitle: document.getElementById('tradeOfferModalTitle'),
            tradeOfferUser1Avatar: document.getElementById('trade-offer-user1-avatar'),
            tradeOfferUser1Name: document.getElementById('trade-offer-user1-name'),
            tradeOfferUser1Items: document.getElementById('trade-offer-user1-items'),
            tradeOfferUser1Coins: document.getElementById('trade-offer-user1-coins'),
            tradeOfferUser2Avatar: document.getElementById('trade-offer-user2-avatar'),
            tradeOfferUser2Name: document.getElementById('trade-offer-user2-name'),
            tradeOfferUser2Items: document.getElementById('trade-offer-user2-items'),
            tradeOfferUser2Coins: document.getElementById('trade-offer-user2-coins'),
            tradeOfferModalFooter: document.getElementById('trade-offer-modal-footer'),
            
            // Confirmation modal (from your existing code)
            confirmationModal: new bootstrap.Modal(document.getElementById('confirmationModal')),
            confirmationModalTitle: document.getElementById('confirmationModalTitle'),
            confirmationModalBody: document.getElementById('confirmationModalBody'),
            confirmActionBtn: document.getElementById('confirmActionBtn')
        };

        // Utility Functions
        function getRarityColor(rarity) {
            const colors = {
                common: 'secondary',
                rare: 'primary',
                epic: 'danger',
                legendary: 'warning'
            };
            return colors[rarity] || 'secondary';
        }

        function showConfirmation(title, message, callback) {
            elements.confirmationModalTitle.textContent = title;
            elements.confirmationModalBody.textContent = message;
            elements.confirmActionBtn.onclick = () => {
                callback();
                elements.confirmationModal.hide();
            };
            elements.confirmationModal.show();
        }

        // Trade Functions
        function updateTradeUI() {
            // Update user 1 (current user) trade items
            elements.tradeUser1Items.innerHTML = '';
            if (tradeState.user1Items.length === 0) {
                elements.tradeUser1Items.innerHTML = '<p class="text-muted text-center mt-5">Add items from your inventory</p>';
            } else {
                tradeState.user1Items.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'trade-item';
                    itemElement.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" title="${item.name}">
                        <button class="remove-btn" data-index="${index}" data-user="1">&times;</button>
                    `;
                    elements.tradeUser1Items.appendChild(itemElement);
                });
            }
            
            // Update user 2 (partner) trade items
            elements.tradeUser2Items.innerHTML = '';
            if (tradeState.user2Items.length === 0) {
                elements.tradeUser2Items.innerHTML = '<p class="text-muted text-center mt-5">Select a user to trade with</p>';
            } else {
                tradeState.user2Items.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'trade-item';
                    itemElement.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" title="${item.name}">
                        <button class="remove-btn" data-index="${index}" data-user="2">&times;</button>
                    `;
                    elements.tradeUser2Items.appendChild(itemElement);
                });
            }
            
            // Update coins
            tradeState.user1Coins = parseInt(elements.tradeUser1Coins.value) || 0;
            tradeState.user2Coins = parseInt(elements.tradeUser2Coins.value) || 0;
            
            // Enable/disable send trade button
            elements.sendTradeBtn.disabled = !tradeState.partner || 
                (tradeState.user1Items.length === 0 && tradeState.user1Coins === 0) ||
                (tradeState.user2Items.length === 0 && tradeState.user2Coins === 0);
        }

        function updateTradeInventoryUI(inventory) {
            // Update pets inventory for trade
            elements.tradePetsInventory.innerHTML = '';
            if (inventory.pets.length === 0) {
                elements.tradePetsInventory.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No pets in your inventory</p>
                    </div>
                `;
            } else {
                // Group inventory items by ID and count quantities
                const groupedPets = groupInventoryItems(inventory.pets);
                
                elements.tradePetsInventory.innerHTML = groupedPets.map(pet => {
                    // Check if this pet is already in the trade
                    const inTrade = tradeState.user1Items.some(item => item.id === pet.item.id);
                    
                    return `
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 inventory-item ${inTrade ? 'selected' : ''}" data-id="${pet.item.id}" data-type="pets">
                                <img src="${pet.item.image}" class="card-img-top" alt="${pet.item.name}">
                                <div class="card-body">
                                    <h5 class="card-title">${pet.item.name}${pet.quantity > 1 ? ` (${pet.quantity})` : ''}</h5>
                                    <span class="badge bg-${getRarityColor(pet.item.rarity || 'common')} mb-2">
                                        ${(pet.item.rarity || 'common').charAt(0).toUpperCase() + (pet.item.rarity || 'common').slice(1)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Update knives inventory for trade
            elements.tradeKnivesInventory.innerHTML = '';
            if (inventory.knives.length === 0) {
                elements.tradeKnivesInventory.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No knives in your inventory</p>
                    </div>
                `;
            } else {
                // Group inventory items by ID and count quantities
                const groupedKnives = groupInventoryItems(inventory.knives);
                
                elements.tradeKnivesInventory.innerHTML = groupedKnives.map(knife => {
                    // Check if this knife is already in the trade
                    const inTrade = tradeState.user1Items.some(item => item.id === knife.item.id);
                    
                    return `
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 inventory-item ${inTrade ? 'selected' : ''}" data-id="${knife.item.id}" data-type="knives">
                                <img src="${knife.item.image}" class="card-img-top" alt="${knife.item.name}">
                                <div class="card-body">
                                    <h5 class="card-title">${knife.item.name}${knife.quantity > 1 ? ` (${knife.quantity})` : ''}</h5>
                                    <span class="badge bg-${getRarityColor(knife.item.rarity || 'common')} mb-2">
                                        ${(knife.item.rarity || 'common').charAt(0).toUpperCase() + (knife.item.rarity || 'common').slice(1)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Add event listeners to inventory items
            document.querySelectorAll('.inventory-item').forEach(item => {
                item.addEventListener('click', () => {
                    const itemId = item.dataset.id;
                    const itemType = item.dataset.type;
                    
                    // Find the item in the inventory
                    const inventoryItems = itemType === 'pets' ? inventory.pets : inventory.knives;
                    const foundItem = inventoryItems.find(i => i.id === itemId);
                    
                    if (foundItem) {
                        // Check if item is already in the trade
                        const itemIndex = tradeState.user1Items.findIndex(i => i.id === itemId);
                        
                        if (itemIndex >= 0) {
                            // Remove from trade
                            tradeState.user1Items.splice(itemIndex, 1);
                            item.classList.remove('selected');
                        } else {
                            // Add to trade
                            tradeState.user1Items.push(foundItem);
                            item.classList.add('selected');
                        }
                        
                        updateTradeUI();
                    }
                });
            });
        }

        function groupInventoryItems(items) {
            const grouped = {};
            
            items.forEach(item => {
                if (!grouped[item.id]) {
                    grouped[item.id] = {
                        item: item,
                        quantity: item.quantity || 1
                    };
                } else {
                    grouped[item.id].quantity += item.quantity || 1;
                }
            });
            
            return Object.values(grouped);
        }

        async function searchUser(username) {
            if (!username || username.length < 3) {
                alert('Please enter at least 3 characters to search');
                return;
            }
            
            try {
                // Search for users where username starts with the search term
                const snapshot = await db.collection('users')
                    .where('username', '>=', username)
                    .where('username', '<=', username + '\uf8ff')
                    .limit(5)
                    .get();
                
                if (snapshot.empty) {
                    alert('No users found with that username');
                    return;
                }
                
                // For simplicity, we'll just take the first match
                // In a real app, you might show a list of matches
                const userDoc = snapshot.docs[0];
                const userData = userDoc.data();
                
                // Don't allow trading with yourself
                if (userDoc.id === auth.currentUser.uid) {
                    alert('You cannot trade with yourself!');
                    return;
                }
                
                // Set the partner
                tradeState.partner = {
                    uid: userDoc.id,
                    username: userData.username,
                    avatar: userData.photoBase64 || 'https://via.placeholder.com/80'
                };
                
                // Update UI
                elements.tradeUser2Avatar.src = tradeState.partner.avatar;
                elements.tradeUser2Name.textContent = tradeState.partner.username;
                
                // Load partner's inventory
                tradeState.partnerInventory = {
                    pets: userData.inventory.pets || [],
                    knives: userData.inventory.knives || []
                };
                
                // Clear any existing items from the partner's side
                tradeState.user2Items = [];
                updateTradeUI();
                
                // Enable the partner's inventory tab
                // In a real app, you might show the partner's inventory for selection
                // For this example, we'll just allow the user to request items by name
                
            } catch (error) {
                console.error('Error searching for user:', error);
                alert('Error searching for user: ' + error.message);
            }
        }

        async function sendTradeOffer() {
            if (!tradeState.partner) {
                alert('Please select a user to trade with');
                return;
            }
            
            if (tradeState.user1Items.length === 0 && tradeState.user1Coins === 0) {
                alert('Please add items or coins to your side of the trade');
                return;
            }
            
            if (tradeState.user2Items.length === 0 && tradeState.user2Coins === 0) {
                alert('Please request items or coins from the other user');
                return;
            }
            
            // Verify the user has enough coins
            if (tradeState.user1Coins > userData.coins) {
                alert('You don\'t have enough coins for this trade');
                return;
            }
            
            // Create the trade offer
            const tradeOffer = {
                user1: auth.currentUser.uid,
                user1Items: tradeState.user1Items.map(item => ({ 
                    id: item.id,
                    type: item.type || (item.name.includes('Pet') ? 'pets' : 'knives'),
                    name: item.name,
                    image: item.image,
                    value: item.value
                })),
                user1Coins: tradeState.user1Coins,
                user2: tradeState.partner.uid,
                user2Items: tradeState.user2Items.map(item => ({ 
                    id: item.id,
                    type: item.type || (item.name.includes('Pet') ? 'pets' : 'knives'),
                    name: item.name,
                    image: item.image,
                    value: item.value
                })),
                user2Coins: tradeState.user2Coins,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                // Add the trade to the database
                await db.collection('trades').add(tradeOffer);
                
                // Clear the current trade
                clearTrade();
                
                // Show success message
                Swal.fire({
                    title: 'Trade Sent!',
                    text: 'Your trade offer has been sent to ' + tradeState.partner.username,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
                
                // Refresh trade offers list
                loadTradeOffers();
                
            } catch (error) {
                console.error('Error sending trade offer:', error);
                alert('Error sending trade offer: ' + error.message);
            }
        }

        function clearTrade() {
            tradeState = {
                user1Items: [],
                user2Items: [],
                user1Coins: 0,
                user2Coins: 0,
                partner: null,
                partnerInventory: null
            };
            
            elements.tradeUser1Coins.value = '0';
            elements.tradeUser2Coins.value = '0';
            elements.partnerSearch.value = '';
            
            updateTradeUI();
            updateTradeInventoryUI(userData.inventory);
        }

        async function loadTradeOffers(type = 'incoming') {
            elements.tradeOffersList.innerHTML = '<div class="list-group-item text-center py-5"><i class="fas fa-spinner fa-spin fa-3x text-muted mb-3"></i><p class="text-muted">Loading trades...</p></div>';
            
            try {
                let query;
                const userId = auth.currentUser.uid;
                
                if (type === 'incoming') {
                    query = db.collection('trades')
                        .where('user2', '==', userId)
                        .where('status', '==', 'pending')
                        .orderBy('createdAt', 'desc')
                        .limit(10);
                } else if (type === 'outgoing') {
                    query = db.collection('trades')
                        .where('user1', '==', userId)
                        .where('status', '==', 'pending')
                        .orderBy('createdAt', 'desc')
                        .limit(10);
                } else { // history
                    query = db.collection('trades')
                        .where('user1', '==', userId)
                        .where('status', 'in', ['completed', 'rejected', 'canceled'])
                        .orderBy('updatedAt', 'desc')
                        .limit(10);
                }
                
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    elements.tradeOffersList.innerHTML = '<div class="list-group-item text-center py-5"><i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i><p class="text-muted">No trades found</p></div>';
                    return;
                }
                
                // Get user data for all trade partners
                const userIds = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (type === 'incoming') {
                        userIds.push(data.user1);
                    } else {
                        userIds.push(data.user2);
                    }
                });
                
                const usersSnapshot = await db.collection('users').where('uid', 'in', userIds).get();
                const users = {};
                usersSnapshot.forEach(userDoc => {
                    users[userDoc.id] = userDoc.data();
                });
                
                // Build the trade offers list
                elements.tradeOffersList.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const trade = doc.data();
                    const partnerId = type === 'incoming' ? trade.user1 : trade.user2;
                    const partner = users[partnerId];
                    
                    if (!partner) return;
                    
                    const tradeItem = document.createElement('div');
                    tradeItem.className = 'list-group-item trade-history-item';
                    tradeItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <img src="${partner.photoBase64 || 'https://via.placeholder.com/40'}" 
                                     class="rounded-circle me-2" width="40" height="40">
                                <h6 class="mb-0">${partner.username}</h6>
                            </div>
                            <span class="badge bg-${type === 'incoming' ? 'primary' : 'secondary'}">
                                ${type === 'incoming' ? 'Incoming' : 'Outgoing'}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span>${trade.user1Items.length} items + ${trade.user1Coins} <i class="fas fa-coins text-warning"></i></span>
                            <span><i class="fas fa-exchange-alt mx-2"></i></span>
                            <span>${trade.user2Items.length} items + ${trade.user2Coins} <i class="fas fa-coins text-warning"></i></span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">${trade.createdAt.toDate().toLocaleString()}</small>
                            <button class="btn btn-sm btn-${type === 'incoming' ? 'primary' : 'secondary'} view-trade-btn" data-id="${doc.id}">
                                View
                            </button>
                        </div>
                    `;
                    
                    elements.tradeOffersList.appendChild(tradeItem);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-trade-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        viewTradeOffer(btn.dataset.id, type);
                    });
                });
                
            } catch (error) {
                console.error('Error loading trade offers:', error);
                elements.tradeOffersList.innerHTML = '<div class="list-group-item text-center py-5"><i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i><p class="text-danger">Error loading trades</p></div>';
            }
        }

        async function viewTradeOffer(tradeId, type) {
            try {
                const doc = await db.collection('trades').doc(tradeId).get();
                if (!doc.exists) {
                    alert('Trade not found');
                    return;
                }
                
                const trade = doc.data();
                
                // Get user data for both parties
                const [user1Snapshot, user2Snapshot] = await Promise.all([
                    db.collection('users').doc(trade.user1).get(),
                    db.collection('users').doc(trade.user2).get()
                ]);
                
                const user1 = user1Snapshot.data();
                const user2 = user2Snapshot.data();
                
                // Update modal with trade details
                elements.tradeOfferModalTitle.textContent = `Trade Offer ${type === 'incoming' ? 'From' : 'To'} ${type === 'incoming' ? user1.username : user2.username}`;
                
                elements.tradeOfferUser1Avatar.src = user1.photoBase64 || 'https://via.placeholder.com/80';
                elements.tradeOfferUser1Name.textContent = user1.username;
                
                elements.tradeOfferUser2Avatar.src = user2.photoBase64 || 'https://via.placeholder.com/80';
                elements.tradeOfferUser2Name.textContent = user2.username;
                
                // Clear existing items
                elements.tradeOfferUser1Items.innerHTML = '';
                elements.tradeOfferUser2Items.innerHTML = '';
                
                // Add user1 items
                trade.user1Items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'trade-item';
                    itemElement.innerHTML = `<img src="${item.image}" alt="${item.name}" title="${item.name}">`;
                    elements.tradeOfferUser1Items.appendChild(itemElement);
                });
                
                // Add user2 items
                trade.user2Items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'trade-item';
                    itemElement.innerHTML = `<img src="${item.image}" alt="${item.name}" title="${item.name}">`;
                    elements.tradeOfferUser2Items.appendChild(itemElement);
                });
                
                // Update coins
                elements.tradeOfferUser1Coins.textContent = trade.user1Coins;
                elements.tradeOfferUser2Coins.textContent = trade.user2Coins;
                
                // Update footer buttons based on trade status and type
                elements.tradeOfferModalFooter.innerHTML = '';
                
                if (type === 'incoming' && trade.status === 'pending') {
                    // Current user is user2 and can accept/reject
                    elements.tradeOfferModalFooter.innerHTML = `
                        <button class="btn btn-danger" id="reject-trade-btn" data-id="${tradeId}">
                            <i class="fas fa-times me-1"></i> Reject
                        </button>
                        <button class="btn btn-success" id="accept-trade-btn" data-id="${tradeId}">
                            <i class="fas fa-check me-1"></i> Accept
                        </button>
                    `;
                    
                    document.getElementById('reject-trade-btn').addEventListener('click', () => {
                        updateTradeStatus(tradeId, 'rejected');
                    });
                    
                    document.getElementById('accept-trade-btn').addEventListener('click', () => {
                        acceptTradeOffer(tradeId, trade);
                    });
                } else if (type === 'outgoing' && trade.status === 'pending') {
                    // Current user is user1 and can cancel
                    elements.tradeOfferModalFooter.innerHTML = `
                        <button class="btn btn-secondary" id="cancel-trade-btn" data-id="${tradeId}">
                            <i class="fas fa-trash-alt me-1"></i> Cancel
                        </button>
                    `;
                    
                    document.getElementById('cancel-trade-btn').addEventListener('click', () => {
                        updateTradeStatus(tradeId, 'canceled');
                    });
                } else {
                    // Completed or rejected trade - just show close button
                    elements.tradeOfferModalFooter.innerHTML = `
                        <button class="btn btn-secondary" data-bs-dismiss="modal">
                            Close
                        </button>
                    `;
                }
                
                // Show the modal
                elements.tradeOfferModal.show();
                
            } catch (error) {
                console.error('Error viewing trade offer:', error);
                alert('Error viewing trade offer: ' + error.message);
            }
        }

        async function acceptTradeOffer(tradeId, trade) {
            // Verify both users still have the items and coins
            try {
                const [user1Snapshot, user2Snapshot] = await Promise.all([
                    db.collection('users').doc(trade.user1).get(),
                    db.collection('users').doc(trade.user2).get()
                ]);
                
                const user1 = user1Snapshot.data();
                const user2 = user2Snapshot.data();
                
                // Check user1 has enough coins
                if (user1.coins < trade.user1Coins) {
                    alert(`${user1.username} doesn't have enough coins for this trade`);
                    await updateTradeStatus(tradeId, 'rejected');
                    return;
                }
                
                // Check user2 has enough coins
                if (user2.coins < trade.user2Coins) {
                    alert(`You don't have enough coins for this trade`);
                    await updateTradeStatus(tradeId, 'rejected');
                    return;
                }
                
                // Check user1 has all the items
                for (const item of trade.user1Items) {
                    const itemExists = user1.inventory[item.type].some(i => i.id === item.id);
                    if (!itemExists) {
                        alert(`${user1.username} no longer has ${item.name}`);
                        await updateTradeStatus(tradeId, 'rejected');
                        return;
                    }
                }
                
                // Check user2 has all the items
                for (const item of trade.user2Items) {
                    const itemExists = user2.inventory[item.type].some(i => i.id === item.id);
                    if (!itemExists) {
                        alert(`You no longer have ${item.name}`);
                        await updateTradeStatus(tradeId, 'rejected');
                        return;
                    }
                }
                
                // All checks passed - process the trade
                const batch = db.batch();
                
                // Remove items from user1 and add to user2
                for (const item of trade.user1Items) {
                    // Remove from user1
                    const user1Items = user1.inventory[item.type].filter(i => i.id !== item.id);
                    batch.update(db.collection('users').doc(trade.user1), {
                        [`inventory.${item.type}`]: user1Items
                    });
                    
                    // Add to user2
                    batch.update(db.collection('users').doc(trade.user2), {
                        [`inventory.${item.type}`]: firebase.firestore.FieldValue.arrayUnion(item)
                    });
                }
                
                // Remove items from user2 and add to user1
                for (const item of trade.user2Items) {
                    // Remove from user2
                    const user2Items = user2.inventory[item.type].filter(i => i.id !== item.id);
                    batch.update(db.collection('users').doc(trade.user2), {
                        [`inventory.${item.type}`]: user2Items
                    });
                    
                    // Add to user1
                    batch.update(db.collection('users').doc(trade.user1), {
                        [`inventory.${item.type}`]: firebase.firestore.FieldValue.arrayUnion(item)
                    });
                }
                
                // Update coins
                batch.update(db.collection('users').doc(trade.user1), {
                    coins: user1.coins - trade.user1Coins + trade.user2Coins
                });
                
                batch.update(db.collection('users').doc(trade.user2), {
                    coins: user2.coins - trade.user2Coins + trade.user1Coins
                });
                
                // Update trade status
                batch.update(db.collection('trades').doc(tradeId), {
                    status: 'completed',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Commit the batch
                await batch.commit();
                
                // Close the modal
                elements.tradeOfferModal.hide();
                
                // Show success message
                Swal.fire({
                    title: 'Trade Completed!',
                    text: 'The trade has been successfully processed',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
                
                // Refresh trade offers list and user data
                loadTradeOffers();
                loadUserData(auth.currentUser.uid);
                
            } catch (error) {
                console.error('Error accepting trade offer:', error);
                alert('Error accepting trade offer: ' + error.message);
            }
        }

        async function updateTradeStatus(tradeId, status) {
            try {
                await db.collection('trades').doc(tradeId).update({
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Close the modal
                elements.tradeOfferModal.hide();
                
                // Show message
                let message = '';
                if (status === 'rejected') {
                    message = 'Trade has been rejected';
                } else if (status === 'canceled') {
                    message = 'Trade has been canceled';
                }
                
                if (message) {
                    Swal.fire({
                        title: message,
                        icon: 'info',
                        confirmButtonText: 'OK'
                    });
                }
                
                // Refresh trade offers list
                loadTradeOffers();
                
            } catch (error) {
                console.error('Error updating trade status:', error);
                alert('Error updating trade status: ' + error.message);
            }
        }

        // Event Listeners
        function setupTradeEventListeners() {
            // Coin inputs
            elements.tradeUser1Coins.addEventListener('change', updateTradeUI);
            elements.tradeUser2Coins.addEventListener('change', updateTradeUI);
            
            // Search user button
            elements.searchUserBtn.addEventListener('click', () => {
                searchUser(elements.partnerSearch.value.trim());
            });
            
            // Remove item buttons (delegated since they're dynamic)
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    const user = e.target.dataset.user;
                    
                    if (user === '1') {
                        tradeState.user1Items.splice(index, 1);
                    } else {
                        tradeState.user2Items.splice(index, 1);
                    }
                    
                    updateTradeUI();
                    updateTradeInventoryUI(userData.inventory);
                }
            });
            
            // Send trade button
            elements.sendTradeBtn.addEventListener('click', () => {
                showConfirmation(
                    'Confirm Trade Offer',
                    'Are you sure you want to send this trade offer?',
                    sendTradeOffer
                );
            });
            
            // Clear trade button
            elements.clearTradeBtn.addEventListener('click', clearTrade);
            
            // Trade offers tabs
            elements.incomingTradesBtn.addEventListener('click', () => {
                elements.incomingTradesBtn.classList.add('active');
                elements.outgoingTradesBtn.classList.remove('active');
                elements.tradeHistoryBtn.classList.remove('active');
                loadTradeOffers('incoming');
            });
            
            elements.outgoingTradesBtn.addEventListener('click', () => {
                elements.incomingTradesBtn.classList.remove('active');
                elements.outgoingTradesBtn.classList.add('active');
                elements.tradeHistoryBtn.classList.remove('active');
                loadTradeOffers('outgoing');
            });
            
            elements.tradeHistoryBtn.addEventListener('click', () => {
                elements.incomingTradesBtn.classList.remove('active');
                elements.outgoingTradesBtn.classList.remove('active');
                elements.tradeHistoryBtn.classList.add('active');
                loadTradeOffers('history');
            });
        }

        // Auth State Listener (copied from your existing code with trade additions)
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                elements.loginView.style.display = 'none';
                elements.dashboardView.classList.remove('d-none');
                elements.signOutButton.classList.remove('d-none');
                
                // Set profile info
                const displayName = user.displayName || 'User';
                elements.usernameDisplay.textContent = displayName;
                elements.dashboardUsername.textContent = displayName;
                elements.tradeUser1Name.textContent = displayName;
                
                if (user.photoURL) {
                    elements.profilePic.src = user.photoURL;
                    elements.profilePicPreview.src = user.photoURL;
                    elements.tradeUser1Avatar.src = user.photoURL;
                }
                
                // Load user data
                loadUserData(user.uid);
                
                // Load trade offers
                loadTradeOffers();
                
            } else {
                // User is signed out
                elements.loginView.style.display = 'block';
                elements.dashboardView.classList.add('d-none');
                elements.signOutButton.classList.add('d-none');
                elements.usernameDisplay.textContent = 'Guest';
                elements.profilePic.src = 'https://via.placeholder.com/40';
                elements.profilePicPreview.src = 'https://via.placeholder.com/150';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupTradeEventListeners();
            
            // Set default tab to incoming trades
            elements.incomingTradesBtn.classList.add('active');
        });
    </script>
</body>
</html>
